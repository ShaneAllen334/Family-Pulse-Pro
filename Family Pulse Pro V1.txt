/**
 * Family Pulse Pro
 */

import groovy.json.JsonOutput
import groovy.json.JsonSlurper
import java.util.Random

definition(
    name: "Family Pulse Pro",
    namespace: "hubitat",
    author: "ShaneAllen",
    description: "The complete private social feed with advanced Adventure modes, Animations, Sounds, and Slayer Badges. (Modified with Password, Calendar & Popups)",
    category: "Convenience",
    iconUrl: "",
    iconX2Url: "",
    oauth: true,
    singleThreaded: true
    
)

preferences {
    page(name: "mainPage")
}

mappings {
    // ========================================================
    // CORE SYSTEM & AUTH
    // ========================================================
    path("/feed")               { action: [GET: "renderFeedShell"] }
    path("/portal")             { action: [GET: "renderLoginScreen"] }
    path("/api/data")           { action: [GET: "handleGetData"] }
    path("/cmd/chore/finish")   { action: [GET: "handleChoreFinish"] }


    // ========================================================
    // SOCIAL FEED & INTERACTIONS
    // ========================================================
    path("/cmd/post")           { action: [GET: "handlePost"] }
    path("/cmd/reply")          { action: [GET: "handleReply"] }
    path("/cmd/react")          { action: [GET: "handleReact"] }
    path("/cmd/reactReply")     { action: [GET: "handleReplyReact"] }
    path("/cmd/deletePost")     { action: [GET: "handleDeletePost"] }
    path("/cmd/deleteReply")    { action: [GET: "handleDeleteReply"] }
    path("/cmd/updateMood")     { action: [GET: "handleMoodUpdate"] }
    path("/cmd/clearBulletin")  { action: [GET: "handleClearBulletin"] }
    path("/cmd/poll/vote")      { action: [GET: "handlePollVote"] }
    path("/cmd/poll/close")     { action: [GET: "handlePollCloseCmd"] }

    // ========================================================
    // CHICKEN MANAGEMENT
    // ========================================================
    path("/cmd/avatar")         { action: [GET: "handleAvatarUpdate"] }
    path("/cmd/chicken/rename") { action: [GET: "handleChickenRename"] }
    path("/cmd/chicken/train")  { action: [GET: "handleChickenTrain"] }
    path("/cmd/chicken/farm")   { action: [GET: "handleChickenFarm"] }
    path("/cmd/chicken/battle") { action: [GET: "handleChickenBattle"] }
    
    // ========================================================
    // SHOP & ITEMS
    // ========================================================
    path("/cmd/shop/visit")     { action: [GET: "handleShopVisit"] }
    path("/cmd/shop/buy")       { action: [GET: "handleBuyItem"] }

    // ========================================================
    // ADVENTURE & EVENTS
    // ========================================================
    path("/cmd/adventure/explore") { action: [GET: "handleAdventureExplore"] }
    path("/cmd/foraging/explore")  { action: [GET: "handleForagingExplore"] }
    path("/cmd/sportEvent")        { action: [GET: "handleSportEvent"] }
    path("/cmd/farmer/eat")        { action: [GET: "handleFarmerEat"] }
    
    // ========================================================
    // HEALTH & CHURCH
    // ========================================================
    path("/cmd/hospital/visit") { action: [GET: "handleHospitalVisit"] }
    path("/cmd/hospital/heal")  { action: [GET: "handleHealChicken"] }
    path("/cmd/church/visit")   { action: [GET: "handleChurchVisit"] }
    path("/cmd/church/tithe")   { action: [GET: "handleTithe"] }      
    path("/cmd/reward") { action: [GET: "handleRemoteReward"] }

    // ========================================================
    // DAILYS & UTILITIES
    // ========================================================
    path("/cmd/habit/reset")    { action: [GET: "handleHabitReset"] }
    path("/cmd/habit/complete") { action: [GET: "handleHabitComplete"] }
    path("/cmd/clearReward")    { action: [GET: "handleClearReward"] }
    
    // ========================================================
    // ADMIN & SYSTEM MAINTENANCE
    // ========================================================
    path("/cmd/resetCooldowns")   { action: [GET: "handleResetCooldowns"] }
    path("/cmd/admin/masterWipe") { action: [GET: "handleMasterWipe"] }
    path("/cmd/admin/wipeUser")   { action: [GET: "handleWipeSingleUser"] }
    path("/cmd/admin/resetScripture") { action: [GET: "handleResetScripture"] }
}
def installed() { initialize() }
def updated() { unsubscribe(); initialize() }

def initialize() {
    if (!atomicState.lastUpdateTs) touchActivity()
    if (!atomicState.postIDs) atomicState.postIDs = []
    
    for(int i=1; i<=8; i++) {
        if(settings["userEnabled_${i}"] && !atomicState["avatar_${i}"]) {
            atomicState["avatar_${i}"] = settings["userAvatar_${i}"] ?: "üòÄ"
        }
    }

    schedule("0 0 0 ? * MON", resetWeeklyStats)
    schedule("0 0 0 * * ?", dailyReset) 
  
    def qTime = settings.dailyQuestionTime ?: 9
    schedule("0 0 ${qTime} * * ?", scheduledDailyQuestion)
    schedule("0 30 ${qTime} * * ?", scheduledFarmerCheck)
    schedule("0 0 12 ? * SAT", scheduledDogCheck)
    schedule("0 0 * * * ?", cleanOldPosts) 
    schedule("0 45 10 * * ?", scheduledWifeCheck)
    schedule("0 0 * * * ?", checkSpecialEvents)
    
    schedule("0 0 * * * ?", checkSpecialEvents)
}

def touchActivity() { atomicState.lastUpdateTs = new Date().time }

def handleGetData() {
    try {
        def activeUser = params.uid ? params.uid.toInteger() : 0
        def nowObj = new Date()
        def nowTime = nowObj.time
        
        if (settings["userTimeOut_${activeUser}"]) {
             render contentType: "application/json", data: JsonOutput.toJson([status: "error", msg: "Timeout"])
             return
        }

        def lastSeen = atomicState["lastSeen_${activeUser}"] ?: 0
        if(activeUser > 0) {
            if (nowTime - lastSeen > 60000) { atomicState["lastSeen_${activeUser}"] = nowTime }
            checkDaily(activeUser, "login") 
        }
        
        if(atomicState["isWounded_${activeUser}"]) {
             def wTime = atomicState["woundedTime_${activeUser}"] ?: 0
             if(nowTime - wTime > 21600000) { 
                 atomicState["isWounded_${activeUser}"] = false
                 atomicState.remove("woundedTime_${activeUser}")
                 atomicState["advLossCount_${activeUser}"] = 0
                 def c = getChickenData(activeUser)
                 c.currentHp = c.stats.hp 
                 atomicState["chicken_${activeUser}"] = c
                 addNotification(activeUser, "üè• You have revived from unconsciousness!")
            }
         }
       
        def notifs = atomicState["notifs_${activeUser}"] ?: []
   
        if(activeUser > 0) {
            def c = getChickenData(activeUser)
            if(c.level < 10 && c.xp >= c.xpToNext) {
                 while(c.level < 10 && c.xp >= c.xpToNext) { 
                    c.level++
                    c.xp = Math.max(0, c.xp - c.xpToNext)
                    c.xpToNext = (c.xpToNext * 2.0).toInteger()
                    c.pts += 3
                    c.stats.hp += 10;
                    c.currentHp += 10; c.stats.atk += 1;
                    c.stats.def += 1;
                }
                if(c.level >= 10) { c.xp = 0; c.xpToNext = 0; }
                atomicState["chicken_${activeUser}"] = c
                addPostToFeed(0, "system", "üéâ <b>${getUserName(activeUser)}</b>'s chicken <b>${c.name}</b> reached Lvl ${c.level}!", "happy")
                notifs << "üéâ Level Up! You reached Level ${c.level}!"
            }
        }
        
        def tz = location.timeZone ?: TimeZone.getDefault()
        def sdf = new java.text.SimpleDateFormat("M-d")
        sdf.setTimeZone(tz)
        def todayStr = sdf.format(new Date()) 
        def todayParts = todayStr.split("-")
        def tMonth = todayParts[0].toInteger()
        def tDay = todayParts[1].toInteger()
        
        def globalHoliday = ""
        if (tMonth == 10 && tDay == 31) globalHoliday = "halloween"
        else if (tMonth == 12 && tDay == 25) globalHoliday = "christmas"
        else if (tMonth == 11) {
            def cal = Calendar.getInstance(tz)
            cal.setTime(new Date())
            def dow = cal.get(Calendar.DAY_OF_WEEK)
            if (dow == Calendar.THURSDAY && tDay >= 22 && tDay <= 28) globalHoliday = "thanksgiving"
        }
        

        def birthdayUsers = [] 
        
        for(int i=1; i<=8; i++) {
             if (settings["userEnabled_${i}"]) {
                 def bdayS = settings["userBirthday_${i}"]
                 if(bdayS) {
                     def parts = bdayS.split("-")
                     if (parts.length == 2 && parts[0].toInteger() == tMonth && parts[1].toInteger() == tDay) {
                         birthdayUsers.add(i) 
                     }
                 }
             }
        }
        
        if(activeUser > 0) {
            if(globalHoliday != "") {
               def bKey = "holidayBonus_${year}_${globalHoliday}_${activeUser}"
               if(!atomicState[bKey]) {
                    addChickenXp(activeUser, 20)
                    adjustCoins(activeUser, 10)
                    notifs << "üéâ Holiday Bonus! +20 XP +10 Coins"
                    atomicState[bKey] = true
                }
            }
            
            if (birthdayUsers.contains(activeUser)) {
                def year = Calendar.getInstance(tz).get(Calendar.YEAR)
                def bKey = "bdayGift_${year}_${activeUser}"
                if(!atomicState[bKey]) {
                    addChickenXp(activeUser, 200)
                    adjustCoins(activeUser, 200)
                    atomicState[bKey] = true
                    def uName = getUserName(activeUser)
                    addPostToFeed(0, "system", "üéÇ <b>HAPPY BIRTHDAY ${uName}!</b><br>You received a Birthday Gift: <b>+200 XP</b> and <b>+200 Coins</b>! üéÅ", "excited")
                    notifs << "üéÅ Happy Birthday! You got 200 XP & 200 Coins!"
                }
            }
        }

        def ids = atomicState.postIDs ?: []
        def posts = []
        def limit = 30
        def count = 0
        def newPostCount = 0
        
        for(int i = ids.size() - 1; i >= 0; i--) {
            if(count >= limit) break
            def p = atomicState["p_${ids[i]}"]
            if(p) { 
                if (p.type == 'event_farmer' && (nowTime - p.ts > 21600000)) { continue }
                posts << p
                if (p.ts > lastSeen) newPostCount++
                count++ 
           }
        }
      
        def users = getUsersList() 
        def leaderId = getWeeklyLeader()
   
        def gotDailyBonus = false
        if(params.init == 'true' && activeUser > 0) {
            def sdfDate = new java.text.SimpleDateFormat("yyyy-MM-dd")
            sdfDate.setTimeZone(tz)
            def today = sdfDate.format(new Date())
            
            def lastDate = atomicState["loginDate_${activeUser}"]
            def bonusCount = atomicState["loginCount_${activeUser}"] ?: 0
            if(lastDate != today) {
                bonusCount = 0
                atomicState["loginDate_${activeUser}"] = today
            }
            if(bonusCount < 2) {
                if(Math.random() < 0.25) {
                    adjustCoins(activeUser, 5)
                    gotDailyBonus = true
                    bonusCount++
                    atomicState["loginCount_${activeUser}"] = bonusCount
                }
            }
        }
        
        def welcomeSummary = [ newPosts: newPostCount, gotBonus: gotDailyBonus, notifs: notifs ]
        if(notifs) atomicState["notifs_${activeUser}"] = [] 
        
        def cooldownMap = [:]
        def activeBattlesCount = 0
        def totalOpponents = Math.max(0, users.size() - 1)
        
        users.each { u ->
            def key = "cooldown_${activeUser}_${u.id}".toString()
            def expiry = atomicState[key]
            if (expiry && expiry > nowTime) {
               cooldownMap[u.id] = expiry
                if(u.id != activeUser) activeBattlesCount++
            }
        }
        
        def farmExpiry = atomicState["farmCooldown_${activeUser}"]
        def farmAvailable = !farmExpiry || farmExpiry < nowTime
        def farmWait = farmAvailable ? 0 : (farmExpiry - nowTime)
        
        def isTired = (totalOpponents > 0 && activeBattlesCount >= (totalOpponents / 2.0))
        def isWounded = atomicState["isWounded_${activeUser}"] ?: false
        def woundedTime = atomicState["woundedTime_${activeUser}"] ?: 0
        def advLosses = atomicState["advLossCount_${activeUser}"] ?: 0
         
        def myChicken = getChickenData(activeUser)
        def userMoods = [:]
        users.each { u -> userMoods[u.id] = atomicState["mood_${u.id}"] }
        def lbChicken = users.collect { u -> 
            def c = getChickenData(u.id);
            [user: u.name, avatar: u.avatar, chicken: c.name, level: c.level, wins: c.wins, loss: c.loss, icon: c.icon] 
        }.sort { a, b -> b.level <=> a.level ?: b.wins <=> a.wins }
        
        def lbAdventure = users.collect { u -> 
            def c = getChickenData(u.id);
            def aWins = c.advWins ?: 0
            def aLoss = c.advLoss ?: 0
            [user: u.name, avatar: u.avatar, chicken: c.name, wins: aWins, loss: aLoss]
        }.sort { a, b -> b.wins <=> a.wins }

        def lbCoins = users.collect { u -> 
            def c = getChickenData(u.id);
            [user: u.name, avatar: u.avatar, coins: c.coins] 
        }.sort { a, b -> b.coins <=> a.coins }

        def lbPulse = users.collect { u -> 
            def myPosts = posts.findAll { it.uid == u.id }
            def likes = 0;
            def replies = 0
            myPosts.each { p -> 
                likes += (p.reactions ? p.reactions.size() : 0)
                replies += (p.replies ? p.replies.size() : 0)
            }
            [user: u.name, avatar: u.avatar, count: atomicState["weeklyCount_${u.id}"] ?: 0, likes: likes, replies: replies] 
        }.sort { a, b -> b.count <=> a.count }

        def myDailys = atomicState["dailys_${activeUser}"] ?: [post:false, reply:false, like:false, battle:false, shop:false, login:false, hospital:false, adventure:false, collected:false]
        
        def pendingFarm = atomicState["farmResult_${activeUser}"]
        def isAdmin = (activeUser == (settings.adminUserId ?: 1) || activeUser == (settings.adminUserId2 ? settings.adminUserId2.toInteger() : -1))
        
        def maxE = 6
        if(myChicken.level >= 5) maxE = 8
        if(myChicken.level >= 10) maxE = 10
        
        def advTokens = atomicState["advTokens_${activeUser}"]
        if (advTokens == null) { advTokens = maxE; atomicState["advTokens_${activeUser}"] = maxE }
        
        def advReset = atomicState["advReset_${activeUser}"] ?: 0
        if (nowTime > advReset) {
            advTokens = maxE
            atomicState["advTokens_${activeUser}"] = maxE
            atomicState["advReset_${activeUser}"] = nowTime + 21600000 // 6 hours
        }
        
        def advProgress = atomicState["advProgress_${activeUser}"] ?: [
            wilds:0, spooky:0, crazy:0, 
            boss1:false, boss2:false, boss3:false, bossFarmer:false,
            boss1Att:false, boss2Att:false, boss3Att:false, bossFarmerAtt:0
        ]
        
        if (advProgress.bossFarmerAtt instanceof Boolean) {
             advProgress.bossFarmerAtt = advProgress.bossFarmerAtt ? 1 : 0
             atomicState["advProgress_${activeUser}"] = advProgress
        }
        
        def pollData = null
        if(settings.pollEnabled) {
            def pState = atomicState.pollData ?: [open:true, votes:[:]]
            def counts = [1:0, 2:0, 3:0, 4:0]
            def totalVotes = 0
            pState.votes.each { u, v -> 
                if(counts[v] == null) counts[v] = 0
                counts[v] += 1
                totalVotes++
             }
    
            def options = []
            [1,2,3,4].each { i ->
                if(settings["pollAns${i}"]) options << [id:i, text:settings["pollAns${i}"], count:counts[i]]
            }
            pollData = [
                question: settings.pollQuestion,
                options: options,
                open: pState.open,
                myVote: pState.votes[activeUser.toString()] ?: 0,
                total: totalVotes
            ]
        }
        
        def midnight = new Date(nowTime).clearTime().plus(1).time
        def dailyResetWait = midnight - nowTime
        def shopStatus = getShopStatus()

        def data = [
            ts: atomicState.lastUpdateTs ?: 0,
            serverTime: nowTime,
            churchQuote: atomicState.dailyScripture ?: "Loading Scripture...",
            shopOpen: shopStatus.open,
            isDay: shopStatus.isDay,
            holiday: globalHoliday,
            birthdays: birthdayUsers,
            posts: posts,
            bulletin: atomicState.bulletin,
            users: users,
            me: [
                chicken: myChicken, cooldowns: cooldownMap, 
                farmAvailable: farmAvailable, farmWait: farmWait, isTired: isTired, 
                isWounded: isWounded, woundedTime: woundedTime, losses: advLosses,
                dailys: myDailys, pendingFarm: pendingFarm, dashboardUrl: dashUrl,
                welcome: welcomeSummary, 
                isAdmin: isAdmin,
                advTokens: advTokens, advReset: advReset, advProgress: advProgress,
                dailyResetWait: dailyResetWait,
                pendingReward: atomicState["pendingReward_${activeUser}"],
                dailyEnergy: atomicState["dailyEnergy_${activeUser}"] ?: 0,
                dailyFeeds: atomicState["dailyFeeds_${activeUser}"] ?: 0,
                dailyShots: atomicState["dailyShots_${activeUser}"] ?: 0,
                dailyHormones: atomicState["dailyHormones_${activeUser}"] ?: 0,
                dailySuperFeeds: atomicState["dailySuperFeeds_${activeUser}"] ?: 0,
                dailyBossLures: atomicState["dailyBossLures_${activeUser}"] ?: 0 
            ],
            leaderId: leaderId, lbChicken: lbChicken, lbPulse: lbPulse, lbCoins: lbCoins, lbAdventure: lbAdventure,
            poll: pollData, userMoods: userMoods
        ]
    
        render contentType: "application/json", data: JsonOutput.toJson(data)
    } catch (e) {
        log.error "Data Fetch Error: ${e}"
        render contentType: "application/json", status: 500, data: JsonOutput.toJson([error: e.getMessage()])
    }
}

def getChickenData(uid) {
    def c = atomicState["chicken_${uid}"]
    if(!c) c = [name:"Eggbert", level:1, xp:0, xpToNext:1500, pts:0, coins:0, stats:[hp:100, atk:10, def:5, crit:5], currentHp:100, wins:0, loss:0, inventory:[feed:0]]
    if(c.currentHp == null) c.currentHp = c.stats.hp
    if(!c.inventory) c.inventory = [feed:0]
    
    if(c.level <= 2) c.icon = "ü•ö"
    else if(c.level <= 7) c.icon = "üê•"
    else c.icon = "üêî"
    return c
}

def handleBuyItem() {
    def sStat = getShopStatus()
    if (!sStat.open) {
        render contentType: "application/json", data: JsonOutput.toJson([status: "error", msg: "The Shop is Closed for the night!"])
        return
    }
    def uid = params.uid.toInteger()
    def item = params.item
    def c = getChickenData(uid)
    def msg = "Error"; def status = "error"
    
    if (item == 'feed') {
        def feeds = atomicState["dailyFeeds_${uid}"] ?: 0
        if (feeds >= 2) { msg = "Sold Out"; }
        else if (c.coins >= 20) {
            c.coins -= 20; if (!c.inventory) c.inventory = [:]; 
            c.inventory.feed = (c.inventory.feed ?: 0) + 1
            atomicState["dailyFeeds_${uid}"] = feeds + 1
            msg = "Purchased Chicken Feed!"; status = "success"
            atomicState["chicken_${uid}"] = c
        } else { msg = "Not enough coins!"; }
    } 
         else if (item == 'boss_lure') {
        def lures = atomicState["dailyBossLures_${uid}"] ?: 0
        if (lures >= 2) { 
             msg = "Sold Out";
        }
        else if (c.coins >= 150) {
            c.coins -= 150
            atomicState["dailyBossLures_${uid}"] = lures + 1
            
            def prog = atomicState["advProgress_${uid}"] ?: [:]
            
            prog.boss1Att = false
            prog.boss2Att = false
            prog.boss3Att = false
            prog.bossFarmerAtt = 0
            
            atomicState["advProgress_${uid}"] = prog
            atomicState["chicken_${uid}"] = c
            status = "success"
            msg = "Bosses Lured! (Retries available)"
        } else {
            msg = "Not enough coins!";
        }
    }
    else if (item == 'steroid') {
        def shots = atomicState["dailyShots_${uid}"] ?: 0
        if (shots >= 2) { msg = "Sold Out"; } 
        else if (c.coins >= 50) {
            c.coins -= 50; c.pts += 5; 
            atomicState["dailyShots_${uid}"] = shots + 1; 
            atomicState["chicken_${uid}"] = c
            msg = "Steroid Shot applied! +5 Stats"; status = "success"
        } else { msg = "Not enough coins!"; }
    }
    else if (item == 'energy_drink') {
        def energyDaily = atomicState["dailyEnergy_${uid}"] ?: 0
        def maxE = (c.level >= 10) ? 10 : (c.level >= 5 ? 8 : 6)
        def tokens = atomicState["advTokens_${uid}"]
        if(tokens == null) tokens = maxE
        
        if (energyDaily >= 2) { msg = "Sold Out"; }
        else if (tokens >= maxE) { 
            render contentType: "application/json", data: JsonOutput.toJson([status: "energy_full", msg: "Your Energy Is Already Full"])
            return 
        }
        else if (tokens > 0) {
            render contentType: "application/json", data: JsonOutput.toJson([status: "energy_not_empty", msg: "You Already Have Energy"])
            return 
        } 
        else if (c.coins >= 15) {
            c.coins -= 15
            atomicState["advTokens_${uid}"] = maxE
            atomicState["dailyEnergy_${uid}"] = energyDaily + 1
            atomicState["chicken_${uid}"] = c
            msg = "Energy Restored!"; status = "success"
        } else { msg = "Not enough coins!"; }
    }
    else if (item == 'card_box') {
        if (c.coins >= 150) {
            c.coins -= 150
            def rnd = Math.random()
            if (rnd < 0.25) {
                addChickenXp(uid, 200)
                adjustCoins(uid, 200)
                msg = "üì¶ BIG PRIZE! +200 XP +200 Coins"; status = "success"
            } else {
                addChickenXp(uid, 10)
                adjustCoins(uid, 10)
                msg = "üì¶ Small Prize... +10 XP +10 Coins"; status = "success"
            }
            c = getChickenData(uid)
            atomicState["chicken_${uid}"] = c
        } else { msg = "Need 150 coin"; }
    }
    else if (item == 'hormone') {
        if(c.level >= 10) { msg = "Max Level Reached!"; } 
        else {
            def hormones = atomicState["dailyHormones_${uid}"] ?: 0
            if (hormones >= 5) { msg = "Sold Out (Max 5/day)"; }
            else if (c.coins >= 100) {
                c.coins -= 100
                addChickenXp(uid, 100)
                atomicState["dailyHormones_${uid}"] = hormones + 1
                msg = "Growth Hormones Applied! +100 XP"; status = "success"
            } else { msg = "Not enough coins!"; }
        }
    }
    else if (item == 'super_feed') {
        def sFeeds = atomicState["dailySuperFeeds_${uid}"] ?: 0
        if (!c.inventory) c.inventory = [:]
        def currentInv = (c.inventory.super_feed ?: 0)
        
        if (sFeeds >= 2) { msg = "Sold Out (Max 2/day)"; }
        else if (currentInv >= 4) { msg = "Inventory Full (Max 4)"; }
        else if (c.coins >= 200) {
            c.coins -= 200
            c.inventory.super_feed = currentInv + 1
            atomicState["dailySuperFeeds_${uid}"] = sFeeds + 1
            atomicState["chicken_${uid}"] = c
            msg = "Super Feed Purchased!"; status = "success"
        } else { msg = "Not enough coins!"; }
    }
    else if (item == 'chicken_sword') {
        if (!c.inventory) c.inventory = [:]
        if (c.level < 10) { msg = "Level 10 Required!"; }
        else if ((c.inventory.chicken_sword ?: 0) > 0) { msg = "You already own the Chicken Sword!"; }
        else if (c.coins >= 1000) {
            c.coins -= 1000
            c.inventory.chicken_sword = 1
            c.stats.atk += 100
            atomicState["chicken_${uid}"] = c
            msg = "Chicken Sword Purchased! (+100 ATK)"; status = "success"
        } else { msg = "Need 1000 coins"; }
    }
    else if (item == 'chicken_shield') {
        if (!c.inventory) c.inventory = [:]
        if (c.level < 10) { msg = "Level 10 Required!"; }
        else if ((c.inventory.chicken_shield ?: 0) > 0) { msg = "You already own the Chicken Shield!"; }
        else if (c.coins >= 1000) {
            c.coins -= 1000
            c.inventory.chicken_shield = 1
            c.stats.def += 100
            atomicState["chicken_${uid}"] = c
            msg = "Chicken Shield Purchased! (+100 DEF)"; status = "success"
        } else { msg = "Need 1000 coins"; }
    }

    checkDaily(uid, "shop")
    render contentType: "application/json", data: JsonOutput.toJson([status: status, msg: msg])
}

// Standard Helpers
def checkDaily(uid, type) {
    if(!uid || uid==0) return
    
    // 1. Get current state or default
    def d = atomicState["dailys_${uid}"] ?: [post:false, reply:false, like:false, battle:false, shop:false, login:false, hospital:false, adventure:false, tithe:false, collected:false]
    
    // 2. Fix Missing Keys (Updates older user data)
    boolean dirty = false
    if(!d.containsKey('adventure')) { d.adventure = false; dirty = true }
    if(!d.containsKey('tithe')) { d.tithe = false; dirty = true }
    
    if(dirty) atomicState["dailys_${uid}"] = d

    // 3. If already collected, stop here
    if(d.collected) return
    
    // 4. Mark the specific task as true
    if(d[type] == false) {
        d[type] = true
      
        // 5. Check for full completion (Requires Tithe)
        if(d.post && d.reply && d.like && d.battle && d.shop && d.login && d.hospital && d.adventure && d.tithe) {
            d.collected = true
            
            // INCREASED REWARDS HERE
            addChickenXp(uid, 100) 
            adjustCoins(uid, 20)
            
            addPostToFeed(uid, "system", "üéâ <b>Daily Tasks Complete!</b> (+100 XP, +20 Coins)", "happy")
        }
        atomicState["dailys_${uid}"] = d
    }
}
def addChickenXp(uid, amt) {
    def c = getChickenData(uid)
    if(c.level < 10) { 
        c.xp += amt
        def leveledUp = false

        while(c.level < 10 && c.xp >= c.xpToNext) { 
            c.level++
            c.xp -= c.xpToNext
            c.xpToNext = (c.xpToNext * 2.0).toInteger()
            c.pts += 3
            c.stats.hp += 10
            c.currentHp += 10
            c.stats.atk += 1
            c.stats.def += 1
            leveledUp = true
        } 

        if(c.level >= 10) { c.xp = 0; c.xpToNext = 0; }
        
        atomicState["chicken_${uid}"] = c

        if (leveledUp) {
            def userName = getUserName(uid)
            addPostToFeed(0,"system","üéâ <b>${userName}</b>'s chicken <b>${c.name}</b> reached Lvl ${c.level}!","happy") 
        }
    } else {

        atomicState["chicken_${uid}"] = c
        touchActivity()
    }
}

def removeChickenXp(uid, amt) { def c=getChickenData(uid); c.xp=Math.max(0,c.xp-amt); atomicState["chicken_${uid}"]=c }
def adjustCoins(uid, amt) { def c=getChickenData(uid); c.coins=(c.coins?:0)+amt; atomicState["chicken_${uid}"]=c }
def getUserName(id) { if(id==0)return "Home"; return settings["userName_${id}"]?:"User ${id}" }

def getUsersList() {
    def l = []
    def now = new Date().time
    for(int i=1;i<=8;i++) if(settings["userEnabled_${i}"]) {
        def last = atomicState["lastSeen_${i}"]
        def c = getChickenData(i)
        def isWounded = atomicState["isWounded_${i}"] ?: false
        def prog = atomicState["advProgress_${i}"] ?: [:]
        
        def isSlayer = false 
        
        def isFarmer = atomicState["isFarmerBadge_${i}"] ?: false
        
        l << [
            id:i, name:settings["userName_${i}"]?:"User ${i}", chicken:c.name, 
            icon:c.icon, avatar:atomicState["avatar_${i}"]?:(settings["userAvatar_${i}"]?:"üôÇ"), 
            lastSeen:last, hp: c.currentHp, maxHp: c.stats.hp,
            isWounded: isWounded, isSlayer: isSlayer, isFarmer: isFarmer
        ]
    }
    return l
}

def getWeeklyLeader() { 
    def max=0; def l=-1; 
    for(int i=1;i<=8;i++) { def c=atomicState["weeklyCount_${i}"]?:0; if(c>max){max=c; l=i} }
    return l 
}

def addPostToFeed(uid, type, msg, mood) {
    def pid = UUID.randomUUID().toString()
    def p = [id:pid, uid:uid, type:type, msg:msg, mood:mood, ts:new Date().time, replies:[], reactions:[], eaters:[:]]
    atomicState["p_${pid}"] = p
    def ids = atomicState.postIDs ?: []; ids.add(pid); atomicState.postIDs = ids
    touchActivity()
}

def addNotification(uid, msg) { def l = atomicState["notifs_${uid}"] ?: []; l<<msg; atomicState["notifs_${uid}"]=l }
def incrementWeeklyCount(uid) { if(uid==0)return; atomicState["weeklyCount_${uid}"] = (atomicState["weeklyCount_${uid}"]?:0)+1 }
def decrementWeeklyCount(uid) { if(uid==0)return; atomicState["weeklyCount_${uid}"] = Math.max(0, (atomicState["weeklyCount_${uid}"]?:0)-1) }

def checkRateLimit(uid, type) { 
    if(uid == (settings.adminUserId as Integer)) return [allowed:true]
    if(uid == 0) return [allowed:true]
    def limit = (type == "post") ? 2 : 5
    def window = 300000 
    def now = new Date().time
    def key = "timestamps_${type}_${uid}"
    def history = atomicState[key] ?: []
    history = history.findAll { (now - it) < window }
    if (history.size() >= limit) return [allowed:false, wait: (window - (now - history.min()))/1000]
    history << now
    atomicState[key] = history
    return [allowed:true]
}

def processBattleLogic(c1, c2, isPvE) {
    def hp1 = (c1.currentHp != null) ? c1.currentHp : c1.stats.hp
    def hp2 = (c2.currentHp != null) ? c2.currentHp : c2.stats.hp
    hp1 = hp1.toInteger()
    hp2 = hp2.toInteger()
    def maxHp1 = c1.stats.hp
    def maxHp2 = c2.stats.hp
    def turns = []
    
    turns << [msg: "Battle Start!", attHp: hp1, defHp: hp2]
    
    int turnCount = 0
    def rand = new Random()
    def isFarmer = (c2.name == "Crazy Farmer")
    
    while(hp1 > 0 && hp2 > 0 && turns.size() < 25) {
        turnCount++
       
        def playerCrushChance = (c1.level <= 5) ? 1.0 : 2.0
        def isPlayerCrush = (rand.nextFloat() * 100) < playerCrushChance
        def dmg1 = [dmg:0, msg:"", event:""]
        if (isPlayerCrush) {
            dmg1.dmg = maxHp2
            dmg1.msg = "‚öîÔ∏è <b>ONE SHOT!</b> (-${maxHp2})"
            dmg1.event = "crush"
        } else {
              dmg1 = calcDamage(c1, c2)
        }
        
        hp2 -= dmg1.dmg
        turns << [msg: "${c1.name} ${dmg1.msg}", attHp: hp1, defHp: Math.max(0, hp2), event: dmg1.event]
        
        if(hp2 <= 0 && !isPvE && (c2.inventory.feed ?: 0) > 0 && rand.nextFloat() < 0.50) {
            c2.inventory.feed--
            hp2 = maxHp2
            turns << [msg: "üêî ${c2.name} eats Feed! FULLY HEALED!", attHp: hp1, defHp: hp2, event: "heal"]
        }
        if(hp2 <= 0) break

        def enemyCrushChance = isFarmer ? 3.0 : 0.5 
        def isEnemyCrush = (rand.nextFloat() * 100) < enemyCrushChance
        def dmg2 = [dmg:0, msg:"", event:""]
        
        if (isEnemyCrush) {
             dmg2.dmg = maxHp1
             dmg2.msg = "‚öîÔ∏è <b>ONE SHOT!</b> (-${maxHp1})"
             dmg2.event = "crush"
        } else {
              dmg2 = calcDamage(c2, c1)
        }

        hp1 -= dmg2.dmg
        turns << [msg: "${c2.name} ${dmg2.msg}", attHp: Math.max(0, hp1), defHp: Math.max(0, hp2), event: dmg2.event]
        
        if (isFarmer && hp1 > 0 && rand.nextFloat() < 0.10) {
             def dmg2b = calcDamage(c2, c1)
             hp1 -= dmg2b.dmg
             turns << [msg: "${c2.name} <b>DOUBLE ATTACK!</b> ${dmg2b.msg}", attHp: Math.max(0, hp1), defHp: Math.max(0, hp2), event: "crit"]
        }
        
        if(hp1 <= 0) {
            if (c2.isBoss && (c1.inventory.super_feed ?: 0) > 0) {
                c1.inventory.super_feed--
                hp1 = maxHp1
                turns << [msg: "üåü <b>${c1.name}</b> used SUPER FEED! 100% REVIVE!", attHp: hp1, defHp: hp2, event: "heal"]
            }

            else if (hp1 <= 0 && (c1.inventory.feed ?: 0) > 0 && rand.nextFloat() < 0.50) {
                 c1.inventory.feed--
                hp1 = maxHp1
                turns << [msg: "üêî ${c1.name} eats Feed! FULLY HEALED!", attHp: hp1, defHp: hp2, event: "heal"]
            }
        }
    }
    def won = (hp1 > 0)
    if(won) turns << [msg: "${c1.name} Wins!", attHp: Math.max(0, hp1), defHp: 0]
    else turns << [msg: "${c2.name} Wins!", attHp: 0, defHp: Math.max(0, hp2)]
    
    return [won: won, turns: turns, maxHp: [att: maxHp1, def: maxHp2], remainingHp: hp1]
}
def calcDamage(att, defs) {
    def critChance = 0
    if(att.isEnemy) {
        critChance = (att.isBoss) ? 2 : 1
    } else {
        critChance = Math.min(5, att.stats.crit ?: 5)
        // FIXED: Actually checking for the sword now
        if (att.inventory?.chicken_sword) { critChance += 10 }
    }
    
    def isCrit = (Math.random()*100) < critChance
    def d = Math.max(1, (att.stats.atk - (defs.stats.def * 0.5)).toInteger())
    
    if(isCrit) d *= 2
    if(Math.random()*100 < 5) return [dmg: 0, msg: "Missed!", event: "miss"]
    return [dmg: d, msg: "‚öîÔ∏è ${d}" + (isCrit ? " Critical!" : ""), event: isCrit ? "crit" : ""]
}

def handleAdventureExplore() {
    try {
        def uid = params.uid?.toInteger()
        def zone = params.zone 
        if (!uid) { render contentType: "application/json", data: JsonOutput.toJson([status: "error", msg: "User ID missing"]); return }

        if (atomicState["isWounded_${uid}"]) {
            render contentType: "application/json", data: JsonOutput.toJson([status: "error", msg: "You are Unconscious! Go to Hospital."])
            return
        }

        def c = getChickenData(uid)
        
        def maxE = 6
        if(c.level >= 5) maxE = 8
        if(c.level >= 10) maxE = 10
        
        def tokens = atomicState["advTokens_${uid}"]
        if (tokens == null) { tokens = maxE; atomicState["advTokens_${uid}"] = maxE }
        
        def prog = atomicState["advProgress_${uid}"] ?: [
            wilds:0, spooky:0, crazy:0, 
            boss1:false, boss2:false, boss3:false, bossFarmer:false,
            boss1Att:false, boss2Att:false, boss3Att:false, bossFarmerAtt:0
        ]
        
        if (zone == "boss_hawk" && (prog.boss1Att || prog.boss1)) { 
            render contentType: "application/json", data: JsonOutput.toJson([status: "error", msg: "Already attempted Raven today!"]); return 
        }
        if (zone == "boss_owl" && (prog.boss2Att || prog.boss2)) { 
            render contentType: "application/json", data: JsonOutput.toJson([status: "error", msg: "Already attempted Owl today!"]); return 
        }
        if (zone == "boss_skeleton" && (prog.boss3Att || prog.boss3)) { 
            render contentType: "application/json", data: JsonOutput.toJson([status: "error", msg: "Already attempted Skeleton today!"]); return 
        }
        
        def farmerAttempts = (prog.bossFarmerAtt instanceof Integer) ? prog.bossFarmerAtt : (prog.bossFarmerAtt ? 1 : 0)
        if (zone == "boss_farmer") {
             if (farmerAttempts >= 2 || prog.bossFarmer) {
                 render contentType: "application/json", data: JsonOutput.toJson([status: "error", msg: "No attempts remaining for Crazy Farmer today!"]); return 
             }
        }

        def cost = (zone == "wilds" || zone == "spooky" || zone == "crazy_house") ? 1 : 0
        if (cost > 0 && tokens < cost) {
            render contentType: "application/json", data: JsonOutput.toJson([status: "error", msg: "Out of exploration tokens!"])
            return
        }
        if (cost > 0) atomicState["advTokens_${uid}"] = tokens - cost
        
        def enemy = null
        def isBoss = false
        def rnd = new Random()
        
        if (zone == "wilds") {
            def enemies = [
                [name: "Snake", icon: "üêç", scale: 0.8, stories: ["A Snake slithered out!", "A Snake guards the path!"]],
                [name: "Fox", icon: "ü¶ä", scale: 1.0, stories: ["A Fox jumped from the bushes!", "A hungry Fox appeared!"]],
                [name: "Grub", icon: "üêõ", scale: 0.5, stories: ["A giant Grub crawled out!", "A Grub looks tasty but fights back!"]]
            ]
            enemy = enemies[rnd.nextInt(enemies.size())]
        } 
        else if (zone == "spooky") {
            if (c.level < 5) {
                render contentType: "application/json", data: JsonOutput.toJson([status: "error", msg: "Spooky House requires Level 5+"])
                return
            }
            def enemies = [
                [name: "Mouse", icon: "üê≠", scale: 0.9, stories: ["A Mouse squeaked aggressively!", "A Mouse defends its cheese!"]],
                [name: "Spider", icon: "üï∑Ô∏è", scale: 1.1, stories: ["A huge Spider drops down!", "A Spider webs the path!"]],
                [name: "Bat", icon: "ü¶á", scale: 1.2, stories: ["A Bat swoops down!", "A Bat screeches loudly!"]]
            ]
            enemy = enemies[rnd.nextInt(enemies.size())]
        }
        else if (zone == "crazy_house") {
            if (c.level < 10) {
                render contentType: "application/json", data: JsonOutput.toJson([status: "error", msg: "Crazy Farmer's House requires Level 10"])
                return
            }
            def enemies = [
                [name: "Barn Rat", icon: "üêÄ", scale: 1.0, stories: ["A giant Barn Rat gnaws at you!", "The Rat defends the grain!"]],
                [name: "Feral Cat", icon: "üêà", scale: 1.2, stories: ["A Feral Cat hisses!", "A Cat blocks the barn door!"]],
                [name: "Guard Dog", icon: "üêï", scale: 1.3, stories: ["The Guard Dog barks loudly!", "A Dog chases you!"]]
            ]
          
            enemy = enemies[rnd.nextInt(enemies.size())]
        }
        else if (zone == "boss_hawk") {
             enemy = [name: "The Raven", icon: "ü¶Ö", stories: ["The Boss Raven attacks!", "Defend the Coop from The Raven!"]]
             isBoss = true
        }
        else if (zone == "boss_owl") {
             enemy = [name: "Spooky Owl", icon: "ü¶â", stories: ["The Spooky Boss Owl appears!", "Defend the Coop from the Ghost Owl!"]]
             isBoss = true
        }
        else if (zone == "boss_skeleton") {
             enemy = [name: "Scary Skeleton", icon: "üíÄ", stories: ["The Boss Skeleton rattles its bones!", "Defend the Coop from the Skeleton!"]]
             isBoss = true
        }
        else if (zone == "boss_farmer") {
             // Strict Prerequisites
             if ((prog.crazy ?: 0) < 6 || !prog.boss1 || !prog.boss2 || !prog.boss3) {
                  render contentType: "application/json", data: JsonOutput.toJson([status: "error", msg: "Locked! You must defeat all 3 sub-bosses and win 6 times at Crazy House first."])
                  return
             }
             enemy = [name: "Crazy Farmer", icon: "üë®‚Äçüåæ", stories: ["The Crazy Farmer is angry!", "Get off my lawn!"]]
             isBoss = true
        }
        else { render contentType: "application/json", data: JsonOutput.toJson([status: "error", msg: "Invalid Zone"]); return }

        def hasSword = (c.inventory.chicken_sword ?: 0) > 0
        def hasShield = (c.inventory.chicken_shield ?: 0) > 0
        def baseAtk = c.stats.atk - (hasSword ? 100 : 0)
        def baseDef = c.stats.def - (hasShield ? 100 : 0)

        def multipliers = []
        if (zone == "boss_hawk" || zone == "boss_owl") {
            multipliers = [0.5, 1.0, 2.0]
        } else if (zone == "boss_skeleton") {
            multipliers = [0.5, 1.0, 2.0, 3.0]
        } else if (zone == "boss_farmer") {
            multipliers = [1.5, 2.0, 3.0, 4.0, 5.0]
        } else {
            multipliers = [enemy.scale ?: 1.0] 
        }
        
        def selectedMult = multipliers[rnd.nextInt(multipliers.size())]
        def variance = (rnd.nextFloat() * 0.2) - 0.1 
        if (isBoss) variance = 0
        def finalScale = selectedMult + variance
        if (finalScale < 0.1) finalScale = 0.1

        def estats = [hp:100, atk:10, def:5, crit:1]
        estats.hp = Math.max(10, (c.stats.hp * finalScale).toInteger())
        estats.atk = Math.max(1, (baseAtk * finalScale).toInteger())
        estats.def = Math.max(1, (baseDef * finalScale).toInteger())
        estats.crit = 1 
       
        def story = enemy.stories[rnd.nextInt(enemy.stories.size())]
        if (isBoss) story += " (Scale: ${selectedMult}x)" 

        def battleData = processBattleLogic(c, [name: enemy.name, level: c.level, stats: estats, currentHp: estats.hp, inventory:[:], icon: enemy.icon, isEnemy:true, isBoss:isBoss], true)
        
        checkDaily(uid, "adventure")
        c.currentHp = c.stats.hp
         
        def rewardData = [xp:0, coins:0, title:"Victory!", sub:"Battle Won"]
        def bossDefeatedStr = null

        if (zone == "boss_hawk") prog.boss1Att = true
        else if (zone == "boss_owl") prog.boss2Att = true
        else if (zone == "boss_skeleton") prog.boss3Att = true
        else if (zone == "boss_farmer") prog.bossFarmerAtt = (prog.bossFarmerAtt ?: 0) + 1

        if(battleData.won) {
             def xp = 20; def coins = 5
            
            if(zone == "wilds") {
                prog.wilds = (prog.wilds ?: 0) + 1
                if(prog.wilds == 3) { xp += 20; coins += 10; rewardData.title = "Wilds Master!"; rewardData.sub = "Daily Bonus: 3 Wins"; }
            }
            else if(zone == "spooky") {
                xp = 50; coins = 25
                prog.spooky = (prog.spooky ?: 0) + 1
                if(prog.spooky == 3) { xp += 20; coins += 10; rewardData.title = "Spooky Master!"; rewardData.sub = "Daily Bonus: 3 Wins"; }
            }
            else if(zone == "crazy_house") {
                xp = 60; coins = 40
                prog.crazy = (prog.crazy ?: 0) + 1
                if(prog.crazy == 6) { 
                     xp += 40; coins += 20;
                    rewardData.title = "Crazy House Master!"; rewardData.sub = "Farmer Unlocked! (+40xp +20c)";
                }
            }
            else if(zone == "boss_hawk") {
                prog.boss1 = true; xp += 50; coins += 50; 
                rewardData.title = "Raven Defeated!"; rewardData.sub = "Daily Boss Bonus"; bossDefeatedStr = "raven"
                addPostToFeed(0, "system", "ü¶Ö <b>ACCOMPLISHMENT UNLOCKED:</b> <b>${c.name}</b> defeated the <b>Raven</b>!", "excited")
            }
            else if(zone == "boss_owl") {
                prog.boss2 = true; xp += 50; coins += 50; 
                rewardData.title = "Owl Defeated!"; rewardData.sub = "Daily Boss Bonus"; bossDefeatedStr = "owl"
                addPostToFeed(0, "system", "ü¶â <b>NIGHT WATCH:</b> <b>${c.name}</b> banished the <b>Spooky Owl</b>!", "excited")
            }
            else if(zone == "boss_skeleton") {
                prog.boss3 = true; xp += 100; coins += 100; 
                rewardData.title = "Skeleton Destroyed!"; rewardData.sub = "Legendary Bonus"; bossDefeatedStr = "skeleton"
                addPostToFeed(0, "system", "üíÄ <b>LEGENDARY HERO:</b> <b>${c.name}</b> destroyed the <b>Skeleton Boss</b>!", "excited")
            }
            else if(zone == "boss_farmer") {
                prog.bossFarmer = true; xp += 200; coins += 200;
                
                if (!c.inventory) c.inventory = [feed:0]
                c.inventory.feed = (c.inventory.feed ?: 0) + 2
                c.pts += 10
                atomicState["farmerWinTime_${uid}"] = new Date().time
                
                def boxRnd = Math.random()
                def boxMsg = ""
                if (boxRnd < 0.25) {
                    addChickenXp(uid, 200)
                    adjustCoins(uid, 200)
                    boxMsg = "Box contained BIG PRIZE (+200xp/200c)!"
                } else {
                    c = getChickenData(uid)
                    addChickenXp(uid, 10)
                    adjustCoins(uid, 10)
                    boxMsg = "Box contained Small Prize (+10xp/10c)."
                }

                rewardData.title = "FARMER DEFEATED!"; rewardData.sub = "200XP/200c (The Barn is Yours) + Items! ${boxMsg}"; bossDefeatedStr = "farmer"
                addPostToFeed(0, "system", "üë®‚Äçüåæ <b>ULTIMATE CHAMPION:</b> <b>${c.name}</b> defeated the <b>Crazy Farmer</b>! The barn is ours!", "excited")
            }
            
            addChickenXp(uid, xp)
            adjustCoins(uid, coins)
            c = getChickenData(uid)
            c.advWins = (c.advWins ?: 0) + 1
            atomicState["chicken_${uid}"] = c
            atomicState["advProgress_${uid}"] = prog
            rewardData.xp = xp; rewardData.coins = coins
        } else {
            c.advLoss = (c.advLoss ?: 0) + 1
            atomicState["chicken_${uid}"] = c
            atomicState["advProgress_${uid}"] = prog 
            
            def losses = (atomicState["advLossCount_${uid}"] ?: 0) + 1
            atomicState["advLossCount_${uid}"] = losses
            if (losses >= 2) {
                atomicState["isWounded_${uid}"] = true
                atomicState["woundedTime_${uid}"] = new Date().time
                addNotification(uid, "üöë Knocked Unconscious by ${enemy.name}!")
            } else {
                  addNotification(uid, "‚ö†Ô∏è Defeated by ${enemy.name}. One more loss = Unconscious!")
            }
        }
        
        touchActivity()
        render contentType: "application/json", data: JsonOutput.toJson([
            status: "success", found: true, 
            enemyName: enemy.name, enemyIcon: enemy.icon, introText: story,
            turns: battleData.turns, maxHp: battleData.maxHp, losses: (atomicState["advLossCount_${uid}"] ?: 0),
            won: battleData.won, reward: rewardData,
            bossDefeated: bossDefeatedStr
        ])
    } catch (e) {
        log.error "Adventure Error: ${e}"
        render contentType: "application/json", data: JsonOutput.toJson([status: "error", msg: "System Error: ${e.getMessage()}"])
    }
}

def handleForagingExplore() {
    try {
        def uid = params.uid?.toInteger()
        if (!uid) { render contentType: "application/json", data: JsonOutput.toJson([status: "error", msg: "User ID missing"]); return }

        if (atomicState["isWounded_${uid}"]) {
            render contentType: "application/json", data: JsonOutput.toJson([status: "error", msg: "You are Unconscious! Go to Hospital."])
            return
        }

        def c = getChickenData(uid)
        def maxE = 6
        if(c.level >= 5) maxE = 8
        if(c.level >= 10) maxE = 10
        def tokens = atomicState["advTokens_${uid}"]
        if (tokens == null) { tokens = maxE; atomicState["advTokens_${uid}"] = maxE }
        
        if (tokens <= 0) {
            render contentType: "application/json", data: JsonOutput.toJson([status: "error", msg: "Out of Energy!"])
            return
        }
        
        atomicState["advTokens_${uid}"] = tokens - 1
        
        def rnd = new Random().nextInt(100) 
        def res = [:]
        
        if (rnd < 60) { 
            addChickenXp(uid, 25)
            res = [title:"Foraged: Herbs", sub:"Useful herbs found!", icon:"üåø", xp:25, coins:0]
        } else if (rnd < 90) { 
            adjustCoins(uid, 25)
            res = [title:"Foraged: Coins", sub:"Small coin stash!", icon:"üí∞", xp:0, coins:25]
        } else if (rnd < 96) { 
            if (!c.inventory) c.inventory = [feed:0]
            c.inventory.feed = (c.inventory.feed ?: 0) + 1
            atomicState["chicken_${uid}"] = c
            res = [title:"Foraged: Feed", sub:"Added to Inventory", icon:"üåΩ", xp:0, coins:0]
        } else if (rnd < 99) { 
            c.pts += 5
            atomicState["chicken_${uid}"] = c
            res = [title:"Foraged: Steroid", sub:"+5 Stat Points (Applied)", icon:"üíâ", xp:0, coins:0]
        } else { 
            addChickenXp(uid, 100)
            adjustCoins(uid, 100)
            c = getChickenData(uid)
            if (!c.inventory) c.inventory = [feed:0]
            c.inventory.feed = (c.inventory.feed ?: 0) + 2
            c.pts += 10
            atomicState["chicken_${uid}"] = c
            res = [title:"TREASURE CHEST!", sub:"100XP, 100 Coin, 2 Feed, 2 Steroids!", icon:"üíé", xp:100, coins:100]
       }
         
        checkDaily(uid, "adventure")
        touchActivity()
        render contentType: "application/json", data: JsonOutput.toJson([status: "success", result: res])
        
    } catch (e) {
        log.error "Forage Error: ${e}"
        render contentType: "application/json", data: JsonOutput.toJson([status: "error", msg: "System Error: ${e.getMessage()}"])
    }
}

def handleHealChicken() {
    def uid = params.uid.toInteger()
    def c = getChickenData(uid)
    def isWounded = atomicState["isWounded_${uid}"]
    
    if (!isWounded) {
        render contentType: "application/json", data: JsonOutput.toJson([status: "error", msg: "Hospital only treats Unconscious chickens!"])
        return
    }
    if (c.coins >= 20) {
        c.coins -= 20
        c.currentHp = c.stats.hp 
        atomicState["chicken_${uid}"] = c
        atomicState["isWounded_${uid}"] = false
        atomicState["advLossCount_${uid}"] = 0 
        atomicState.remove("woundedTime_${uid}")
        render contentType: "application/json", data: JsonOutput.toJson([status: "success", msg: "Revived!"])
    } else {
        render contentType: "application/json", data: JsonOutput.toJson([status: "error", msg: "Not enough coins!"])
    }
}

def handlePost() {
    def uid = params.uid.toInteger()
    if(!checkRateLimit(uid, "post").allowed) { render contentType: "application/json", data: JsonOutput.toJson([status: "rate_limited", msg: "Slow down!"]); return }
    def mood = params.mood; if (mood) atomicState["mood_${uid}"] = mood
    incrementWeeklyCount(uid)
    addChickenXp(uid, 20)
    if(params.pinned == "true") atomicState.bulletin = [id: UUID.randomUUID().toString(), msg: params.msg, uid: uid, ts: new Date().time, replies: [], reactions: []]
    else addPostToFeed(uid, "status", params.msg, mood)
    checkDaily(uid, "post")
    render contentType: "application/json", data: JsonOutput.toJson([status: "success", xp: 20])
}
def handleReply() {
    def uid = params.uid.toInteger()
    if(!checkRateLimit(uid, "reply").allowed) { render contentType: "application/json", data: JsonOutput.toJson([status: "rate_limited", msg: "Slow down!"]); return }
    def isBul = (atomicState.bulletin?.id == params.postId)
    def isAnn = (params.postId == "announcement")
    def post = isBul ? atomicState.bulletin : (isAnn ? atomicState.announcementData : atomicState["p_${params.postId}"])
    if (post || isAnn) {
        if(isAnn && !post) post = [replies:[], reactions:[]]
        if (!post.replies) post.replies = []
        post.replies << [uid: uid, msg: params.msg, ts: new Date().time, reactions: []]
        incrementWeeklyCount(uid)
        addChickenXp(uid, 10)
        if(post.uid && post.uid != uid && post.uid != 0) addNotification(post.uid, "${getUserName(uid)} replied to you")
        if(isBul) atomicState.bulletin = post
        else if(isAnn) atomicState.announcementData = post
        else atomicState["p_${params.postId}"] = post
        checkDaily(uid, "reply")
        touchActivity()
    }
    render contentType: "application/json", data: JsonOutput.toJson([status: "success", xp: 10])
}
def handleDeletePost() {
    def p = atomicState["p_${params.postId}"]
    if(p) {
        decrementWeeklyCount(p.uid); if (p.type == "status" && !p.msg.contains("Sports Update")) { 
    removeChickenXp(p.uid, 20) 
}
        atomicState.remove("p_${params.postId}")
        def ids = atomicState.postIDs; ids.remove(params.postId); atomicState.postIDs = ids
        touchActivity()
    }
    render contentType: "application/json", data: JsonOutput.toJson([status: "success"])
}
def handleDeleteReply() {
    def uid = params.uid ? params.uid.toInteger() : 0
    def isBul = (atomicState.bulletin?.id == params.postId)
    def isAnn = (params.postId == "announcement")
    def post = isBul ? atomicState.bulletin : (isAnn ? atomicState.announcementData : atomicState["p_${params.postId}"])
    if(post && post.replies) {
        def reply = post.replies.find { it.ts == params.ts.toLong() }
        if(reply) {
            post.replies.remove(reply)
            if(isBul) atomicState.bulletin = post
            else if(isAnn) atomicState.announcementData = post
            else atomicState["p_${params.postId}"] = post
            touchActivity()
        }
    }
    render contentType: "application/json", data: JsonOutput.toJson([status: "success"])
}
def handleReact() {
    def uid = params.uid.toInteger()
    def isBul = (atomicState.bulletin?.id == params.postId)
    def isAnn = (params.postId == "announcement")
    def post = isBul ? atomicState.bulletin : (isAnn ? atomicState.announcementData : atomicState["p_${params.postId}"])
    if (post || isAnn) {
        if(isAnn && !post) post = [replies:[], reactions:[]]
        if(post.uid && post.uid == uid && !isAnn) { render contentType:"application/json", data:JsonOutput.toJson([status:"error", msg:"Self vote rejected"]); return }
        if(!post.reactions) post.reactions = []
        def existing = post.reactions.find { it.uid == uid }
        if(existing) { 
            if(existing.emote == params.emoji) { 
                post.reactions.remove(existing); if(post.uid && post.uid!=uid) adjustCoins(post.uid, -5) 
            }
            else existing.emote = params.emoji 
        } else { 
            post.reactions.add([uid:uid, emote:params.emoji]); if(post.uid && post.uid!=uid) {
                adjustCoins(post.uid, 5) 
                addNotification(post.uid, "üëç Someone liked your post")
            }
        }
        if(isBul) atomicState.bulletin = post
        else if(isAnn) atomicState.announcementData = post
        else atomicState["p_${params.postId}"] = post
        checkDaily(uid, "like")
        touchActivity()
    }
    render contentType: "application/json", data: JsonOutput.toJson([status: "success"])
}
def handleReplyReact() {
    def isBul = (atomicState.bulletin?.id == params.postId)
    def isAnn = (params.postId == "announcement")
    def post = isBul ? atomicState.bulletin : (isAnn ? atomicState.announcementData : atomicState["p_${params.postId}"])
    if(post) {
        def r = post.replies ? post.replies.find { it.ts == params.ts.toLong() } : null
        if(r) {
            if(r.uid == params.uid.toInteger()) { render contentType:"application/json", data:JsonOutput.toJson([status:"error", msg:"Self vote rejected"]); return }
            if(!r.reactions) r.reactions = []
            def existing = r.reactions.find { it.uid == params.uid.toInteger() }
            if(existing) {
                if(existing.type == params.type) { r.reactions.remove(existing) }
                else { existing.type = params.type }
             } else {
                r.reactions.add([uid:params.uid.toInteger(), type:params.type])
            }
            if(params.type == 'down' && r.uid && r.uid!=params.uid.toInteger()) {
                def targetC = getChickenData(r.uid)
                if(targetC.coins >= 5) adjustCoins(r.uid, -5)
              }
            checkDaily(params.uid.toInteger(), "like")
            if(isBul) atomicState.bulletin = post
            else if(isAnn) atomicState.announcementData = post
            else atomicState["p_${params.postId}"] = post
            touchActivity()
        }
    }
    render contentType:"application/json", data:JsonOutput.toJson([status:"success"])
}
def handleChickenRename() { def c=getChickenData(params.uid.toInteger()); c.name=params.name; atomicState["chicken_${params.uid}"]=c; touchActivity(); render contentType:"application/json", data:JsonOutput.toJson([status:"success"]) }
def handleChickenTrain() {
    def c = getChickenData(params.uid.toInteger())
    if(c.pts > 0) {
        if(params.stat=="hp") { c.stats.hp+=10; c.currentHp+=10; }
        if(params.stat=="atk") c.stats.atk+=1; 
        if(params.stat=="def") c.stats.def+=1;
        if(params.stat=="crit") c.stats.crit+=1;
        c.pts--; atomicState["chicken_${params.uid}"] = c; touchActivity()
    }
    render contentType: "application/json", data: JsonOutput.toJson([status: "success"])
}
def handleChickenFarm() {
    def uid = params.uid.toInteger(); def now = new Date().time
    
    if(atomicState["isWounded_${uid}"]) {
        render contentType: "application/json", data: JsonOutput.toJson([status: "error", msg: "You are Unconscious! Go to Hospital."])
        return
    }
    atomicState["farmCooldown_${uid}"] = now + 86400000
    for(int i=1;i<=8;i++) if(i!=uid) atomicState["cooldown_${uid}_${i}"] = now + 21600000
    def c = getChickenData(uid); def won = false;
    if(Math.random()*100 < (50+(c.level*2))) { 
        addChickenXp(uid,50); adjustCoins(uid,10); won = true;
        addPostToFeed(uid, "system", "üêî <b>${c.name}</b> worked hard at the farm! (+50 XP, +10 Coins)", "happy")
        def d = atomicState["dailys_${uid}"] ?: [dailyWins:0]
        atomicState["dailys_${uid}"] = d
    } else {
        addPostToFeed(uid, "system", "üêî <b>${c.name}</b> went to the farm but slacked off... (No Reward)", "tired")
    }
    checkDaily(uid, "battle")
    atomicState["farmResult_${uid}"] = won
    touchActivity()
    render contentType: "application/json", data: JsonOutput.toJson([status: "success", won: won])
}
def handleClearReward() { 
    atomicState.remove("farmResult_${params.uid}")
    // --- NEW: Clear the pending reward too ---
    atomicState.remove("pendingReward_${params.uid}") 
    // -----------------------------------------
    render contentType: "application/json", data: JsonOutput.toJson([status: "success"]) 
}
def handleHabitReset() { dailyReset(); render contentType: "application/json", data: JsonOutput.toJson([status: "success"]) }
def handleHabitComplete() {
    def uid = params.uid.toInteger()
    def d = [post:true, reply:true, like:true, battle:true, shop:true, login:true, hospital:true, adventure:true, tithe:true, collected:true]
    
    addChickenXp(uid, 100)
    adjustCoins(uid, 20)
    
    atomicState["dailys_${uid}"] = d
    render contentType: "application/json", data: JsonOutput.toJson([status: "success", msg: "Dailys Completed"])
}
def handleTithe() {
    def uid = params.uid.toInteger()
    def c = getChickenData(uid)
    def tithes = atomicState["dailyTithes_${uid}"] ?: 0
    
    // 1. Check Limits (2 per day)
    if (tithes >= 2) {
        render contentType: "application/json", data: JsonOutput.toJson([status: "error", msg: "You have already tithed 2 times today."])
        return
    }
    
    // 2. Check Cost (50 Coins)
    if (c.coins < 50) {
        render contentType: "application/json", data: JsonOutput.toJson([status: "error", msg: "Not enough coins (Need 50)."])
        return
    }
    
    // 3. Deduct Cost & Increment Counter
    c.coins -= 50
    atomicState["dailyTithes_${uid}"] = tithes + 1
    
    def rnd = Math.random()
    def won = false
    def rewardMsg = ""
    
    // 4. RNG Logic (15% Total Chance for Item)
    if (rnd < 0.05) { 
        // 5% Chance: Super Feed
        if (!c.inventory) c.inventory = [:]
        c.inventory.super_feed = (c.inventory.super_feed ?: 0) + 1
        won = true
        rewardMsg = "Divine Blessing! You received 1 Super Feed."
    } else if (rnd < 0.15) { 
        // 10% Chance: Regular Feed
        if (!c.inventory) c.inventory = [:]
        c.inventory.feed = (c.inventory.feed ?: 0) + 1
        won = true
        rewardMsg = "Blessing! You received 1 Chicken Feed."
    } else {
        // Consolation: +5 XP for charity
        addChickenXp(uid, 5) 
    }
    
    atomicState["chicken_${uid}"] = c
    
    // 5. Mark Daily Task Complete
    checkDaily(uid, "tithe")
    touchActivity()
    
    // 6. Return Data to App
    render contentType: "application/json", data: JsonOutput.toJson([
        status: "success", 
        won: won, 
        title: won ? "Blessing Received!" : "Tithe Accepted",
        sub: won ? rewardMsg : "You gave 50 coins to the church.",
        xp: won ? 0 : 5, 
        coins: 0
    ])
}
def handleChurchVisit() {
    render contentType: "application/json", data: JsonOutput.toJson([status: "success"])
}
def handleShopVisit() { checkDaily(params.uid.toInteger(), "shop"); render contentType: "application/json", data: JsonOutput.toJson([status: "success"]) }
def handleHospitalVisit() { checkDaily(params.uid.toInteger(), "hospital"); render contentType: "application/json", data: JsonOutput.toJson([status: "success"]) }

def scheduledDailyQuestion() { postDailyQuestion(false) }

def postDailyQuestion(force) {
    def today = new Date().format("yyyy-MM-dd")
    if (!force && atomicState.lastQuestionDate == today) return
    
    // Default question in case download fails
    def qList = ["What is one thing you are grateful for today?"]
    
    try {
        // 1. Get filename and clean it up (remove spaces)
        def fn = settings.questionFileName ?: "FamilyPulse_Questions.json"
        fn = fn.trim() 
        
        log.debug "Family Pulse: Attempting to download file: '${fn}'"
        
        def content = downloadHubFile(fn)
        if (content) {
            def jsonStr = new String(content, "UTF-8")
            
            if(jsonStr.trim().startsWith("<")) {
                log.error "Family Pulse Error: Downloaded HTML instead of JSON. This usually means the file was not found (404) or Hub Security blocked it. Content Preview: ${jsonStr.take(100)}..."
            } else {
                def questions = new JsonSlurper().parseText(jsonStr)
                if (questions && questions.size() > 0) {
                    qList = questions
                    log.info "Family Pulse: Successfully loaded ${questions.size()} questions."
                }
            }
        } else {
            log.warn "Family Pulse: Download returned no content."
        }
    } catch (e) { 
        log.warn "Family Pulse Read Error: ${e}" 
    }
   
    def rnd = new Random()
    def q = qList[rnd.nextInt(qList.size())]
    addPostToFeed(0, "system", "<b>Question of the Day:</b><br>${q}", "happy")
    atomicState.lastQuestionDate = today
}

def updateDailyScripture() {
    def fn = "FamilyPulse_Scriptures.json"
    

    def content = downloadHubFile(fn)
    if (content) {
        try {
            def jsonStr = new String(content, "UTF-8")
            def verses = new groovy.json.JsonSlurper().parseText(jsonStr)
            
            if (verses && verses.size() > 0) {
                def rnd = new Random()
                def quote = verses[rnd.nextInt(verses.size())]
                atomicState.dailyScripture = quote
                log.info "Family Pulse: Updated Daily Scripture: ${quote}"
            }
        } catch (e) {
            log.error "Error parsing scripture file: ${e}"
            atomicState.dailyScripture = "Love one another. (File Error)"
        }
    } else {
        atomicState.dailyScripture = "Trust in the Lord. (File Missing)"
    }
}

def scheduledFarmerCheck() { handleFarmerCheck(false) }
def scheduledDogCheck() { handleDogEventLogic(false) }
def handleFarmerCheck(force) {
    def today = new Date().format("yyyy-MM-dd")
    if (!force && atomicState.lastFarmerDate == today) return
    if (force || Math.random() < 0.5) {
        addPostToFeed(0, "event_farmer", "üë®‚Äçüåæ <b>The Farmer</b> is throwing out feed! Quick, grab some!", "excited")
    }
    atomicState.lastFarmerDate = today
}

def handleForceFarmer() { handleFarmerCheck(true); render contentType:"application/json", data:JsonOutput.toJson([status:"success"]) }
def handleForceQuestion() { postDailyQuestion(true); render contentType:"application/json", data:JsonOutput.toJson([status:"success"]) }
def handleForceBirthday() { checkSpecialEvents(true); render contentType:"application/json", data:JsonOutput.toJson([status:"success"]) }

def handleFarmerEat() {
    try {
        def uid = params.uid.toInteger()
        def pid = params.pid 
        def p = atomicState["p_${pid}"]
        if (!p) { render contentType: "application/json", data: JsonOutput.toJson([status: "error", msg: "Post not found"]); return }
        if (!p.eaters) p.eaters = [:]
        if (p.eaters.containsKey(uid.toString())) {
            def prevResult = p.eaters[uid.toString()]
            render contentType: "application/json", data: JsonOutput.toJson([status: "success", won: (prevResult == "won"), already: true])
            return
        }
        def won = false
        if(Math.random() < 0.5) {
            won = true; addChickenXp(uid, 10); adjustCoins(uid, 5)
        }
        p.eaters[uid.toString()] = won ? "won" : "lost"
        atomicState["p_${pid}"] = p
        render contentType: "application/json", data: JsonOutput.toJson([status: "success", won: won, already: false])
    } catch (e) { render contentType: "application/json", data: JsonOutput.toJson([status: "error", msg: "${e}"]) }
}

def handleChickenBattle() {
    def attId=params.uid.toInteger(); def defId=params.target.toInteger(); 
    if(atomicState["isWounded_${attId}"]) {
        render contentType: "application/json", data: JsonOutput.toJson([status: "error", msg: "You are Unconscious!"])
        return
    }
    if(atomicState["isWounded_${defId}"]) {
        render contentType: "application/json", data: JsonOutput.toJson([status: "error", msg: "Target is Unconscious!"])
        return
    }
    
    atomicState["cooldown_${attId}_${defId}"] = new Date().time + 21600000
    def c1=getChickenData(attId); def c2=getChickenData(defId)
    
    // PvP Logic uses processBattleLogic with isPvE=false
    def battleResult = processBattleLogic(c1, c2, false)
    
    if(battleResult.won) {
        c1.xp += 20; c1.coins = (c1.coins ?: 0) + 5; c1.wins++; 
        c2.loss++;
        addNotification(defId, "üíÄ Defeated by ${c1.name}")
    } else {
        c2.wins++; c1.loss++;
        addNotification(attId, "üíÄ Defeated by ${c2.name}")
        atomicState["dailyInitiatedLosses_${attId}"] = (atomicState["dailyInitiatedLosses_${attId}"] ?: 0) + 1
    }
    c1.currentHp = c1.stats.hp
    
    atomicState["chicken_${attId}"]=c1; atomicState["chicken_${defId}"]=c2; 
    checkDaily(attId, "battle")
    touchActivity()
    render contentType: "application/json", data: JsonOutput.toJson([turns:battleResult.turns, maxHp:battleResult.maxHp])
}

def cleanOldPosts() { 
    def ids = atomicState.postIDs ?: []
    if (ids.size() == 0) return

    def cutoff = new Date().time - ((settings.retentionDays ?: 7) * 86400000)
    def changed = false

    def checkCount = Math.min(ids.size(), 50)
    def toRemove = []

    for(int i=0; i<checkCount; i++) {
        def id = ids[i]
        def p = atomicState["p_${id}"]
        if (!p || p.ts < cutoff) {
            toRemove << id
            if (p) atomicState.remove("p_${id}")
        }
    }

    if (toRemove.size() > 0) {
        ids.removeAll(toRemove)
        atomicState.postIDs = ids
    }
}

def resetWeeklyStats() {
    for(int i=1; i<=8; i++) { atomicState["weeklyCount_${i}"] = 0 }
    addPostToFeed(0, "system", "üëë A new week begins!", null)
}

def handleAvatarUpdate() { atomicState["avatar_${params.uid}"] = params.emoji; touchActivity(); render contentType:"application/json", data:JsonOutput.toJson([status:"success"]) }
def handleClearBulletin() { atomicState.bulletin = null; touchActivity(); render contentType:"application/json", data:JsonOutput.toJson([status:"success"]) }

def handleResetCooldowns() { 
    for(int i=1; i<=8; i++) { 
        atomicState.remove("farmCooldown_${i}")
        atomicState.remove("woundedTime_${i}")
        atomicState.remove("dailyEnergy_${i}")
        atomicState.remove("dailyFeeds_${i}")
        atomicState.remove("dailyShots_${i}")
        atomicState.remove("dailyHormones_${i}")
        atomicState.remove("dailySuperFeeds_${i}")
		atomicState.remove("dailyBossLures_${i}")
        atomicState.remove("advTokens_${i}")
        atomicState.remove("advReset_${i}")
        for(int j=1; j<=8; j++) { atomicState.remove("cooldown_${i}_${j}".toString()) } 
    } 
    touchActivity()
    render contentType:"application/json", data:JsonOutput.toJson([status:"success"]) 
}

def handleMoodUpdate() { 
    atomicState["mood_${params.uid}"] = params.mood;
    addPostToFeed(params.uid.toInteger(), "status", "is currently ${params.mood}", params.mood)
    touchActivity();
    render contentType:"application/json", data:JsonOutput.toJson([status:"success"]) 
}

def handlePollVote() {
    def uid = params.uid.toInteger()
    def vote = params.vote.toInteger()
    def p = atomicState.pollData ?: [open:true, votes:[:]]
    if(!p.open) { render contentType: "application/json", data: JsonOutput.toJson([status: "error", msg: "Poll is closed."]); return }
    if(p.votes.containsKey(uid.toString())) { render contentType: "application/json", data: JsonOutput.toJson([status: "error", msg: "You already voted!"]); return }
    p.votes[uid.toString()] = vote
    atomicState.pollData = p
    addChickenXp(uid, 10); adjustCoins(uid, 5)
    touchActivity()
    render contentType: "application/json", data: JsonOutput.toJson([status: "success", xp: 10, coins: 5])
}

def handlePollCloseCmd() {
    def p = atomicState.pollData ?: [open:true, votes:[:]]
    if(p.open) {
        p.open = false
        def counts = [1:0, 2:0, 3:0, 4:0]
        def total = 0
        p.votes.each { uid, vote -> 
            if(counts[vote] == null) counts[vote] = 0
            counts[vote] += 1
            total++
        }
        def q = settings.pollQuestion ?: "Community Poll"
        def html = "<b>üìä Poll Results: ${q}</b><br><br>"
        [1,2,3,4].each { i ->
            def ans = settings["pollAns${i}"]
            if(ans) {
                def c = counts[i]
                def pct = (total > 0) ? Math.round((c / total) * 100) : 0
                html += "<b>${ans}:</b> ${c} votes (${pct}%)<br>"
                html += "<div style='background:#eee; height:8px; width:100%; border-radius:4px; margin-bottom:8px;'><div style='background:#0984e3; height:100%; width:${pct}%; border-radius:4px;'></div></div>"
            }
        }
        html += "<br><i>Total Votes: ${total}</i>"
        addPostToFeed(0, "system", html, "excited")
         atomicState.pollData = p
        touchActivity()
        render contentType: "application/json", data: JsonOutput.toJson([status: "success"])
    } else {
        render contentType: "application/json", data: JsonOutput.toJson([status: "error", msg: "Poll already closed"])
    }
}

preferences {
    page(name: "mainPage")
    page(name: "pageGeneral")
    page(name: "pageFeed")
    page(name: "pageUsers")
}

def mainPage() {
    if (state.accessToken) cleanOldPosts() 
    
    dynamicPage(name: "mainPage", title: "Family Pulse Pro Administration", install: true, uninstall: true) {
        section {
            paragraph """<style>
                /* Updated Header to match app style (140px height, gradient, centered) */
                .fp-header { 
                    background: linear-gradient(90deg, #FF6B6B 0%, #FF8E53 100%); 
                    height: 140px;
                    display: flex;
                    flex-direction: column;
                    justify-content: center;
                    align-items: center;
                    padding: 0 20px; 
                    border-radius: 10px; 
                    color: white; 
                    text-align: center; 
                    margin-bottom: 15px; 
                    box-shadow: 0 4px 10px rgba(0,0,0,0.1); 
                    box-sizing: border-box;
                }
                .fp-title { font-size: 24px; font-weight: 800; letter-spacing: 1px; }
                .fp-subtitle { font-size: 14px; opacity: 0.9; font-weight: 600; margin-top: 5px; }
                .fp-link-card { background: #f8f9fa; border: 1px solid #ddd; border-radius: 8px; padding: 15px; margin-top: 10px; text-align: center; }
                .fp-link-btn { text-decoration: none; color: white; background: #0984e3; padding: 8px 15px; border-radius: 5px; font-weight: bold; margin: 0 5px; display: inline-block; }
                .fp-link-btn:hover { background: #00cec9; text-decoration: none; color: white; }
                .menu-item { margin-bottom: 5px; }
            </style>
            <div class="fp-header">
                <div class="fp-title">FAMILY PULSE PRO</div>
                <div class="fp-subtitle">Adventure & Social Platform</div>
            </div>"""
        }

        section("Administration Menu") {
            href(name: "toGeneral", page: "pageGeneral", title: "‚öôÔ∏è System & Settings", description: "Hub IDs, Calendars, Timers, Timezones, and Data Retention.", state: "complete")
            href(name: "toFeed", page: "pageFeed", title: "üì¢ Feed & Engagement", description: "Global Announcements, Polls, and Daily Questions.", state: "complete")
            href(name: "toUsers", page: "pageUsers", title: "üë• User Management", description: "Manage Family Members, Passwords, Avatars, and Birthdays.", state: "complete")
        }

        if (state.accessToken) {
            section("Web Portal Access") {
                def token = state.accessToken
                def ip = location.hubs[0].localIP
                def hid = settings.manualHubID ?: location.hub.id
                def mainLocal = "http://${ip}:8080/apps/api/${app.id}/portal?access_token=${token}"
                def mainCloud = "https://cloud.hubitat.com/api/${hid}/apps/${app.id}/portal?access_token=${token}"
                
                paragraph """<div class="fp-link-card">
                    <div style="font-weight:bold; color:#555; margin-bottom:10px;">üö™ Main Login Portal</div>
                    <a href="${mainLocal}" target="_blank" class="fp-link-btn">üè† Local Access</a>
                    <a href="${mainCloud}" target="_blank" class="fp-link-btn">‚òÅÔ∏è Cloud Access</a>
                    <div style="font-size:11px; color:#999; margin-top:10px;">Use these links to access the app on your devices.</div>
                </div>"""
            }
        }
    }
}

def pageGeneral() {
    dynamicPage(name: "pageGeneral", title: "System Configuration", install: false, uninstall: false) {
        section("üîå Integrations") {
            input "manualHubID", "text", title: "Hub ID Override", defaultValue: location.hub.id, description: "Required for cloud links. Default is usually correct."
            
            paragraph "<b>Family Hub Connection</b><br>Enter details to show a Home button linking to Family Hub."
            input "familyHubAppId", "text", title: "Family Hub App ID", description: "The App ID of Family Hub."
            input "familyHubToken", "text", title: "Family Hub Access Token", description: "The Access Token from Family Hub."

            paragraph "<b>Calendar Connection (Optional)</b><br>Enter details to show a Calendar button in the app header."
            input "calendarAppId", "text", title: "Calendar App ID", description: "The App ID of your installed Calendar application."
            input "calendarToken", "text", title: "Calendar Access Token", description: "Copy the Access Token from the Calendar App."
        }
        
        section("‚è∞ Timers & Schedules") {
            input "dailyQuestionTime", "number", title: "Daily Question Hour (0-23)", defaultValue: 9, width: 6, description: "Hour to post the automated Question."
            input "birthdayPostTime", "number", title: "Birthday Check Hour (0-23)", defaultValue: 7, width: 6, description: "Hour to check for birthdays."
        }
        
        section("üíæ Data & Files") {
            input "retentionDays", "number", title: "Post Retention (Days)", defaultValue: 7, width: 6, description: "Auto-delete posts older than this."
            input "questionFileName", "text", title: "Question JSON File", defaultValue: "FamilyPulse_Questions.json", width: 6, description: "File in File Manager containing questions."
        }
    }
}

def pageFeed() {
    dynamicPage(name: "pageFeed", title: "Feed & Engagement", install: false, uninstall: false) {
        
        section("üìä Community Poll") {
            input "pollEnabled", "bool", title: "Enable Poll Widget", submitOnChange: true, defaultValue: false
            
            if(settings.pollEnabled) {
                input "pollQuestion", "text", title: "Poll Question", required: true, description: "E.g., What's for dinner?"
                input "pollAns1", "text", title: "Option 1", required: true, width: 6
                input "pollAns2", "text", title: "Option 2", required: true, width: 6
                input "pollAns3", "text", title: "Option 3", required: false, width: 6
                input "pollAns4", "text", title: "Option 4", required: false, width: 6
                
                paragraph "<b>Poll Controls</b>"
                input "btnResetPoll", "button", title: "üîÑ Reset Votes & Open Poll", width: 6
                input "btnClosePoll", "button", title: "üîí Close Poll & Post Results", width: 6
            }
        }
    }
}

def pageUsers() {
    dynamicPage(name: "pageUsers", title: "User Management", install: false, uninstall: false) {
        section {
            paragraph "Enable up to 8 family members. Use 'Timeout' to temporarily block access."
        }
        
        for (int i = 1; i <= 8; i++) {
            section("üë§ User Slot ${i}") {
                input "userEnabled_${i}", "bool", title: "Enable User ${i}", submitOnChange: true
                
                if (settings["userEnabled_${i}"]) {
                    input "userName_${i}", "text", title: "Display Name", width: 4
                    input "userPass_${i}", "password", title: "Password (Optional)", width: 4
                    input "userAvatar_${i}", "text", title: "Avatar Emoji", width: 4, defaultValue: "üòÄ"
                    
                    input "userBirthday_${i}", "text", title: "Birthday (MM-DD)", width: 6
                    input "userTimeOut_${i}", "bool", title: "üö´ Timeout (Block Access)", width: 6
                    
                    
                    if(state.accessToken) {
                        def token = state.accessToken
                        def hid = settings.manualHubID ?: location.hub.id
                        def lLink = "http://${location.hubs[0].localIP}:8080/apps/api/${app.id}/feed?access_token=${token}&asUser=${i}"
                        def cLink = "https://cloud.hubitat.com/api/${hid}/apps/${app.id}/feed?access_token=${token}&asUser=${i}"
                        paragraph "<div style='font-size:11px; background:#f0f0f0; padding:5px; border-radius:4px;'>üîó <b>Direct Links:</b> <a href='${lLink}' target='_blank'>Local</a> | <a href='${cLink}' target='_blank'>Cloud</a></div>"
                    }
                }
            }
        }
    }
}

def getUserOptions() {
    def opts = [:]
    for(int i=1; i<=8; i++) {
        if(settings["userEnabled_${i}"]) opts["${i}"] = settings["userName_${i}"] ?: "User ${i}"
    }
    return opts
}

def appButtonHandler(btn) { 
    if(btn=="btnResetPoll") { atomicState.pollData = [open: true, votes: [:]] }
    if(btn=="btnClosePoll") { handlePollCloseCmd() }
    } 
def renderLoginScreen() {
    def token = state.accessToken ?: ""
    def homeBtn = ""
    if(settings.familyHubAppId && settings.familyHubToken) {
         homeBtn = """<div class="action-chip" onclick="window.location.href='../${settings.familyHubAppId}/dashboard?access_token=${settings.familyHubToken}'"><i class="fa fa-home"></i></div>"""
    }

    def css = "<style>body{font-family:'Nunito',sans-serif;background:#f4f6f8;margin:0;padding:0;}"
    css += ".header { background: linear-gradient(90deg, #FF6B6B 0%, #FF8E53 100%); height: 140px; backdrop-filter: blur(8px); border-bottom: 1px solid rgba(0,0,0,0.05); padding: 0 20px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }"
    css += ".action-chip { background: rgba(255, 255, 255, 0.25); border: 1px solid rgba(255, 255, 255, 0.4); padding: 6px 14px; border-radius: 20px; font-weight: 800; font-size: 13px; cursor: pointer; display: flex; align-items: center; gap: 6px; color: white; backdrop-filter: blur(4px); transition:0.2s; }"
    css += ".action-chip:active { transform: translateY(2px); background: rgba(255, 255, 255, 0.15); }"
    css += ".brand-col { display:flex; flex-direction:column; }"
    css += ".brand-row { display:flex; align-items:center; gap:10px; }"
    css += ".title{font-size:24px; font-weight:900; color:white; margin:0;}"
    css += ".slogan { font-size: 11px; font-weight: 700; color: rgba(255,255,255,0.9); margin-left: 34px; margin-top: -3px; }"
    css += ".logo-heart { font-size:24px; color:white; animation: pulseHeart 1.5s infinite; display:flex; align-items:center; }"
    css += "@keyframes pulseHeart { 0% {transform:scale(1);} 50% {transform:scale(1.2);} 100% {transform:scale(1);} }"
    css += ".main-container { display:flex; align-items:center; justify-content:center; height: calc(100vh - 80px); }"
    css += ".card{background:white;padding:30px;border-radius:20px;box-shadow:0 10px 30px rgba(0,0,0,0.1);text-align:center;width:90%;max-width:400px;}"
    css += ".user-grid{display:grid;grid-template-columns:1fr 1fr;gap:15px; margin-top:20px;}"
    css += ".user-btn{background:#f8f9fa;border:2px solid #eee;border-radius:15px;padding:15px;cursor:pointer;transition:0.2s;display:flex;flex-direction:column;align-items:center; position:relative;}"
    css += ".lock-badge { position: absolute; top: 8px; right: 8px; width: 20px; height: 20px; background: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: #95a5a6; font-size: 10px; border: 1px solid #ddd; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }"
    css += ".user-btn:hover{background:#fff0f0;border-color:#FF6B6B;transform:scale(1.05);}"
    css += ".av{font-size:40px;margin-bottom:5px;line-height:1;}"
    css += ".name{font-weight:bold;color:#555;}"
    css += ".disabled-user { opacity: 0.5; pointer-events: none; filter: grayscale(100%); background: #ddd; }"
    css += ".modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); backdrop-filter: blur(5px); z-index: 20000; display: none; align-items: center; justify-content: center; }"
    css += ".modal-content { background: white; width: 85%; max-width: 320px; border-radius: 24px; padding: 25px; text-align: center; box-shadow: 0 10px 40px rgba(0,0,0,0.3); position:relative; animation: popIn 0.3s ease-out; }"
    css += ".input-field { width: 100%; padding: 12px; border: 2px solid #eee; border-radius: 12px; font-size: 16px; margin: 15px 0; box-sizing: border-box; outline: none; transition: 0.3s; text-align:center; }"
    css += ".input-field:focus { border-color: #FF6B6B; }"
    css += ".btn { background: linear-gradient(135deg, #FF6B6B, #FF8E53); color: white; border: none; padding: 12px; border-radius: 12px; width: 100%; font-weight: 800; font-size: 14px; cursor: pointer; margin-top: 5px; box-shadow: 0 4px 15px rgba(255, 107, 107, 0.25); }"
    css += ".btn-sec { background: white; color: #555; border: 2px solid #eee; margin-top: 10px; box-shadow: none; }"
    css += "@keyframes pulseGlow { 0% { box-shadow: 0 0 5px rgba(255, 107, 107, 0.1); border-color:#FF6B6B; } 50% { box-shadow: 0 0 15px rgba(255, 142, 83, 0.4); border-color:#FF8E53; } 100% { box-shadow: 0 0 5px rgba(255, 107, 107, 0.1); border-color:#FF6B6B; } }"
    css += ".btn-pulse { animation: pulseGlow 2s infinite ease-in-out; color: #FF6B6B !important; }"
    css += "@keyframes popIn { from {opacity:0; transform:scale(0.8);} to {opacity:1; transform:scale(1);} }"
    css += "@keyframes shake { 0%, 100% {transform: translateX(0);} 25% {transform: translateX(-5px);} 75% {transform: translateX(5px);} }"
    css += ".shake { animation: shake 0.3s ease-in-out; }</style>"

    def js = "<script>"
    js += "let pendingUid = 0; let pendingPass = '';"
    js += "function login(uid, hasPass, realPass) { if(hasPass) { pendingUid = uid; pendingPass = realPass; document.getElementById('passwordModal').style.display = 'flex'; document.getElementById('passInput').value = ''; document.getElementById('passInput').focus(); } else { window.location.href='feed?access_token=${token}&asUser=' + uid; } }"
    js += "function checkPass() { let input = document.getElementById('passInput').value; if(input === pendingPass) { window.location.href='feed?access_token=${token}&asUser=' + pendingUid; } else { document.getElementById('passwordModal').style.display = 'none'; let err = document.getElementById('errorModal'); err.style.display = 'flex'; err.querySelector('.modal-content').classList.add('shake'); setTimeout(() => err.querySelector('.modal-content').classList.remove('shake'), 500); } }"
    js += "function closeModals() { document.getElementById('passwordModal').style.display = 'none'; document.getElementById('errorModal').style.display = 'none'; }"
    js += "</script>"

    def html = "<!DOCTYPE html><html><head><meta charset='UTF-8'><meta name='viewport' content='width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no'><meta name='apple-mobile-web-app-capable' content='yes'><title>Family Pulse Pro Login</title><link rel='stylesheet' href='https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css'>"
    html += css
    html += js
    html += "</head><body>"
    html += """<div class="header">
            <div class="brand-col">
                <div class="brand-row">
                    <div class="logo-heart"><i class="fa fa-heartbeat"></i></div>
                    <div class="title">Family Pulse Pro</div>
                </div>
                <div class="slogan"></div>
            </div>
            <div>${homeBtn}</div>
        </div>"""
    
    html += "<div class='main-container'><div class='card'>"
    html += "<h2 style='margin:0 0 5px 0; color:#FF6B6B;'>Welcome</h2>"
    html += "<div style='margin-bottom:15px; color:#999; font-size:13px;'>Who is logging in?</div>"
    // -------------------------------

    html += "<div class='user-grid'>"

    for(int i=1; i<=8; i++) {
        if(settings["userEnabled_${i}"]) {
            def name = settings["userName_${i}"] ?: "User ${i}"
            def av = atomicState["avatar_${i}"] ?: (settings["userAvatar_${i}"] ?: "üòÄ")
            def isTimeout = settings["userTimeOut_${i}"]
            def rawPass = settings["userPass_${i}"]
            def safePass = rawPass ? rawPass.replace("'", "\\'") : ""
            def hasPass = (safePass != "")
            def lockIcon = hasPass ? "<div class='lock-badge'><i class='fa fa-lock'></i></div>" : ""

            if (isTimeout) {
                html += "<div class='user-btn disabled-user'><div class='av'>üîí</div><div class='name'>LOCKED</div></div>"
            } else {
                html += "<div class='user-btn' onclick=\"login(${i}, ${hasPass}, '${safePass}')\">${lockIcon}<div class='av'>${av}</div><div class='name'>${name}</div></div>"
            }
        }
    }
    
    html += "</div>"
    html += "</div></div>" 
    
    html += "<div id='passwordModal' class='modal'><div class='modal-content'><div style='font-size:40px; margin-bottom:10px;'>üîí</div><h3 style='margin:0; color:#333;'>Enter Password</h3><p style='font-size:12px; color:#999;'>Security Check</p><input type='password' id='passInput' class='input-field' placeholder='****' onkeypress='if(event.key === \"Enter\") checkPass()'><button class='btn' onclick='checkPass()'>Unlock</button><button class='btn btn-sec' onclick='closeModals()'>Cancel</button></div></div>"
    html += "<div id='errorModal' class='modal'><div class='modal-content' style='border: 2px solid #e74c3c;'><div style='font-size:40px; margin-bottom:10px;'>üö´</div><h3 style='margin:0; color:#e74c3c;'>Access Denied</h3><p style='font-size:12px; color:#555;'>Incorrect Password</p><button class='btn' style='background:#e74c3c; box-shadow:0 4px 15px rgba(231, 76, 60, 0.3);' onclick='document.getElementById(\"errorModal\").style.display=\"none\"; document.getElementById(\"passwordModal\").style.display=\"flex\";'>Try Again</button></div></div>"
    html += "</body></html>"

    render contentType: "text/html; charset=utf-8", data: html
}

def renderFeedShell() {
    try {
        if (params.access_token) state.accessToken = params.access_token
        def token = params.access_token ?: state.accessToken
        if (!token) { render contentType: "text/html", data: "<h1>Missing Token</h1>"; return; }
        if (!params.asUser) { renderLoginScreen(); return; }

        def activeUser = params.asUser.toInteger()
        if (settings["userTimeOut_${activeUser}"]) { 
             def jailHtml = """<!DOCTYPE html><html><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><title>In Timeout</title><style>body{font-family:'Nunito',sans-serif;background:#f4f6f8;display:flex;align-items:center;justify-content:center;height:100vh;flex-direction:column;text-align:center;}.card{background:white;padding:40px;border-radius:20px;box-shadow:0 10px 30px rgba(0,0,0,0.1);max-width:300px;}</style></head><body><div class="card"><div style="font-size:80px;">üëÆ‚Äç‚ôÇÔ∏è</div><h2>You're in Time Out</h2><p style="color:#555;">You cannot access Family Pulse right now.</p><div style="font-size:40px; margin-top:20px;">‚õìÔ∏èüöî‚õìÔ∏è</div></div></body></html>"""
            render contentType: "text/html", data: jailHtml
            return
        }

        def manifestJson = """
        {
          "name": "Family Pulse",
          "short_name": "Family Pulse",
          "start_url": ".",
          "display": "standalone",
          "background_color": "#f4f6f8",
          "theme_color": "#FF6B6B",
          "icons": [
            {"src": "https://img.icons8.com/color/192/000000/heart-with-pulse.png", "sizes": "192x192", "type": "image/png"},
            {"src": "https://img.icons8.com/color/512/000000/heart-with-pulse.png", "sizes": "512x512", "type": "image/png"}
          ]
        }"""
        def manifestBase64 = manifestJson.bytes.encodeBase64().toString()

def calendarLink = ""
        if (settings.calendarAppId && settings.calendarToken) {
            def hid = settings.manualHubID ?: location.hub.id
            def targetAppId = settings.calendarAppId
            def targetToken = settings.calendarToken
            def cUrl = "https://cloud.hubitat.com/api/${hid}/apps/${targetAppId}/calendar?access_token=${targetToken}"
            calendarLink = """<div class="action-chip chip-cal" onclick="window.location.href='${cUrl}'"><i class="fa fa-calendar-alt" style="color:#e67e22;"></i></div>"""
        }

def homeLink = ""
        if (settings.familyHubAppId && settings.familyHubToken) {
            homeLink = """<div class="action-chip" onclick="window.location.href='../${settings.familyHubAppId}/dashboard?access_token=${settings.familyHubToken}'"><i class="fa fa-home" style="color:#0984e3;"></i></div>"""
        }

        def html = """
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Family Pulse Pro">
    <link rel="manifest" href="data:application/json;base64,${manifestBase64}">
    <link rel="apple-touch-icon" href="https://img.icons8.com/color/192/000000/heart-with-pulse.png">
    <title>Family Pulse Pro</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700;800&display=swap" rel="stylesheet">
    <style>${getAppCss()}</style>
</head>
<body onclick="resetTimer()" onscroll="resetTimer()">
    <div id="toast" style="position:fixed; bottom:30px; left:50%; transform:translateX(-50%); background:#2ecc71; color:white; padding:10px 20px; border-radius:20px; opacity:0; pointer-events:none; transition:0.3s; z-index:2000; font-weight:800; box-shadow:0 5px 15px rgba(0,0,0,0.2);"></div>
    <div id="bossOverlay" class="boss-overlay"><div style="font-size:80px; margin-bottom:20px;">üèÜ</div><div class="boss-txt">BOSS<br>DEFEATED</div><div class="boss-sub" id="bossSubTxt">The Realm is Safe... for now.</div><button class="btn" style="margin-top:40px; width:auto; background:white; color:#333;" onclick="document.getElementById('bossOverlay').style.display='none'">Continue</button></div>
    <div id="voteConfirmModal" class="modal" style="z-index:9001;"><div class="modal-content"><div style="font-size:40px;">üó≥Ô∏è</div><h3 style="color:#555;">Cast Vote?</h3><p style="font-size:12px; color:#999;">You cannot change this later.</p><div style="display:flex; gap:10px; margin-top:20px;"><button class="btn" style="background:#ccc; color:#555;" onclick="closeVoteModal()">No</button><button class="btn" style="background:#0984e3;" onclick="confirmVote()">Yes</button></div></div></div>
    <div id="renameModal" class="modal" style="z-index:11000;"><div class="modal-content"><div style="font-size:40px;">üìù</div><h3 style="color:#555;">Name Your Chicken</h3><input type="text" id="chkNameInput" class="composer" placeholder="Enter name..." style="width:100%; margin-bottom:10px; border:2px solid #eee;"><div style="display:flex; gap:10px; margin-top:10px;"><button class="btn btn-secondary" onclick="document.getElementById('renameModal').style.display='none'">Cancel</button><button class="btn" onclick="confirmRename()">Save Name</button></div></div></div>
    <div id="revivePopup" class="revive-popup"><div style="font-size:60px; margin-bottom:10px;">üè•‚ú®</div><h2 style="color:#2ecc71; margin:0;">Revived!</h2><p>Your chicken is back on its feet!</p><button class="btn" style="background:#2ecc71;" onclick="document.getElementById('revivePopup').style.display='none'">Awesome</button></div>
    <div id="energyModal" class="loss-popup"><div style="font-size:60px; margin-bottom:10px;">‚ö°</div><h2 style="color:#e74c3c; margin:0;">Out of Energy!</h2><p>Grab an Energy Drink!</p><button class="btn btn-secondary" onclick="document.getElementById('energyModal').style.display='none'">Close</button></div>
    <div id="energyNotEmptyModal" class="loss-popup" style="border-color:#f1c40f;"><div style="font-size:60px; margin-bottom:10px;">‚úã‚ö°</div><h2 style="color:#f39c12; margin:0;">Wait!</h2><p>You Already Have Energy</p><button class="btn btn-secondary" onclick="document.getElementById('energyNotEmptyModal').style.display='none'">Close</button></div>
    <div id="energyFullModal" class="loss-popup" style="border-color:#2ecc71;"><div style="font-size:60px; margin-bottom:10px;">‚ö°‚úÖ</div><h2 style="color:#2ecc71; margin:0;">Fully Charged!</h2><p>Your Energy Is Already Full.</p><button class="btn btn-secondary" onclick="document.getElementById('energyFullModal').style.display='none'">Close</button></div>
    <div id="unconsciousModal" class="unconscious-popup"><div style="font-size:60px; margin-bottom:10px;">ü§ï</div><h2 style="color:#c0392b; margin:0;">You Are Unconscious!</h2><p>You cannot perform this action while injured.</p><button class="btn" style="background:#c0392b;" onclick="closeModal(); openHospital();">Go To Hospital</button><button class="btn btn-secondary" onclick="document.getElementById('unconsciousModal').style.display='none'">Close</button></div>
    <div id="lossModal" class="loss-popup"><div style="font-size:60px; margin-bottom:10px;">üíÄ</div><h2 style="color:#e74c3c; margin:0;">You Lost!</h2><p id="lossMsg">Be careful, 2 losses = Unconscious.</p><button class="btn" style="background:#e74c3c;" onclick="document.getElementById('lossModal').style.display='none'">Ouch</button></div>
    <div id="welcomeModal" class="modal" onclick="closeModal()"><div class="modal-content"><h2 style="margin:0 0 15px 0; color:#6c5ce7;">üëã Welcome Back!</h2><div id="welcomeContent" style="text-align:left; margin-bottom:15px;"></div><button class="btn" onclick="closeModal()">OK</button></div></div>
    <div id="avatarModal" class="modal" onclick="closeModal()"><div class="modal-content" onclick="event.stopPropagation()"><h3 style="margin:0; font-weight:800; color:#333;">Choose Look</h3><div class="grid" id="avatarGrid"></div></div></div>
   

    <div id="shopModal" class="modal" style="display:none;">
    
    <div id="shop-view-open" class="modal-content" onclick="event.stopPropagation()">
        <div class="modal-help-btn" onclick="openHelp('shop')">?</div>
        <h2 style="margin:0; color:#00b894;">Chicken Shop</h2>
        <div style="font-size:12px; color:#666; margin-bottom:15px;">Spend Coins to boost your chicken!</div>
        <div style="background:#00b894; color:white; padding:5px; border-radius:8px; display:inline-block; margin-bottom:15px; font-weight:bold;">üí∞ <span id="shopCoins">0</span> Coins</div>
        
        <div class="shop-item"><div class="item-icon">‚öîÔ∏è</div><div class="item-details"><b style="color:#2d3436;">Chicken Sword</b><br><span style="font-size:11px; color:#636e72;">+100 ATK & +10% Crit. Lvl 10 Only. One time buy.</span></div><button id="buy-sword" class="btn" style="width:auto; padding:8px 15px; font-size:12px; background:#e74c3c;" onclick="buyItem('chicken_sword')">1000 üí∞</button></div>
        <div class="shop-item"><div class="item-icon">üõ°Ô∏è</div><div class="item-details"><b style="color:#2d3436;">Chicken Shield</b><br><span style="font-size:11px; color:#636e72;">+100 DEF. Lvl 10 Only. One time buy.</span></div><button id="buy-shield" class="btn" style="width:auto; padding:8px 15px; font-size:12px; background:#3498db;" onclick="buyItem('chicken_shield')">1000 üí∞</button></div>
        <div class="shop-item"><div class="item-icon">üåΩ</div><div class="item-details"><b style="color:#2d3436;">Chicken Feed</b><br><span style="font-size:11px; color:#636e72;">50% Chance to revive with full HP. Max 2/day.</span></div><button id="buy-feed" class="btn" style="width:auto; padding:8px 15px; font-size:12px; background:#00b894;" onclick="buyItem('feed')">20 üí∞</button></div>
        <div class="shop-item"><div class="item-icon">üåü</div><div class="item-details"><b style="color:#2d3436;">Super Feed</b><br><span style="font-size:11px; color:#636e72;">100% Revive vs Boss. Max 2/day. Hold 4.</span></div><button id="buy-super-feed" class="btn" style="width:auto; padding:8px 15px; font-size:12px; background:#f1c40f;" onclick="buyItem('super_feed')">200 üí∞</button></div>
        <div class="shop-item" id="energy-item"><div class="item-icon">‚ö°</div><div class="item-details"><b style="color:#2d3436;">Energy Drink</b><br><span style="font-size:11px; color:#636e72;">Restores all Energy. Max 2/day.</span></div><button id="buy-energy" class="btn" style="width:auto; padding:8px 15px; font-size:12px; background:#0984e3;" onclick="buyItem('energy_drink')">15 üí∞</button></div>
        <div class="shop-item"><div class="item-icon">üíâ</div><div class="item-details"><b style="color:#2d3436;">Steroid Shot</b><br><span style="font-size:11px; color:#636e72;">+5 Stat Points (Perm). Max 2/day.</span></div><button id="buy-steroid" class="btn" style="width:auto; padding:8px 15px; font-size:12px; background:#e17055;" onclick="buyItem('steroid')">50 üí∞</button></div>
        <div class="shop-item"><div class="item-icon">üß¨</div><div class="item-details"><b style="color:#2d3436;">Growth Hormone</b><br><span style="font-size:11px; color:#636e72;">+100 XP. Max 5/day. Not for Lvl 10.</span></div><button id="buy-hormone" class="btn" style="width:auto; padding:8px 15px; font-size:12px; background:#6c5ce7;" onclick="buyItem('hormone')">100 üí∞</button></div>
        <div class="shop-item"><div class="item-icon">üì¶</div><div class="item-details"><b style="color:#2d3436;">Card Board Box</b><br><span style="font-size:11px; color:#636e72;">What could be inside?</span></div><button id="buy-box" class="btn" style="width:auto; padding:8px 15px; font-size:12px; background:#9b59b6;" onclick="buyItem('card_box')">150 üí∞</button></div>
        <div class="shop-item"><div class="item-icon">ü•ì</div><div class="item-details"><b style="color:#2d3436;">Boss Lure</b><br><span style="font-size:11px; color:#636e72;">Reset Boss Attempts! Max 2/day.</span></div><button id="buy-lure" class="btn" style="width:auto; padding:8px 15px; font-size:12px; background:#d35400;" onclick="buyItem('boss_lure')">150 üí∞</button></div>
        <button class="btn btn-secondary" onclick="closeModal()">Close</button>
    </div>

    <div id="shop-view-closed" class="modal-content" onclick="event.stopPropagation()" style="display:none; text-align:center; padding:30px;">
        <div style="font-size:60px; margin-bottom:15px; animation:shake 3s infinite;">üåô</div>
        <h2 style="color:#2c3e50; margin:0;">Shop Closed</h2>
        <p style="color:#7f8c8d; margin-top:10px;">The shopkeeper is sleeping.<br>Open from <b>Sunrise</b> to <b>8:00 PM</b>.</p>
        <button class="btn btn-secondary" onclick="closeModal()">Come back tomorrow</button>
    </div>
</div>
    <div id="foragingModal" class="modal" onclick="closeModal()"><div class="modal-content" onclick="event.stopPropagation()">
        <div class="modal-help-btn" onclick="openHelp('forage')">?</div><div style="font-size:60px; margin-bottom:10px;">üçÉ</div><h2 style="margin:0; color:#2ecc71;">Foraging</h2><p style="color:#666; font-size:13px; margin-bottom:15px;">Search the woods for items!</p>
        <div style="display:flex; justify-content:space-between; align-items:center; background:#f4f6f8; padding:10px; border-radius:10px; margin-bottom:15px; border:2px dashed #2ecc71;">
            <div style="font-weight:bold; color:#555;">Energy</div><div id="forageTokens" style="font-size:24px; font-weight:900; color:#2ecc71;">0/0</div>
        </div>
        <div id="forageTimer" style="font-size:11px; color:#999; margin-bottom:10px; display:none;">Restocking in: --:--</div>
        <button id="btnForageAction" class="btn" style="background:#2ecc71;" onclick="doForage()">Forage (1 Energy)</button>
    </div></div>

    <div id="hospitalModal" class="modal" onclick="closeModal()"><div class="modal-content" onclick="event.stopPropagation()"><div class="modal-help-btn" onclick="openHelp('hospital')">?</div><div style="font-size:60px; margin-bottom:10px;">üöë</div><h2 style="margin:0; color:#e74c3c;">Chicken Hospital</h2><p style="color:#666; font-size:13px;">Revive your unconscious chicken!</p><div id="hospitalContent" style="margin-top:15px;"></div></div></div>
    
    <div id="adventureModal" class="modal" onclick="closeModal()"><div class="modal-content" onclick="event.stopPropagation()"><div class="modal-help-btn" onclick="openHelp('adventure')">?</div><div style="font-size:60px; margin-bottom:10px;">‚öîÔ∏è</div><h2 style="margin:0; color:#9b59b6;">Adventure</h2><p style="color:#666; font-size:13px; margin-bottom:15px;">Explore the wild for XP and Coins!</p>
    <div style="display:flex; justify-content:space-between; align-items:center; background:#f4f6f8; padding:10px; border-radius:10px; margin-bottom:15px; border:2px dashed #9b59b6;"><div style="font-weight:bold; color:#555;">Energy</div><div style="text-align:right;"><div id="advTokens" style="font-size:24px; font-weight:900; color:#9b59b6;">0/5</div></div></div>
    <div id="advTimer" style="font-size:11px; color:#999; margin-top:-10px; margin-bottom:15px; display:none;">Restocking in: --:--</div>
    <div id="zoneResetTimer" style="font-size:10px; color:#e74c3c; margin-top:-10px; margin-bottom:10px; font-weight:bold; display:none;">Zone Reset: --:--</div>
    <div id="zone-wilds" class="adv-zone-btn" onclick="exploreAdventure('wilds')"><div class="adv-icon">üå≤</div><div class="adv-info"><h4>The Wilds</h4><p id="prog-wilds">Wins: 0/3</p></div></div>
    <div id="zone-spooky" class="adv-zone-btn" onclick="exploreAdventure('spooky')"><div class="adv-icon">üèöÔ∏è</div><div class="adv-info"><h4>Spooky Farm</h4><p id="prog-spooky">Wins: 0/3</p></div></div>
    <div id="zone-crazy" class="adv-zone-btn locked" onclick="exploreAdventure('crazy_house')"><div class="adv-icon">üöú</div><div class="adv-info"><h4>Crazy Farmer's House</h4><p id="prog-crazy">Locked (Level 10)</p></div></div>
    <div id="zone-boss1" class="adv-zone-btn locked" onclick="exploreAdventure('boss_hawk')"><div class="adv-icon">ü¶Ö</div><div class="adv-info"><h4>Boss: Raven</h4><p>Unlock: 3 Wilds Wins</p></div></div>
    <div id="zone-boss2" class="adv-zone-btn locked" onclick="exploreAdventure('boss_owl')"><div class="adv-icon">ü¶â</div><div class="adv-info"><h4>Boss: Owl</h4><p>Unlock: 3 Spooky Wins</p></div></div>
    <div id="zone-boss3" class="adv-zone-btn locked" style="background:#eee;" onclick="exploreAdventure('boss_skeleton')"><div class="adv-icon">üíÄ</div><div class="adv-info"><h4>Boss: Skeleton</h4><p>Defeat Raven & Owl</p></div></div>
    <div id="zone-boss-farmer" class="adv-zone-btn locked" style="background:#fffcf5; border-color:#e67e22;" onclick="exploreAdventure('boss_farmer')"><div class="adv-icon">üë®‚Äçüåæ</div><div class="adv-info"><h4>CRAZY FARMER</h4><p>Unlock: 6 Crazy Wins + All Bosses</p></div></div>
    </div></div>
    
    <div id="rewardModal" class="modal" style="z-index:21000;"><div class="modal-content reward-popup" style="background:#fffbf2; border:4px solid #f1c40f;"><div id="rewardContent"></div><button class="btn" onclick="closeRewardModal()">Awesome!</button></div></div>
    
    <div id="farmConfirmModal" class="modal" style="z-index:5000;">
        <div class="modal-content" style="background: linear-gradient(135deg, #e6ffe6 0%, #f0fff0 100%); border: 4px solid #2ecc71; color: #2d3436; max-width: 320px;">
            <div style="font-size:70px; margin-bottom:10px; filter: drop-shadow(0 4px 6px rgba(0,0,0,0.2));">üöú</div>
            <h2 style="margin:0; font-weight:900; color:#27ae60; text-transform:uppercase;">Farm Work</h2>
            <div style="background:white; border-radius:12px; padding:15px; margin:15px 0; box-shadow:0 4px 10px rgba(0,0,0,0.05);">
                <p style="margin:0 0 10px 0; font-weight:bold; color:#555;">Send chicken to work?</p>
                <ul style="text-align:left; font-size:12px; color:#666; margin:0; padding-left:20px;">
                    <li>Duration: <b>24 Hours</b></li>
                    <li>Reward: <b>50 XP & 10 Coins</b></li>
                    <li>Status: <b>Cannot Battle</b></li>
                </ul>
            </div>
            <div style="display:flex; gap:10px;">
                <button class="btn btn-secondary" style="flex:1; margin-top:0;" onclick="document.getElementById('farmConfirmModal').style.display='none'">Cancel</button>
                <button id="farmConfirmBtn" class="btn" style="flex:1; margin-top:0; background: linear-gradient(to right, #2ecc71, #27ae60); box-shadow: 0 4px 10px rgba(46, 204, 113, 0.4);" onclick="doFarmConfirm()">Let's Work!</button>
            </div>
        </div>
    </div>

    <div id="universalHelpModal" class="modal" style="z-index:20000;">
        <div class="modal-content" onclick="event.stopPropagation()">
            <div id="helpContentArea"></div>
            <button class="btn btn-secondary" style="margin-top:15px;" onclick="document.getElementById('universalHelpModal').style.display='none'">Close</button>
        </div>
    </div>

    <div id="coopModal" class="modal"><div class="modal-content" style="background:#fffbf2; border:4px solid #e67e22; position:relative;"><div id="coopContent"></div><button class="btn" onclick="closeModal()" style="margin-top:10px; background:#e67e22;">Close</button></div></div>
    
    <div id="battleModal" class="modal"><div class="modal-content"><div id="battleContent"></div></div></div>
    
    ${getChurchModalHtml()}

    <div class="header">
        <div class="brand"><div class="brand-main"><i class="fa fa-heartbeat"></i> Family Pulse Pro</div></div>
        <div class="header-actions">
            <div id="weather-icon" style="font-size:20px; margin-right:10px; color:#f1c40f;"></div>
            <span id="logoutTimer" class="timer-text">5:00</span>
            ${homeLink}
            ${calendarLink}
            <div class="action-chip chip-help" style="z-index: 20000;" onclick="openHelp('pulse')"><i class="fa fa-question"></i></div>
            <div class="action-chip chip-logout" onclick="location.href='portal?access_token=${state.accessToken}'"><i class="fa fa-users"></i></div>
        </div>
    </div>
    <div class="story-bar" id="story-bar-container"></div>
    <div id="installBanner" class="pwa-banner"><div><div style="font-weight:bold;">Install App</div><div style="font-size:12px; opacity:0.8;">Add to homescreen for fullscreen experience</div></div><div style="display:flex; gap:10px;"><button style="background:none; border:none; color:white; font-size:12px; font-weight:bold;" onclick="document.getElementById('installBanner').style.display='none'">Dismiss</button><button style="background:#FF6B6B; border:none; color:white; padding:5px 15px; border-radius:15px; font-weight:bold;" onclick="installPWA()">Install</button></div></div>
           ${getNavBarHtml()}
    
    <div class="container">
        <div class="side-col">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;"><div style="font-weight:800; color:#666; font-size:12px;">LEADERBOARDS</div><div class="visibility-toggle" onclick="toggleVisibility('Leaderboard')"><i class="fa fa-eye-slash"></i></div></div>
            <div id="sideColPlaceholder" class="hidden-placeholder" onclick="toggleVisibility('Leaderboard')">Leaderboards Hidden</div>
            <div id="sideColContent">
                <div class="lb-dropdown-btn" onclick="toggleLb('pollWrapper', 'iconPoll')"><span><i class="fa fa-poll"></i> Pulse Poll</span><i id="iconPoll" class="fa fa-chevron-down"></i></div>
                <div id="pollWrapper" class="lb-content lb-card" style="background:white; color:#333; display:block;"><div id="pollContainer" style="display:none;"></div></div>
                <div class="lb-dropdown-btn" onclick="toggleLb('lbHabits', 'iconHabits')"><span><i class="fa fa-check-circle"></i> Dailys</span><i id="iconHabits" class="fa fa-chevron-down"></i></div>
                <div id="lbHabits" class="lb-content lb-card" style="background:linear-gradient(135deg, #a55eea, #8854d0); display:block;">
                    <div id="habitRewardBanner" style="text-align:center; font-size:11px; color:#f1c40f; font-weight:800; margin-bottom:5px; background:rgba(0,0,0,0.2); padding:3px; border-radius:5px; display:none;">Reward: +100 XP & +20 Coins</div>
                    <div class="hab-row"><div>Posted Message</div><label class="switch"><input type="checkbox" id="h-post" disabled><span class="slider"></span></label></div>
                    <div class="hab-row"><div>Replied</div><label class="switch"><input type="checkbox" id="h-reply" disabled><span class="slider"></span></label></div>
                    <div class="hab-row"><div>Liked Post</div><label class="switch"><input type="checkbox" id="h-like" disabled><span class="slider"></span></label></div>
                    <div class="hab-row"><div>Arena Battle/Farm</div><label class="switch"><input type="checkbox" id="h-battle" disabled><span class="slider"></span></label></div>
                    <div class="hab-row"><div>Battel in Adventure</div><label class="switch"><input type="checkbox" id="h-adventure" disabled><span class="slider"></span></label></div>
                    <div class="hab-row"><div>Visited Shop</div><label class="switch"><input type="checkbox" id="h-shop" disabled><span class="slider"></span></label></div>
                    <div class="hab-row"><div>Tithe The Church</div><label class="switch"><input type="checkbox" id="h-tithe" disabled><span class="slider"></span></label></div>
                    <div class="hab-row"><div>Logged In</div><label class="switch"><input type="checkbox" id="h-login" disabled><span class="slider"></span></label></div>
                    <div class="hab-row"><div>Visited Hospital</div><label class="switch"><input type="checkbox" id="h-hospital" disabled><span class="slider"></span></label></div>
                    <div style="border-top:1px solid rgba(255,255,255,0.3); margin:10px 0; padding-top:10px; font-weight:800; font-size:12px; color:white;">‚öîÔ∏è Adventure Goals</div>
                    <div class="hab-row" id="goal-wilds"><div>Wilds Hunter (3 Wins)</div><div style="font-size:10px;">0/3</div></div>
                    <div class="hab-row" id="goal-spooky"><div>Spooky Hunter (3 Wins)</div><div style="font-size:10px;">0/3</div></div>
                    <div class="hab-row" id="goal-crazy"><div>Crazy House Master (6 Wins)</div><div style="font-size:10px;">0/6</div></div>
                    <div class="hab-row" id="goal-boss1"><div>Boss: Raven</div><div style="font-size:10px;"></div></div>
                    <div class="hab-row" id="goal-boss2"><div>Boss: Owl</div><div style="font-size:10px;"></div></div>
                    <div class="hab-row" id="goal-boss3"><div>Boss: Skeleton</div><div style="font-size:10px;"></div></div>
                    <div class="hab-row" id="goal-boss-farmer"><div>Boss: Crazy Farmer</div><div style="font-size:10px;"></div></div>
                </div>
                <div class="lb-dropdown-btn" onclick="toggleLb('lbChicken', 'iconChicken')"><span><i class="fa fa-crow"></i> Coop Leaders</span><i id="iconChicken" class="fa fa-chevron-right"></i></div><div id="lbChicken" class="lb-content lb-card" style="background:linear-gradient(135deg, rgba(230,126,34,0.9), rgba(243,156,18,0.9));"></div>
                <div class="lb-dropdown-btn" onclick="toggleLb('lbAdv', 'iconAdv')"><span><i class="fa fa-dungeon"></i> Adventure Legends</span><i id="iconAdv" class="fa fa-chevron-right"></i></div><div id="lbAdv" class="lb-content lb-card" style="background:linear-gradient(135deg, #8e44ad, #9b59b6);"></div>
                <div class="lb-dropdown-btn" onclick="toggleLb('lbCoins', 'iconCoins')"><span><i class="fa fa-coins"></i> Wealthiest</span><i id="iconCoins" class="fa fa-chevron-right"></i></div><div id="lbCoins" class="lb-content lb-card" style="background:linear-gradient(135deg, rgba(241,196,15,0.9), rgba(243,156,18,0.9));"></div>
                <div class="lb-dropdown-btn" onclick="toggleLb('lbPulse', 'iconPulse')"><span><i class="fa fa-heartbeat"></i> Weekly Pulse</span><i id="iconPulse" class="fa fa-chevron-right"></i></div><div id="lbPulse" class="lb-content lb-card" style="background:linear-gradient(135deg, rgba(9,132,227,0.9), rgba(116,185,255,0.9));"></div>
            </div>
        </div>
   
        <div class="feed-col">
            
            <div id="bulletinPlaceholder" class="hidden-placeholder" onclick="toggleVisibility('Bulletin')">Pinned Bulletin Hidden</div>
            <div id="bulletinArea" style="position:relative;"></div>
            
            <div class="card composer">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:5px;"><span style="font-size:12px; font-weight:bold; color:#777;">What's on your mind?</span><div style="display:flex; align-items:center;"><span style="font-size:10px; color:#999; margin-right:5px; font-weight:bold;">Refresh Feed/Data</span><i class="fa fa-sync" style="cursor:pointer; color:#999;" onclick="fetchData(true)" title="Refresh Feed/Data"></i></div></div>
                <textarea id="txtPost"></textarea>
                <select id="quickStatusSelect" class="status-dropdown" onchange="handleQuickStatus(this)">
                <option value="" disabled selected>üìç Quick Status...</option>
                </select>
                <div class="mood-row">
                    <div id="m-happy" class="mood-opt selected" onclick="setMood('happy')">üòÑ</div><div id="m-excited" class="mood-opt" onclick="setMood('excited')">ü§©</div><div id="m-tired" class="mood-opt" onclick="setMood('tired')">üò¥</div><div id="m-sad" class="mood-opt" onclick="setMood('sad')">üò¢</div><div id="m-sick" class="mood-opt" onclick="setMood('sick')">ü§¢</div><div id="m-relaxed" class="mood-opt" onclick="setMood('relaxed')">üòå</div><div id="m-angry" class="mood-opt" onclick="setMood('angry')">üò°</div><div id="m-silly" class="mood-opt" onclick="setMood('silly')">ü§™</div>
                </div>
                <div id="tools-row" class="tools-row">
                     <div id="admin-pin" class="pin-btn hidden" onclick="togglePin()"><i class="fa fa-thumbtack"></i> Pin as Bulletin</div>
                     <div id="admin-close-poll" class="pin-btn hidden" onclick="doClosePoll()"><i class="fa fa-times-circle"></i> Close Poll</div>
                </div>
                <div style="display:flex; gap:10px; margin-top:10px;">
                    <button class="btn btn-secondary" onclick="doMoodOnly()"><i class="fa fa-smile"></i> Mood Only</button>
                    <button id="btnPost" class="btn" style="flex:1;" onclick="doPost()">Share Update</button>
                </div>
            </div>
            <div id="feed-container"><div style="text-align:center; padding:40px; color:#999;"><i class="fa fa-circle-notch fa-spin"></i> Loading...</div></div>
        </div>
        </div>
    ${getAppJs()}
</body>
</html>
"""
        render contentType: "text/html", data: html
    } catch(e) { 
        log.error e
        render contentType:"text/html", data:"Error: ${e}" 
    }
}

def dailyReset() {
    log.info "Performing Family Pulse Daily Reset..."
    
    for(int i=1; i<=8; i++) {
        atomicState["dailys_${i}"] = [post:false, reply:false, like:false, battle:false, shop:false, login:false, hospital:false, adventure:false, tithe:false, collected:false]
        atomicState.remove("dailyFeeds_${i}")
        atomicState.remove("dailyShots_${i}")
        atomicState.remove("dailyEnergy_${i}")
        atomicState.remove("dailyHormones_${i}")
        atomicState.remove("dailySuperFeeds_${i}")
        atomicState.remove("dailyBossLures_${i}")
        atomicState.remove("dailyTithes_${i}")
        atomicState.remove("dailyInitiatedLosses_${i}")
        atomicState.remove("advLossCount_${i}") 
        atomicState.remove("isFarmerBadge_${i}")
        def prog = atomicState["advProgress_${i}"]
        if(prog) {

            prog.boss1 = false; prog.boss1Att = false       
            prog.boss2 = false; prog.boss2Att = false       
            prog.boss3 = false; prog.boss3Att = false       
            prog.bossFarmer = false; prog.bossFarmerAtt = 0      
            
            [cite_start]

            prog.wilds = 0 
            prog.spooky = 0
            prog.crazy = 0
            
            atomicState["advProgress_${i}"] = prog
        }
    }
    
    addPostToFeed(0, "system", "‚òÄÔ∏è <b>A new day has dawned!</b> Dailys, Shop Limits, and Bosses have reset.", "happy")
    
    atomicState.lastDailyResetDate = new Date().format("yyyy-MM-dd")
}

def checkSpecialEvents(force) {
    def cal = Calendar.getInstance()
    cal.setTime(new Date())
    def month = cal.get(Calendar.MONTH) + 1
    def day = cal.get(Calendar.DAY_OF_MONTH)
    def today = new Date().format("yyyy-MM-dd")
    
    if (!force && atomicState.lastEventCheck == today) return
    

    for(int i=1; i<=8; i++) {
        if(settings["userEnabled_${i}"]) {
            def bdayStr = settings["userBirthday_${i}"]
            if (bdayStr) {
                def parts = bdayStr.split("-")
                if (parts.length == 2 && parts[0].toInteger() == month && parts[1].toInteger() == day) {
                    def name = settings["userName_${i}"] ?: "User ${i}"
                    addPostToFeed(0, "system", "üéÇ <b>HAPPY BIRTHDAY ${name}!</b> Everyone wish them a great day! (Check feed for bonus)", "excited")
                }
            }
        }
    }
    atomicState.lastEventCheck = today
}

def downloadHubFile(String fileName) {
    try {
        def cleanName = fileName.replace(" ", "%20")
        
        def params = [
            uri: "http://127.0.0.1:8080",
            path: "/local/${cleanName}",
            contentType: "text/plain",
            textParser: true,
            headers: [
                "Cookie": "", 
                "Accept": "text/plain"
            ]
        ]
        
        def result = null
        
        httpGet(params) { resp ->
            if(resp.success) {

                def data = resp.data.getText() 

                def startIndex = data.indexOf("[")
                
                if (startIndex > -1) {
                    def cleanData = data.substring(startIndex)
                    result = cleanData.getBytes("UTF-8")
                } 
                else if(data.trim().startsWith("<") || data.contains("login")) {
                    log.error "Family Pulse: BLOCKED. Hub returned HTML/Login page for '${fileName}'."
                } 
                else {
                    log.warn "Family Pulse: File '${fileName}' loaded but contained no JSON brackets [ ]. Content: ${data.take(50)}..."
                }
            } else {
                log.warn "Family Pulse: File '${fileName}' not found (Status: ${resp.status})"
            }
        }
        return result
    } catch (e) {
        if (e.message.contains("404")) {
            log.warn "Family Pulse: File '${fileName}' does not exist in File Manager. Please check capitalization exactly."
        } else {
            log.error "Family Pulse: File System Error - ${e}"
        }
        return null
    }
}
    def handleSportEvent() {
    def uid = params.uid.toInteger()
    def type = params.eventType 
    def mood = params.mood
    
    def xp = 0
    def coins = 0
    def title = "Sports Update"
    def sub = ""
    def notifMsg = "" 
    
    if (type == "start") {
        xp = 10; coins = 10
        title = "Event Started!"
        sub = "Game On! (+10 XP / +10 Coins)"
        notifMsg = "üèÖ Started Event: +10 XP & +10 Coins"
    } 
    else if (type == "finish") {
        xp = 25; coins = 25
        title = "Event Finished!"
        sub = "Victory Lap! (+25 XP / +25 Coins)"
        notifMsg = "üèÅ Finished Event: +25 XP & +25 Coins"
    } 
    else if (type == "trophy") {
        render contentType: "application/json", data: JsonOutput.toJson([status: "ignored"])
        return
    }

    if (mood) atomicState["mood_${uid}"] = mood
    incrementWeeklyCount(uid)
    
    if (xp > 0) addChickenXp(uid, xp)
    if (coins > 0) adjustCoins(uid, coins)
    
    // --- NEW: Save Pending Reward for the Popup ---
    if(xp > 0 || coins > 0) {
        atomicState["pendingReward_${uid}"] = [
            title: title,
            sub: sub,
            xp: xp,
            coins: coins
        ]
    }
    // ----------------------------------------------

    addPostToFeed(uid, "status", params.msg, mood)
    addNotification(uid, notifMsg)
    checkDaily(uid, "post")
    
    render contentType: "application/json", data: JsonOutput.toJson([status: "success", xp: xp, coins: coins, title: title, sub: sub])
}

def handleDogEventLogic(force) {

    if (!force && Math.random() < 0.5) return 

    def users = getUsersList()
    if (!users) { log.warn "Dog Event: No users found."; return }


    def validVictims = users.findAll { !atomicState["isWounded_${it.id}"] }

    if (validVictims.size() == 0) {
        log.warn "Dog Event: All chickens are unconscious! The dog wanders home."
        return
    }

    def victim = validVictims[new Random().nextInt(validVictims.size())]
    def uid = victim.id
    def c = getChickenData(uid)
    def cName = c.name ?: "Unknown Chicken"
    
    def rnd = Math.random()
    
    if (rnd < 0.50) {
        def lostCoins = 25
        if ((c.coins ?: 0) >= lostCoins) {
            adjustCoins(uid, -lostCoins)
            addPostToFeed(0, "system", "üêï <b>WOOF!</b> The Farmer's Dog chased <b>${cName}</b>! They dropped <b>${lostCoins} coins</b>!", "surprised")
            addNotification(uid, "üêï The Farmer's Dog chased you! You dropped ${lostCoins} coins.")
        } else {
             addPostToFeed(0, "system", "üêï <b>ZOOM!</b> The Farmer's Dog chased <b>${cName}</b> around the barn!", "tired")
        }
    } 
    else {
        addChickenXp(uid, 40)
        addPostToFeed(0, "system", "üêï <b>GOOD BOY!</b> <b>${cName}</b> played fetch with the Farmer's Dog! (<b>+40 XP</b>)", "happy")
        addNotification(uid, "ü¶¥ You played with the Farmer's Dog! +40 XP")
    }
}

def scheduledWifeCheck() { handleWifeEventLogic(false) }
def handleWifeEvent() { handleWifeEventLogic(true); render contentType:"application/json", data:groovy.json.JsonOutput.toJson([status:"success"]) }

def handleWifeEventLogic(force) {
    if (!force && Math.random() > 0.05) return 

    def users = getUsersList()
    def valid = users.findAll { !atomicState["isWounded_${it.id}"] } // She only visits healthy chickens
    
    if (!valid) { log.warn "Wife Event: No valid users."; return }

    def winner = valid[new Random().nextInt(valid.size())]
    def uid = winner.id
    def c = getChickenData(uid)
    def cName = c.name ?: "Unknown Chicken"
    
    def rnd = Math.random()
    def item = ""
    

    if (!c.inventory) c.inventory = [feed:0]
    
    if (rnd < 0.80) {

        c.inventory.feed = (c.inventory.feed ?: 0) + 1
        item = "Chicken Feed üåΩ"
    } else {

        c.inventory.super_feed = (c.inventory.super_feed ?: 0) + 1
        item = "Super Feed üåü"
    }
    
    atomicState["chicken_${uid}"] = c 
    

    addPostToFeed(0, "system", "üëµ <b>The Farmer's Wife</b> stopped by! " +
        "She thought <b>${cName}</b> looked skinny and gave them <b>${item}</b>!", "happy") 
        
    addNotification(uid, "üëµ The Farmer's Wife gave you ${item}!") 
}      
def getAppCss() {
    return """
        :root { --primary: #FF6B6B; --gradient: linear-gradient(135deg, #FF6B6B 0%, #FF8E53 100%); --bg: #f4f6f8; --card-bg: #ffffff; --text: #2d3436; --chicken-bg: linear-gradient(135deg, #f1c40f 0%, #e67e22 100%); }
        body { background: var(--bg); margin: 0; padding: 0; font-family: 'Nunito', sans-serif; -webkit-tap-highlight-color: transparent; color: var(--text); padding-bottom: 80px; }
        .header { position: sticky; top: 0; z-index: 100; background: linear-gradient(90deg, #FF6B6B 0%, #FF8E53 100%); height: 140px; backdrop-filter: blur(8px); border-bottom: 1px solid rgba(0,0,0,0.05); padding: 0 20px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 4px 15px rgba(0,0,0,0.1); box-sizing: border-box; }
        .brand { font-size: 24px; font-weight: 900; background: none; color: white; display:flex; flex-direction:column; align-items:flex-start; }
        .brand-main { display:flex; align-items:center; gap:8px; }
        .brand i { color: white; animation: pulseHeart 1.5s infinite; }
        .header-actions { display:flex; gap:8px; flex-wrap:wrap; justify-content:flex-end; align-items:center; }
     .action-chip { background: rgba(255, 255, 255, 0.25); border: 1px solid rgba(255, 255, 255, 0.4); padding: 6px 14px; border-radius: 20px; font-weight: 800; font-size: 13px; cursor: pointer; display: flex; align-items: center; gap: 6px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); transition: 0.2s; color: white; backdrop-filter: blur(4px); }
        .action-chip:hover { background: rgba(255, 255, 255, 0.35); transform: translateY(-1px); }
        .action-chip:active { transform: translateY(2px); background: rgba(255, 255, 255, 0.15); }
        .action-chip i, .chip-help i, .chip-logout i, .chip-dash i { color: white !important; }
        @keyframes pulseHeart { 0% {transform:scale(1);} 50% {transform:scale(1.2);} 100% {transform:scale(1);} }
        .story-bar { background: white; padding: 25px 0 20px 20px; overflow-x: auto; white-space: nowrap; scrollbar-width: none; box-shadow: 0 4px 15px rgba(0,0,0,0.02); }
        .story-bar::-webkit-scrollbar { display: none; }
        .story-item { display: inline-flex; flex-direction: column; align-items: center; margin-right: 18px; cursor: pointer; transition: 0.3s; position: relative; }
        .story-item.active { transform: scale(1.05); } 
        .avatar-ring { width: 56px; height: 56px; border-radius: 50%; padding: 2px; background: #eee; transition: 0.3s; position: relative; }
        .story-item.active .avatar-ring { background: var(--gradient); box-shadow: 0 4px 10px rgba(255, 107, 107, 0.3); }
        .avatar { width: 100%; height: 100%; border-radius: 50%; background: white; border: 2px solid white; display: flex; align-items: center; justify-content: center; font-size: 26px; }
        .story-name { margin-top: 6px; font-size: 11px; font-weight: 700; color: #636e72; }
        .edit-badge { position: absolute; top: -5px; right: -5px; background: #2d3436; color: white; border: 2px solid white; width: 20px; height: 20px; border-radius: 50%; font-size: 10px; display: flex; align-items: center; justify-content: center; z-index: 50; box-shadow: 0 2px 5px rgba(0,0,0,0.2); }
        .mood-badge { position: absolute; bottom: -2px; left: -2px; width: 20px; height: 20px; background: white; border-radius: 50%; font-size: 14px; display: flex; align-items: center; justify-content: center; box-shadow: 0 2px 5px rgba(0,0,0,0.1); z-index: 6; }
        .online-badge { position: absolute; top: 0px; right: 0px; background: #2ecc71; border: 2px solid white; width: 14px; height: 14px; border-radius: 50%; z-index:5; display:none; }
        .online-badge.is-online { display:block; }
        .crown-badge { position: absolute; top: -16px; left: 50%; transform: translateX(-50%); color: #f1c40f; font-size: 24px; filter: drop-shadow(0 2px 2px rgba(0,0,0,0.2)); animation: bounce 2s infinite; z-index: 10; }
        .holiday-badge { position: absolute; top: -15px; right: -5px; font-size: 20px; z-index: 15; animation: bounce 3s infinite; }
        .farmer-badge { position: absolute; bottom: -5px; left: -8px; font-size: 22px; z-index: 21; filter: drop-shadow(0 2px 2px rgba(0,0,0,0.3)); animation: shake 3s infinite; }
        .admin-badge { position: absolute; bottom: -5px; right: -5px; background: #3498db; color: white; border: 2px solid white; width: 22px; height: 22px; border-radius: 50%; font-size: 12px; display: flex; align-items: center; justify-content: center; z-index: 10; box-shadow: 0 2px 5px rgba(0,0,0,0.2); }
        .nav-bar { background:white; padding:10px; display:flex; gap:10px; justify-content:space-around; border-bottom:1px solid #eee; margin-bottom:20px; overflow-x:auto; }
        .nav-item { flex:1; text-align:center; padding:10px; border-radius:12px; font-weight:800; font-size:12px; color:#555; background:#f8f9fa; cursor:pointer; display:flex; flex-direction:column; align-items:center; gap:5px; border:1px solid #eee; min-width:60px; }
        .nav-item:hover { background:#f0f0f0; border-color:#ddd; }
        .nav-item i { font-size:16px; margin-bottom:2px; }
        .pwa-banner { display:none; background:#2d3436; color:white; padding:15px; align-items:center; justify-content:space-between; position:fixed; bottom:0; left:0; width:100%; z-index:9000; box-sizing:border-box; box-shadow:0 -5px 15px rgba(0,0,0,0.2); }
        .container { max-width: 950px; margin: 0 auto; padding: 0 15px; display: flex; gap: 20px; align-items: flex-start; }
        .feed-col { flex: 1; min-width: 0; } .side-col { width: 280px; position: sticky; top: 90px; }
        @media (max-width: 850px) { .container { flex-direction: column; } .side-col { width: 100%; position: static; order: -1; margin-bottom: 20px; } }
        .card { background: var(--card-bg); border-radius: 16px; padding: 18px; margin-bottom: 20px; box-shadow: 0 4px 20px rgba(0,0,0,0.04); transition: transform 0.2s; position: relative;}
        .feed-header { display: flex; align-items: center; margin-bottom: 8px; }
        .feed-avatar { width: 42px; height: 42px; border-radius: 50%; background: #eee; display: flex; align-items: center; justify-content: center; font-size: 22px; margin-right: 12px; }
        .feed-meta h4 { margin: 0; font-size: 15px; font-weight: 800; } .feed-meta span { font-size: 11px; color: #999; font-weight: 600; text-transform: uppercase; }
        .feed-body { font-size: 15px; line-height: 1.5; color: #444; padding-left: 54px; word-break: break-word; }
        .composer textarea { width: 100%; border: none; background: #f8f9fa; border-radius: 12px; padding: 15px; font-family: inherit; font-size: 15px; resize: none; outline: none; box-sizing: border-box; min-height: 60px; }
        .composer textarea:focus { background: #fff; box-shadow: inset 0 0 0 2px #ffeaa7; }
        .mood-row { display: flex; gap: 15px; margin-top: 15px; justify-content: center; flex-wrap: wrap; }
        .mood-opt { font-size: 24px; opacity: 0.4; cursor: pointer; transition: 0.2s; filter: grayscale(80%); }
        .mood-opt.selected { opacity: 1.0; transform: scale(1.2); filter: grayscale(0%); }
        .status-dropdown { width: 100%; padding: 10px; border-radius: 12px; border: 1px solid #eee; background: #f1f2f6; color: #555; font-size: 14px; font-weight: 700; margin-top: 10px; cursor: pointer; outline: none; -webkit-appearance: none; -moz-appearance: none; appearance: none; background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%23555' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6 9 12 15 18 9'%3e%3c/polyline%3e%3c/svg%3e"); background-repeat: no-repeat; background-position: right 15px center; background-size: 16px; }
        .btn { background: var(--gradient); color: white; border: none; padding: 12px; border-radius: 12px; width: 100%; font-weight: 800; font-size: 14px; letter-spacing: 0.5px; margin-top: 15px; cursor: pointer; box-shadow: 0 4px 15px rgba(255, 107, 107, 0.25); transition: 0.2s; }
        .btn:active { transform: scale(0.98); } .btn:disabled { background: #ccc; cursor: default; box-shadow: none; }
        .btn-disabled { background: #ccc !important; pointer-events: none; opacity: 0.6; box-shadow: none !important; }
        .btn-secondary { background: white; color: #555; border: 2px solid #eee; width:auto; padding: 10px; font-size: 12px; margin-top: 15px; box-shadow:none; }
        .btn-secondary:hover { border-color: #ddd; color: #333; }
        .replies { margin-top: 15px; background: #f8f9fa; border-radius: 10px; padding: 12px; margin-left: 54px; font-size: 13px; }
        .reply-item { margin-bottom: 6px; padding-bottom: 6px; border-bottom: 1px dashed #eee; display: flex; gap: 5px; flex-direction:column;} .reply-item:last-child { border: none; margin: 0; padding: 0; }
        .action-row { display:flex; align-items:center; gap:20px; margin-top:10px; padding-left:54px; }
        .action-item { font-size: 12px; font-weight: 700; color: #999; cursor: pointer; display: flex; align-items: center; gap: 5px; position:relative; }
        .action-item:hover { color: var(--primary); }
        .reply-actions { display:flex; gap:10px; margin-left:5px; }
        .reply-btn { cursor:pointer; font-size:12px; color:#bbb; opacity:0.3; transition:0.2s; filter:grayscale(100%); }
        .reply-btn.hover { opacity:1; filter:grayscale(0%); } .reply-btn.active { opacity:1; filter:grayscale(0%); font-weight:bold; }
        .reply-btn.up { color:#2ecc71; } .reply-btn.down { color:#e74c3c; } 
        .emote-picker { position: absolute; bottom: 25px; left: -10px; background: white; padding: 5px; border-radius: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.2); display: none; align-items: center; gap: 5px; z-index:50; }
        .emote-picker.show { display: flex; animation: fadeIn 0.2s; }
        .emote-opt { font-size: 20px; cursor: pointer; transition: 0.2s; padding:2px; } .emote-opt:hover { transform: scale(1.3); }
        .lb-card { padding:15px; border-radius:12px; margin-bottom:10px; color:white; }
        .lb-dropdown-btn { width: 100%; padding: 12px; background: white; border: 1px solid #eee; border-radius: 12px; color: var(--primary); font-weight: 800; cursor: pointer; text-align: left; display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; box-shadow: 0 4px 15px rgba(0,0,0,0.02); }
        .lb-content { display: none; }
        .lb-row { display: flex; align-items: center; padding: 8px 0; border-bottom: 1px solid rgba(255,255,255,0.2); }
        .lb-rank { width: 25px; text-align: center; margin-right: 10px; font-size: 16px; }
        .lb-info { flex: 1; } .lb-name { font-size: 13px; font-weight: 700; color: white; } .lb-sub { font-size: 11px; color: rgba(255,255,255,0.8); }
        .visibility-toggle { cursor: pointer; font-size: 12px; color: #999; display:inline-block; } .visibility-toggle:hover { color: var(--primary); }
        .hidden-placeholder { background: white; padding: 10px; border-radius: 12px; text-align: center; border: 1px dashed #ccc; color: #999; font-size: 12px; cursor: pointer; margin-bottom: 20px; font-weight: bold; display: none; }
        .tools-row { display: flex; align-items: center; margin-top: 10px; padding-top: 10px; border-top: 1px solid #eee; gap:10px; flex-wrap:wrap;}
        .pin-btn { font-size: 12px; font-weight: 700; color: #999; cursor: pointer; display: flex; align-items: center; gap: 5px; transition: 0.2s; }
        .pin-btn.active { color: #d35400; } .pin-btn:hover { color:var(--primary); }
        .grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 10px; margin-top: 20px; }
        .grid-item { font-size: 26px; padding: 8px; border-radius: 8px; cursor: pointer; transition: 0.2s; } .grid-item:hover { background: #eee; transform: scale(1.1); }
        .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); backdrop-filter: blur(5px); z-index: 10000; display: none; align-items: center; justify-content: center; }
        .modal-content { background: white; width: 90%; max-width: 340px; border-radius: 24px; padding: 25px; text-align: center; box-shadow: 0 10px 40px rgba(0,0,0,0.3); max-height: 80vh; overflow-y: auto; position:relative; }
        .modal-help-btn { position: absolute; top: 15px; right: 15px; width: 24px; height: 24px; border-radius: 50%; background: #eee; color: #555; display: flex; align-items: center; justify-content: center; cursor: pointer; font-weight: bold; font-size: 14px; }
        .hidden { display: none !important; }
        .chicken-header { display: flex; align-items: center; gap: 10px; margin-bottom: 15px; }
        .chicken-icon { width: 60px; height: 60px; background: var(--chicken-bg); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 30px; box-shadow: 0 4px 10px rgba(230,126,34,0.4); }
        .coop-help-icon { position:absolute; top:15px; right:15px; color:#e67e22; font-size:18px; cursor:pointer; }
        .stat-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 15px; }
        .stat-box { background: white; padding: 8px; border-radius: 8px; text-align: center; border: 1px solid #eee; }
        .stat-val { font-weight: 800; font-size: 16px; color: #2d3436; } .stat-lbl { font-size: 10px; text-transform: uppercase; color: #999; font-weight: 700; }
        .battle-hud { display:flex; justify-content:space-between; margin-bottom:15px; align-items:flex-end; }
        .hud-side { width: 45%; } .hud-name { font-size:11px; font-weight:800; color:#555; margin-bottom:3px; }
        .hp-bar-outer { width:100%; height:14px; background:#ddd; border-radius:7px; overflow:hidden; position:relative; box-shadow:inset 0 1px 3px rgba(0,0,0,0.1); }
        .hp-bar-inner { height:100%; width:100%; background:#2ecc71; transition:width 0.3s; }
        .battle-anim-container { height: 80px; display:flex; justify-content:space-between; align-items:center; margin-bottom:10px; position:relative; overflow:hidden; padding:0 20px; }
        @keyframes lungeRight { 0% {transform: translateX(0);} 50% {transform: translateX(40px);} 100% {transform: translateX(0);} }
        @keyframes lungeLeft { 0% {transform: translateX(0);} 50% {transform: translateX(-40px);} 100% {transform: translateX(0);} }
        @keyframes shake { 0%, 100% {transform: translateX(0);} 25% {transform: translateX(-5px) rotate(-5deg);} 75% {transform: translateX(5px) rotate(5deg);} }
        @keyframes bigShake { 0%, 100% {transform: scale(1);} 25% {transform: scale(1.2) rotate(-10deg);} 75% {transform: scale(1.2) rotate(10deg);} }
        @keyframes fadeUp { 0% {opacity:1; transform:translateY(0);} 100% {opacity:0; transform:translateY(-30px);} }
        @keyframes bossDefeat { 0% {transform:scale(0); opacity:0;} 50% {transform:scale(1.2); opacity:1;} 100% {transform:scale(1); opacity:1;} }
        .anim-lunge-r { animation: lungeRight 0.3s ease-in-out; }
        .anim-lunge-l { animation: lungeLeft 0.3s ease-in-out; }
        .anim-hit { animation: shake 0.4s ease-in-out; }
        .anim-crush { animation: bigShake 0.5s ease-in-out; filter: drop-shadow(0 0 10px red); }
        .anim-miss { opacity: 0.5; }
        .log-win { color: #27ae60; font-weight:bold; } .log-dmg { color: #e74c3c; font-weight:bold; } .log-crit { color: #f1c40f; font-weight:bold; }
        .farm-btn { background: linear-gradient(to bottom, #2ecc71 0%, #27ae60 80%); border-bottom: 5px solid #d35400; width: 100%; padding: 12px; border-radius: 10px; color: white; border-top: none; border-left: none; border-right: none; font-weight: 800; margin-top: 10px; cursor: pointer; }
        .help-section { text-align: left; margin-bottom: 15px; padding-bottom: 10px; border-bottom: 1px dashed #eee; }
        .help-title { font-weight: 800; color: var(--primary); font-size: 14px; margin-bottom: 5px; }
        @keyframes fadeIn { from {opacity:0; transform:translateY(5px);} to {opacity:1; transform:translateY(0);} }
        @keyframes popIn { from {opacity:0; transform:scale(0.8);} to {opacity:1; transform:scale(1);} }
        .farm-scene { position: relative; height: 100px; width: 100%; overflow: hidden; display: none; align-items:center; justify-content:center; }
        .farm-scene.active { display: flex; }
        .farm-chicken { font-size: 50px; position: absolute; left: 0; animation: walkToBarn 2s forwards linear; z-index:2; }
        .farm-barn { font-size: 50px; position: absolute; right: 20px; }
        @keyframes walkToBarn { 0% { left: 0; transform:scaleX(-1); } 100% { left: 70%; transform:scaleX(-1); } }
        .hp-text { font-size: 10px; font-weight: bold; text-align: center; margin-top: 2px; color: #555; }
        .timer-text { font-size:11px; font-weight:bold; color:#555; background:rgba(255,255,255,0.7); padding:3px 8px; border-radius:10px; }
        .reward-popup { animation: popIn 0.5s ease-out; z-index: 5000; position:relative; }
        .reward-icon { font-size:50px; margin-bottom:10px; animation:bounce 1s infinite; display:inline-block; }
        .shop-item { display:flex; align-items:center; padding:10px; background:#f4f6f8; border-radius:12px; margin-bottom:10px; }
        .item-icon { font-size:30px; margin-right:15px; } .item-details { flex:1; text-align:left; }
        .welcome-metric { display:flex; align-items:center; margin-bottom:8px; padding:5px; border-bottom:1px dashed #eee; }
        .wm-icon { font-size:20px; margin-right:10px; width:30px; text-align:center; } .wm-text { font-size:14px; font-weight:bold; color:#555; }
        .wm-val { margin-left:auto; font-weight:900; color:#2d3436; background:#eee; padding:2px 8px; border-radius:10px; font-size:12px; }
        .switch{position:relative;display:inline-block;width:34px;height:20px;margin-left:auto}
        .switch input{opacity:0;width:0;height:0}
        .slider{position:absolute;cursor:pointer;top:0;left:0;right:0;bottom:0;background-color:rgba(0,0,0,0.2);transition:.4s;border-radius:34px}
        .slider:before{position:absolute;content:"";height:14px;width:14px;left:3px;bottom:3px;background-color:white;transition:.4s;border-radius:50%}
        input:checked + .slider{background-color:#2ecc71}
        input:checked + .slider:before{transform:translateX(14px)}
        .hab-row{display:flex;align-items:center;margin-bottom:8px;color:white;font-weight:700;font-size:13px}
        .tr-btn { cursor:pointer; background:#2ecc71; color:white; border-radius:4px; padding:0 5px; font-size:12px; font-weight:bold; margin-left:5px; display:inline-block;}
        .tr-btn:hover { background:#27ae60; }
        .disabled-habit { opacity: 0.5; pointer-events: none; }
        .tired-tag { color: white; background: #e74c3c; padding: 2px 6px; border-radius: 8px; font-size: 10px; font-weight: bold; margin-left: 5px; }
        .bonus-section { margin-top:15px; padding-top:10px; border-top:1px solid rgba(255,255,255,0.2); }
        .adv-card { background:#f4f6f8; border-radius:12px; padding:15px; margin-bottom:10px; text-align:center; border:2px dashed #9b59b6; }
        .poll-card { padding: 10px; } .poll-q { font-weight: 800; color: #2d3436; margin-bottom: 10px; font-size: 13px; }
        .poll-opt { border: 1px solid #eee; padding: 10px; border-radius: 8px; margin-bottom: 8px; cursor: pointer; transition: 0.2s; font-size: 12px; font-weight: bold; color: #555; display:flex; justify-content:space-between; align-items:center;}
        .poll-opt:hover { background: #f9f9f9; border-color: #ddd; }
        .poll-opt.voted { border-color: var(--primary); background: #fff0f0; color: var(--primary); }
        .poll-res-row { margin-bottom: 8px; } .poll-res-txt { font-size: 11px; font-weight: bold; display: flex; justify-content: space-between; margin-bottom: 3px; }
        .poll-bar-bg { width: 100%; height: 8px; background: #eee; border-radius: 4px; overflow: hidden; }
        .poll-bar-fill { height: 100%; background: linear-gradient(90deg, #0984e3, #74b9ff); border-radius: 4px; transition: width 0.5s ease; }
        .poll-closed-badge { background: #636e72; color: white; padding: 2px 6px; border-radius: 4px; font-size: 9px; text-transform: uppercase; float: right; }
        .adv-zone-btn { background: white; border: 2px solid #eee; border-radius: 12px; padding: 10px; margin-bottom: 8px; cursor: pointer; display: flex; align-items: center; transition: 0.2s; }
        .adv-zone-btn:hover { border-color: #9b59b6; background: #fdf5ff; }
        .adv-zone-btn.locked { opacity: 0.5; pointer-events: none; filter: grayscale(100%); }
        .adv-icon { font-size: 24px; margin-right: 15px; }
        .adv-info h4 { margin:0; font-size:14px; font-weight:800; color:#333; }
        .adv-info p { margin:0; font-size:10px; color:#888; }
        .revive-popup { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 30px; border-radius: 20px; box-shadow: 0 0 50px rgba(46, 204, 113, 0.5); z-index: 6000; text-align: center; display: none; border: 4px solid #2ecc71; }
        .loss-popup { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 30px; border-radius: 20px; box-shadow: 0 0 50px rgba(231, 76, 60, 0.5); z-index: 6000; text-align: center; display: none; border: 4px solid #e74c3c; width: 80%; max-width: 300px; }
        .unconscious-popup { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 30px; border-radius: 20px; box-shadow: 0 0 50px rgba(192, 57, 43, 0.5); z-index: 7000; text-align: center; display: none; border: 4px solid #c0392b; width: 80%; max-width: 300px; }
        .completed-boss { background: #dff9fb; border-color: #81ecec; pointer-events:none; opacity:0.7; }
        .hp-mini-bar { width: 100%; height: 6px; background: #ddd; border-radius: 3px; margin-top: 5px; overflow: hidden; }
        .hp-mini-fill { height: 100%; background: #2ecc71; }
        .boss-overlay { position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.85); z-index:9999; display:none; flex-direction:column; align-items:center; justify-content:center; color:white; }
        .boss-txt { font-size:40px; font-weight:900; color:#f1c40f; text-transform:uppercase; animation: bossDefeat 1s forwards; text-shadow:0 0 20px rgba(241, 196, 15, 0.5); text-align:center; }
        .boss-sub { font-size:16px; margin-top:20px; opacity:0; animation: fadeIn 1s 1s forwards; }
    """
}

def getNavBarHtml() {
    return """
    <div class="nav-bar">
        <div class="nav-item" onclick="playSound('click'); openShop()"><i class="fa fa-store" style="color:#00b894;"></i> Shop</div>
        <div class="nav-item" onclick="playSound('click'); openAdventure()"><i class="fa fa-dungeon" style="color:#9b59b6;"></i> Adventure</div>
        <div class="nav-item" onclick="playSound('click'); openForaging()"><i class="fa fa-leaf" style="color:#2ecc71;"></i> Forage</div>
        <div class="nav-item" onclick="playSound('click'); openCoop()"><i class="fa fa-egg" style="color:#e67e22;"></i> Coop</div>
        <div class="nav-item" onclick="playSound('click'); openHospital()"><i class="fa fa-ambulance" style="color:#e74c3c;"></i> Hospital</div>
        <div class="nav-item" onclick="playSound('click'); openChurch()"><i class="fa fa-church" style="color:#3498db;"></i> Church</div>
    </div>
    """
}

def getChurchModalHtml() {
    return """
    <div id="churchModal" class="modal" onclick="closeModal()"><div class="modal-content" onclick="event.stopPropagation()">
        <div style="font-size:60px; margin-bottom:10px;">‚õ™</div>
        <h2 style="margin:0; color:#3498db;">The Church</h2>
        
        <div style="background:#f4f6f8; padding:15px; border-radius:12px; margin:15px 0; border-left:4px solid #3498db; text-align:left;">
            <p id="churchQuoteText" style="font-style:italic; font-weight:bold; color:#555; font-size:14px; margin:0;">Loading...</p>
        </div>
        
        <div style="background:#eaf6ff; padding:15px; border-radius:12px; margin-bottom:15px; border:1px dashed #3498db;">
            <div style="font-weight:bold; color:#2980b9; margin-bottom:5px;">Tithing</div>
            <div style="font-size:11px; color:#555; margin-bottom:10px;">Give 50 coins for a chance at a blessing. (10% Odds)</div>
            <button id="btnTitheAction" class="btn" style="background:#3498db;" onclick="openTitheConfirm()">Tithe (50 üí∞)</button>
        </div>

        <p style="color:#666; font-size:12px; margin-bottom:15px;">A quiet place to rest your spirit.</p>
        <button class="btn btn-secondary" onclick="closeModal()">Amen</button>
    </div></div>

    <div id="titheConfirmModal" class="modal" style="z-index:12000;">
        <div class="modal-content">
            <div style="font-size:40px; margin-bottom:10px; color:#f1c40f;">
                <i class="fa fa-coins"></i>
            </div>
            <h3 style="color:#555; margin:0;">Tithe 50 Coins?</h3>
            <p style="font-size:12px; color:#999; margin-bottom:20px;">You are giving this freely. There is no guarantee of a reward.</p>
            <div style="display:flex; gap:10px;">
                <button class="btn btn-secondary" style="flex:1; margin-top:0;" onclick="document.getElementById('titheConfirmModal').style.display='none'">
                    Cancel
                </button>
                <button class="btn" style="flex:1; margin-top:0; background:#3498db;" onclick="confirmTitheAction()">
                    <i class="fa fa-hand-holding-heart"></i> Give
                </button>
            </div>
        </div>
    </div>

    <div id="titheLoseModal" class="modal" style="z-index:12100;"><div class="modal-content" style="border:4px solid #95a5a6;">
        <div style="font-size:60px; margin-bottom:10px;">üïäÔ∏è</div>
        <h2 style="margin:0; color:#7f8c8d;">Peace Be With You</h2>
        <p style="color:#555; margin:15px 0;">You placed 50 coins in the offering plate.</p>
        <p style="font-size:12px; color:#999;">The air is silent. No items appeared, but you feel generous.</p>
        <button class="btn" style="background:#95a5a6;" onclick="document.getElementById('titheLoseModal').style.display='none'">Close</button>
    </div></div>
    """
}

def getAppJsPart1() {
    return """
    <script>
        const TOKEN = "${state.accessToken}"; const UID = ${params.asUser}; let appData = null; let lastTs = 0; let selectedMood = 'happy'; let isBattling = false; let isPinned = false; let logoutTime = 300; let firstLoad = true; let rewardQueue = []; let prevDailyState = false; let deferredPrompt = null; let pendingVoteId = null;
        
        const AudioContext = window.AudioContext || window.webkitAudioContext;
        const audioCtx = new AudioContext();

        function playSound(type) {
            if (audioCtx.state === 'suspended') { audioCtx.resume(); }
            const t = audioCtx.currentTime;
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            osc.connect(gain); gain.connect(audioCtx.destination);

            if (type === 'click') {
                osc.type = 'sine';
                osc.frequency.setValueAtTime(800, t); osc.frequency.exponentialRampToValueAtTime(1200, t + 0.1); gain.gain.setValueAtTime(0.1, t); gain.gain.exponentialRampToValueAtTime(0.01, t + 0.1); osc.start(t); osc.stop(t + 0.1);
            } 
            else if (type === 'coin') {
                osc.type = 'square';
                gain.gain.value = 0.1; osc.frequency.setValueAtTime(987, t); osc.frequency.setValueAtTime(1318, t + 0.08); gain.gain.setValueAtTime(0.1, t); gain.gain.exponentialRampToValueAtTime(0.01, t + 0.5); osc.start(t); osc.stop(t + 0.5);
            } 
            else if (type === 'hit') {
                osc.type = 'sawtooth';
                osc.frequency.setValueAtTime(150, t); osc.frequency.exponentialRampToValueAtTime(0.01, t + 0.2); gain.gain.setValueAtTime(0.2, t); gain.gain.exponentialRampToValueAtTime(0.01, t + 0.2); osc.start(t); osc.stop(t + 0.2);
            }
            else if (type === 'win') {
                playNote(523.25, t, 0.1, 'triangle');
                playNote(659.25, t + 0.1, 0.1, 'triangle'); playNote(783.99, t + 0.2, 0.1, 'triangle'); playNote(1046.50, t + 0.3, 0.4, 'square');
            }
            else if (type === 'lose') {
                osc.type = 'sawtooth';
                osc.frequency.setValueAtTime(400, t); osc.frequency.linearRampToValueAtTime(100, t + 0.6); gain.gain.setValueAtTime(0.2, t); gain.gain.linearRampToValueAtTime(0.01, t + 0.6); osc.start(t); osc.stop(t + 0.6);
            }
        }
        function playNote(freq, time, dur, type) {
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain(); osc.connect(gain); gain.connect(audioCtx.destination); osc.type = type; osc.frequency.setValueAtTime(freq, time); gain.gain.setValueAtTime(0.1, time); gain.gain.exponentialRampToValueAtTime(0.01, time + dur); osc.start(time);
            osc.stop(time + dur);
        }
        
        window.addEventListener('beforeinstallprompt', (e) => { e.preventDefault(); deferredPrompt = e; document.getElementById('installBanner').style.display='flex'; });
        function installPWA(){ if(deferredPrompt){ deferredPrompt.prompt(); deferredPrompt.userChoice.then((c)=>{ if(c.outcome==='accepted'){console.log('Accepted');} deferredPrompt=null; document.getElementById('installBanner').style.display='none'; }); } }
        function getApiBase() { let path = window.location.pathname;
        let base = path.substring(0, path.lastIndexOf('/')); return window.location.origin + base; }
        
        // Changed endpoint from '/logout' to '/portal' to redirect to User Select screen
        function doLogout() { window.location.href = getApiBase() + "/portal?access_token=" + TOKEN; }

        function fetchData(force) {
            if(isBattling) return;
            let url = `\${getApiBase()}/api/data?access_token=\${TOKEN}&uid=\${UID}&_t=\${new Date().getTime()}`;
            if(firstLoad) url += "&init=true";
            fetch(url).then(r => r.json()).then(data => {
                if(data && (data.ts > lastTs || firstLoad || force)) {
                    appData = data; lastTs = data.ts;
                    let currentDaily = appData.me.dailys.collected;
                    
                    // Existing Daily Bonus Check
                    if(!firstLoad && appData.me.dailys.collected === true && prevDailyState === false) { showReward(100, 20, "Dailys Complete!", "All tasks finished!"); }
                    prevDailyState = currentDaily; renderAll();
                    
                    let hasNotifs = (appData.me.welcome.notifs && appData.me.welcome.notifs.length > 0);
                    if(firstLoad || hasNotifs) { 
                        checkWelcome(); 
                    }
                    firstLoad = false;

                    // Existing Farm Check
                    if(appData.me.pendingFarm !== null && appData.me.pendingFarm !== undefined) {
                        document.getElementById('farmModal').style.display='none';
                        if(appData.me.pendingFarm) showReward(50, 10, "Worked Hard!", "Great job!");
                        else showReward(0, 0, "Slacked Off...", "Lazy Chicken!");
                        fetch(`\${getApiBase()}/cmd/clearReward?access_token=\${TOKEN}&uid=\${UID}`);
                    }

                    if(appData.me.pendingReward) {
                        let pr = appData.me.pendingReward;
                        // Trigger the fancy popup
                        showReward(pr.xp, pr.coins, pr.title, pr.sub);
                        // Clear it immediately so it doesn't loop
                        fetch(`\${getApiBase()}/cmd/clearReward?access_token=\${TOKEN}&uid=\${UID}`);
                    }
                }
            }).catch(e => { console.error("Poll Error", e); });
        }
        function renderAll() {
            if(!appData) return;
            // NEW: Render Sun/Moon
            let iconDiv = document.getElementById('weather-icon');
            if(iconDiv) {
                if(appData.isDay) {
                    iconDiv.innerHTML = '<i class="fa fa-sun"></i>';
                    iconDiv.style.color = "#f1c40f"; // Yellow
                } else {
                    iconDiv.innerHTML = '<i class="fa fa-moon"></i>';
                    iconDiv.style.color = "#bdc3c7"; // Silver/Grey
                }
            }
            if(appData.me.isAdmin) { document.getElementById('admin-pin').classList.remove('hidden');
            document.getElementById('admin-close-poll').classList.remove('hidden'); }
            renderStoryBar(); renderFeed(); renderLeaderboards(); renderBulletin(); renderHabits(); renderPoll(); checkVisibility('Leaderboard');
            checkVisibility('Bulletin');
        }
        function renderPoll() {
            let container = document.getElementById('pollContainer');
            if(!appData.poll) { container.style.display = 'none'; return; }
            container.style.display = 'block';
            let p = appData.poll; let html = `<div class="poll-q">\${p.question}</div>`;
            if(p.open && p.myVote === 0) {
                p.options.forEach(o => { html += `<div class="poll-opt" onclick="openVoteConfirm(\${o.id})"><span>\${o.text}</span><i class="far fa-circle"></i></div>`; });
            } else {
                if(!p.open) html += `<div class="poll-closed-badge">CLOSED</div>`;
                p.options.forEach(o => {
                    let pct = (p.total > 0) ? Math.round((o.count / p.total) * 100) : 0; let isMy = (p.myVote === o.id); let cls = isMy ? "poll-opt voted" : "poll-opt"; let icon = isMy ? "<i class='fa fa-check-circle'></i>" : "";
                    html += `<div class="poll-res-row"><div class="poll-res-txt"><span>\${o.text} \${icon}</span><span>\${pct}% (\${o.count})</span></div><div class="poll-bar-bg"><div class="poll-bar-fill" style="width:\${pct}%"></div></div></div>`;
                });
                html += `<div style="font-size:10px; color:#999; margin-top:5px; text-align:right;">Total Votes: \${p.total}</div>`;
            }
            container.innerHTML = html;
        }
        function renderHabits() {
            if(!appData.me.dailys) return;
            let d = appData.me.dailys;
            document.getElementById('h-post').checked = d.post;
            document.getElementById('h-reply').checked = d.reply;
            document.getElementById('h-like').checked = d.like;
            document.getElementById('h-battle').checked = d.battle;
            document.getElementById('h-tithe').checked = d.tithe;
            document.getElementById('h-adventure').checked = d.adventure; document.getElementById('h-shop').checked = d.shop;
            document.getElementById('h-login').checked = d.login;
            document.getElementById('h-hospital').checked = d.hospital;
            if(d.collected) document.getElementById('habitRewardBanner').style.display='block'; else document.getElementById('habitRewardBanner').style.display='none';
            let ap = appData.me.advProgress || {wilds:0, spooky:0, crazy:0, boss1:false, boss2:false, boss3:false, bossFarmer:false};
            
            let wHtml = (ap.wilds >= 3) ?
            `<div>Wilds Hunter (3 Wins) ‚úÖ</div><div style='color:#f1c40f;'>20xp 10coin</div>` : `<div>Wilds Hunter (3 Wins)</div><div>\${ap.wilds}/3</div>`;
            document.getElementById('goal-wilds').innerHTML = wHtml;
            let sHtml = (ap.spooky >= 3) ? `<div>Spooky Hunter (3 Wins) ‚úÖ</div><div style='color:#f1c40f;'>20xp 10coin</div>` : `<div>Spooky Hunter (3 Wins)</div><div>\${ap.spooky}/3</div>`;
            document.getElementById('goal-spooky').innerHTML = sHtml;
            let cHtml = (ap.crazy >= 6) ?
            `<div>Crazy House Master (6 Wins) ‚úÖ</div><div style='color:#f1c40f;'>40xp 20coin</div>` : `<div>Crazy House Master (6 Wins)</div><div>\${ap.crazy || 0}/6</div>`;
            document.getElementById('goal-crazy').innerHTML = cHtml;
            let b1Html = (ap.boss1) ? `<div>Boss: Raven ‚úÖ</div><div style='color:#f1c40f;'>50xp 50coin</div>` : `<div>Boss: Raven</div><div style='font-size:10px;'></div>`;
            document.getElementById('goal-boss1').innerHTML = b1Html;
            let b2Html = (ap.boss2) ? `<div>Boss: Owl ‚úÖ</div><div style='color:#f1c40f;'>50xp 50coin</div>` : `<div>Boss: Owl</div><div style='font-size:10px;'></div>`;
            document.getElementById('goal-boss2').innerHTML = b2Html;
            let b3Html = (ap.boss3) ? `<div>Boss: Skeleton ‚úÖ</div><div style='color:#f1c40f;'>100xp 100coin</div>` : `<div>Boss: Skeleton</div><div style='font-size:10px;'></div>`;
            document.getElementById('goal-boss3').innerHTML = b3Html;
            let bfHtml = (ap.bossFarmer) ? `<div>Boss: Crazy Farmer ‚úÖ</div><div style='color:#f1c40f;'>200xp 200coin + Items</div>` : `<div>Boss: Crazy Farmer</div><div style='font-size:10px;'></div>`;
            document.getElementById('goal-boss-farmer').innerHTML = bfHtml;
        }
        function renderLeaderboards() {
            function buildList(list, type) {
                let h = "";
                list.slice(0, 5).forEach((u, idx) => {
                    let sub = "";
                    if(type === 'chicken') sub = `Lvl \${u.level} | \${u.wins}W - \${u.loss}L`;
                    if(type === 'coins') sub = `\${u.coins} Coins`;
                    if(type === 'pulse') sub = `\${u.count} Actions | \${u.likes} Likes`;
                    if(type === 'adventure') sub = `\${u.wins} Wins | \${u.loss} Losses`;
                    h += `<div class="lb-row"><div class="lb-rank">#\${idx+1}</div><div class="lb-info"><div class="lb-name">\${u.chicken || u.user}</div><div class="lb-sub">\${sub}</div></div><div style="font-size:18px;">\${u.avatar}</div></div>`;
                });
                return h || "<div style='padding:10px; opacity:0.7; font-size:12px;'>No data yet</div>";
            }
            document.getElementById('lbChicken').innerHTML = buildList(appData.lbChicken, 'chicken');
            document.getElementById('lbCoins').innerHTML = buildList(appData.lbCoins, 'coins');
            document.getElementById('lbPulse').innerHTML = buildList(appData.lbPulse, 'pulse');
            document.getElementById('lbAdv').innerHTML = buildList(appData.lbAdventure, 'adventure');
        }
        function renderBulletin() {
            let area = document.getElementById('bulletinArea');
            if(!appData.bulletin) { area.innerHTML = ""; return; }
            let p = appData.bulletin;
            let u = getUser(p.uid);
            let moodIcon = ""; if(p.mood) { const moods = {happy:'üòÑ',excited:'ü§©',tired:'üò¥',sad:'üò¢',sick:'ü§¢',relaxed:'üòå',angry:'üò°',silly:'ü§™'}; moodIcon = moods[p.mood] || '';
            }
            let myReact = p.reactions.find(r => r.uid == UID);
            let reactColor = myReact ? "#FF6B6B" : "#999"; let reactIcon = myReact ? myReact.emote : "<i class='far fa-heart'></i>";
            let delBtn = (appData.me.isAdmin) ? `<div class="action-item" style="margin-left:auto; color:#ff6b6b;" onclick="clearBulletin()"><i class="fa fa-trash"></i> Unpin</div>` : "";
            let hideBtn = `<div class="visibility-toggle" style="position:absolute; top:15px; right:15px; z-index:20; font-weight:bold; font-size:11px;" onclick="toggleVisibility('Bulletin')"><i class="fa fa-eye-slash"></i> Hide</div>`;
            let html = `<div class="card" style="border:2px solid #d35400; background:#fffdf5; position:relative;">
                \${hideBtn}
                <div style="position:absolute; top:-10px; right:-10px; background:#d35400; color:white; padding:5px 10px; border-radius:15px; font-size:10px; font-weight:bold; box-shadow:0 2px 5px rgba(0,0,0,0.2);"><i class="fa fa-thumbtack"></i> BULLETIN</div><div class="feed-header"><div class="feed-avatar">\${u.avatar}</div><div class="feed-meta"><h4>\${u.name}</h4><span>\${timeSince(p.ts)} \${moodIcon}</span></div></div><div class="feed-body">\${p.msg}</div><div class="action-row"><div class="action-item" onclick="this.querySelector('.emote-picker').classList.toggle('show')"><span style="color:\${reactColor};">\${reactIcon} \${p.reactions ?
                p.reactions.length : 0}</span><div class="emote-picker"><span class="emote-opt" onclick="react('\${p.id}', 'üëç')">üëç</span><span class="emote-opt" onclick="react('\${p.id}', '‚ù§Ô∏è')">‚ù§Ô∏è</span><span class="emote-opt" onclick="react('\${p.id}', 'üòÇ')">üòÇ</span><span class="emote-opt" onclick="react('\${p.id}', 'üò¢')">üò¢</span><span class="emote-opt" onclick="react('\${p.id}', 'üò°')">üò°</span></div></div><div class="action-item" onclick="toggleReply('\${p.id}')"><i class="far fa-comment"></i> Reply</div>\${delBtn}</div>\${renderReplies(p)}<div id="reply-box-\${p.id}" style="display:none; margin-top:10px; margin-left:54px;"><input id="reply-input-\${p.id}" class="composer" style="width:100%; padding:10px; border:1px solid #eee; border-radius:10px;"
                placeholder="Write a reply..."><button class="btn" style="margin-top:5px; width:auto; padding:5px 15px; font-size:12px;" onclick="doReply('\${p.id}')">Send</button></div></div>`;
            area.innerHTML = html;
        }
        function renderFeed() {
            let html = "";
            if(appData.posts.length === 0) html = "<div style='text-align:center; padding:20px; color:#ccc;'>No posts yet!</div>";
            appData.posts.forEach(p => {
                let u = getUser(p.uid); let isSys = (p.type === 'system' || p.type === 'event_farmer'); let sysCls = isSys ? 'border-left:4px solid #FF8E53; background:#fffcf9;' : '';
                let delBtn = (appData.me.isAdmin || p.uid == UID) ? `<div class="action-item" style="margin-left:auto; color:#ff6b6b;" onclick="deletePost('\${p.id}')"><i class="fa fa-trash"></i></div>` : "";
                let moodIcon = ""; if(p.mood) { const moods = 
                {happy:'üòÑ',excited:'ü§©',tired:'üò¥',sad:'üò¢',sick:'ü§¢',relaxed:'üòå',angry:'üò°',silly:'ü§™'}; moodIcon = moods[p.mood] || ''; }
                let feedBtn = "";
                if(p.type === 'event_farmer') {
                     let eatenStatus = (p.eaters && p.eaters[UID]) ? p.eaters[UID] : null;
                    if (eatenStatus) {
    
                        if(eatenStatus === 'won') feedBtn = `<button class="btn" style="margin-top:10px; background:#2ecc71; cursor:default;" disabled>Yum! (+10 XP)</button>`;
                        else feedBtn = `<button class="btn" style="margin-top:10px;
                        background:#7f8c8d; cursor:default;" disabled>Rotten! (0 XP)</button>`;
                    } else { feedBtn = `<button id="btn-farmer-\${p.id}" class="btn" style="margin-top:10px;
                    background:#e67e22;" onclick="eatFarmerFeed('\${p.id}')">üåΩ Let Chicken Eat</button>`; }
                }
                
                let msgHtml = p.msg;
                if (isSys && msgHtml.includes("bday-btn")) {
                     let tempDiv = 
                     document.createElement('div'); tempDiv.innerHTML = msgHtml;
                     let btn = tempDiv.querySelector('.bday-btn');
                     if(btn) {
                         let owner = parseInt(btn.getAttribute('data-owner'));
                         if(owner === UID) { btn.style.display = 'block'; } else { btn.style.display = 'none'; }
                         msgHtml = tempDiv.innerHTML;
                    }
                }
                
                let myReact = p.reactions.find(r => r.uid == UID); let reactColor = myReact ? "#FF6B6B" : "#999"; let reactIcon = myReact ? myReact.emote : "<i class='far fa-heart'></i>";
                let msgFormatted = msgHtml.replace(/\\n/g, '<br>');
                html += `<div class="card" style="\${sysCls}"><div class="feed-header"><div class="feed-avatar">\${u.avatar}</div><div class="feed-meta"><h4>\${u.name}</h4><span>\${timeSince(p.ts)} \${moodIcon}</span></div></div><div class="feed-body">\${msgFormatted} \${feedBtn}</div><div class="action-row"><div class="action-item" onclick="this.querySelector('.emote-picker').classList.toggle('show')"><span style="color:\${reactColor};">\${reactIcon} \${p.reactions ?
                p.reactions.length : 0}</span><div class="emote-picker"><span class="emote-opt" onclick="react('\${p.id}', 'üëç')">üëç</span><span class="emote-opt" onclick="react('\${p.id}', '‚ù§Ô∏è')">‚ù§Ô∏è</span><span class="emote-opt" onclick="react('\${p.id}', 'üòÇ')">üòÇ</span><span class="emote-opt" onclick="react('\${p.id}', 'üò¢')">üò¢</span><span class="emote-opt" onclick="react('\${p.id}', 'üò°')">üò°</span></div></div><div class="action-item" onclick="toggleReply('\${p.id}')"><i class="far fa-comment"></i> Reply</div>\${delBtn}</div>\${renderReplies(p)}<div id="reply-box-\${p.id}" style="display:none; margin-top:10px; margin-left:54px;"><input id="reply-input-\${p.id}" class="composer" style="width:100%; padding:10px; border:1px solid #eee; border-radius:10px;"
                placeholder="Write a reply..."><button class="btn" style="margin-top:5px; width:auto; padding:5px 15px; font-size:12px;" onclick="doReply('\${p.id}')">Send</button></div></div>`;
            });
            document.getElementById('feed-container').innerHTML = html;
        }
        function renderReplies(p) {
            if(!p.replies || p.replies.length === 0) return "";
            let h = "<div class='replies'>";
            p.replies.forEach(r => {
                let u = getUser(r.uid);
                let upCount = r.reactions ? r.reactions.filter(x=>x.type=='up').length : 0; let downCount = r.reactions ? r.reactions.filter(x=>x.type=='down').length : 0;
                let myAct = r.reactions ? r.reactions.find(x=>x.uid==UID) : null;
                let upCls = (myAct 
                && myAct.type=='up') ? 'active up' : ''; let downCls = (myAct && myAct.type=='down') ? 'active down' : '';
                let delRep = (appData.me.isAdmin || r.uid == UID) ? `<i class="fa fa-trash" style="margin-left:10px; cursor:pointer; color:#ff6b6b; font-size:10px;" onclick="deleteReply('\${p.id}', '\${r.ts}')"></i>` : "";
                h += `<div class="reply-item"><div style="display:flex; justify-content:space-between;"><div><b>\${u.name}</b> <span style="font-weight:normal">\${r.msg}</span></div>\${delRep}</div><div class="reply-actions"><span class="reply-btn \${upCls}" onclick="reactReply('\${p.id}','\${r.ts}','up')">üëç \${upCount||''}</span><span class="reply-btn \${downCls}" onclick="reactReply('\${p.id}','\${r.ts}','down')">üöΩ \${downCount||''}</span></div></div>`;
            });
            return h + "</div>";
        }
    """
}
def getAppJsPart2() {
    return """

function loadStatusOptions() {
    // Extended list of Quick Status options
    const opts = [
      // Gaming & Fun
      "üéÆ Playing Video Games",
      "üì∫ Watching TV",
      "üçø At the Movies",
      "üîú Headed Home",
      "üõë Stuck In Traffic",
      "üíº At Work",
      "üõí Grocery Shopping",
      "üèãÔ∏è At the Gym",
    ];

    let sel = document.getElementById('quickStatusSelect');
    if(sel) {
        // Prevent duplicate loading
        if(sel.options.length > 1) return;
        opts.forEach(o => {
            let opt = document.createElement('option');
            opt.value = o;
            opt.innerText = o;
            sel.appendChild(opt);
        });
    }
}

            function openAdventure(){
            if(appData.me.isWounded) { document.getElementById('unconsciousModal').style.display = 'block'; return; }
            let t = appData.me.advTokens; let maxE = (appData.me.chicken.level>=10)?10:(appData.me.chicken.level>=5?8:6);
            document.getElementById('advTokens').innerText = t + "/" + maxE;
            let p = appData.me.advProgress || {wilds:0, spooky:0, crazy:0, boss1:false, boss2:false, boss3:false, bossFarmer:false};
            document.getElementById('prog-wilds').innerText = `Wins: \${p.wilds}/3`; document.getElementById('prog-spooky').innerText = `Wins: \${p.spooky}/3`; document.getElementById('prog-crazy').innerText = `Wins: \${p.crazy || 0}/6`;
            
            let b1 = document.getElementById('zone-boss1');
            if(p.boss1) { b1.classList.add('completed-boss'); b1.classList.remove('locked'); b1.querySelector('p').innerText = "‚úÖ Defeated"; } 
            else if(p.boss1Att) { b1.classList.add('locked'); b1.querySelector('p').innerText = "Too afraid to Fight"; } 
            else if(p.wilds >= 3) { b1.classList.remove('locked'); b1.classList.remove('completed-boss'); b1.querySelector('p').innerText = "Cost: 0 Energy"; } 
            else { b1.classList.add('locked'); b1.querySelector('p').innerText = `Locked (Need 3 Wilds Wins)`; }
            
            let b2 = document.getElementById('zone-boss2');
            if(p.boss2) { b2.classList.add('completed-boss'); b2.classList.remove('locked'); b2.querySelector('p').innerText = "‚úÖ Defeated"; } 
            else if(p.boss2Att) { b2.classList.add('locked'); b2.querySelector('p').innerText = "Too afraid to Fight"; } 
            else if(p.spooky >= 3) { b2.classList.remove('locked'); b2.classList.remove('completed-boss'); b2.querySelector('p').innerText = "Cost: 0 Energy"; } 
            else { b2.classList.add('locked'); b2.querySelector('p').innerText = `Locked (Need 3 Spooky Wins)`; }
            
            let b3 = document.getElementById('zone-boss3');
            if(p.boss3) { b3.classList.add('completed-boss'); b3.classList.remove('locked'); b3.querySelector('p').innerText = "‚úÖ Defeated"; } 
            else if(p.boss3Att) { b3.classList.add('locked'); b3.querySelector('p').innerText = "Too afraid to Fight"; } 
            else if(p.boss1 && p.boss2) { b3.classList.remove('locked'); b3.querySelector('p').innerText = "Cost: 0 Energy"; } 
            else { b3.classList.add('locked'); b3.querySelector('p').innerText = "Locked (Defeat Raven & Owl)"; }
            
            let sp = document.getElementById('zone-spooky');
            if(appData.me.chicken.level < 5) { sp.classList.add('locked'); sp.querySelector('p').innerText = "Locked (Need Level 5+)"; } else { sp.classList.remove('locked'); sp.querySelector('p').innerText = `Wins: \${p.spooky}/3`; }
            
            let cz = document.getElementById('zone-crazy');
            if(appData.me.chicken.level < 10) { cz.classList.add('locked'); cz.querySelector('p').innerText = "Locked (Need Level 10)"; } else { cz.classList.remove('locked'); cz.querySelector('p').innerText = `Wins: \${p.crazy || 0}/6`; }

            let bf = document.getElementById('zone-boss-farmer');
            let att = p.bossFarmerAtt || 0;
            if(p.bossFarmer) { bf.classList.add('completed-boss'); bf.classList.remove('locked'); bf.querySelector('p').innerText = "‚úÖ Defeated"; } 
            else if(att >= 2) { bf.classList.add('locked'); bf.querySelector('p').innerText = "Attempts Exhausted (2/2)"; } 
            else if((p.crazy || 0) >= 6 && p.boss1 && p.boss2 && p.boss3) { bf.classList.remove('locked'); bf.querySelector('p').innerText = "Cost: 0 Energy"; } 
            else { bf.classList.add('locked'); bf.querySelector('p').innerText = "Locked (Need 6 Crazy Wins + All Bosses)"; }

            let diff = (appData.me.advReset || 0) - appData.serverTime;
            if(diff > 0) { let h = Math.floor(diff/3600000); let m = Math.floor((diff%3600000)/60000); document.getElementById('advTimer').innerText = `Restocking in: \${h}h \${m}m`; document.getElementById('advTimer').style.display='block'; } else { document.getElementById('advTimer').style.display='none'; }
            
            let zDiff = appData.me.dailyResetWait || 0;
            if(zDiff > 0) { let h = Math.floor(zDiff/3600000); let m = Math.floor((zDiff%3600000)/60000); document.getElementById('zoneResetTimer').innerText = `Zone Reset in: \${h}h \${m}m`; document.getElementById('zoneResetTimer').style.display = 'block'; } else { document.getElementById('zoneResetTimer').style.display = 'none'; }
            document.getElementById('adventureModal').style.display='flex';
        }
        function exploreAdventure(zone) {
            if(appData.me.isWounded) { document.getElementById('unconsciousModal').style.display = 'block'; return; }
            if((zone == 'wilds' || zone == 'spooky' || zone == 'crazy_house') && appData.me.advTokens <= 0) { document.getElementById('energyModal').style.display = 'block'; return; }
            closeModal(); isBattling = true;
            document.getElementById('battleContent').innerHTML = `<div style="padding:20px; text-align:center;"><i class="fa fa-circle-notch fa-spin" style="font-size:30px;"></i><br><br>Searching...</div>`;
            document.getElementById('battleModal').style.display='flex';
            fetch(`\${getApiBase()}/cmd/adventure/explore?access_token=\${TOKEN}&uid=\${UID}&zone=\${zone}`).then(r => r.json()).then(d => {
                if(d.status == 'error') { alert(d.msg); closeModal(); return; }
                let area = document.getElementById('battleContent'); let myIcon = appData.me.chicken.icon; let max = d.maxHp;
                area.innerHTML = `<div style="display:flex; justify-content:space-between; padding:15px; background:#eee; border-radius:10px; margin-bottom:10px;"><div id="p1-icon" style="text-align:center; font-size:30px; transition:transform 0.1s;">\${myIcon}</div><div style="font-size:20px; font-weight:bold;">VS</div><div id="p2-icon" style="text-align:center; font-size:30px; transition:transform 0.1s;">\${d.enemyIcon}</div></div><div style="margin-bottom:5px; font-weight:bold; font-size:12px; display:flex; justify-content:space-between;"><span>Me</span> <span id="hp-txt-p1">100/100</span></div><div style="background:#ddd; height:8px; border-radius:4px; margin-bottom:10px;"><div id="p1-bar" style="width:100%; height:100%; background:#2ecc71;"></div></div><div style="margin-bottom:5px; font-weight:bold; font-size:12px; display:flex; justify-content:space-between;"><span>\${d.enemyName}</span> <span id="hp-txt-p2">100/100</span></div><div style="background:#ddd; height:8px; border-radius:4px; margin-bottom:10px;"><div id="p2-bar" style="width:100%; height:100%; background:#e74c3c;"></div></div><div id="bLog" style="height:150px; overflow-y:auto; background:#f9f9f9; padding:10px; font-size:11px; border:1px solid #eee;"><b>\${d.introText}</b></div><button class="btn" style="margin-top:10px; display:none;" id="battleCloseBtn" onclick="closeModal()">Run Away</button>`;
                let turns = d.turns; let i=0; 
                function play() {
                    if(!isBattling) return; 
                    if(i < turns.length) {
                        let t = turns[i]; let msg = t.msg.replace(/Wins!/g, "<b style='color:#2ecc71'>Wins!</b>").replace(/Critical!/g, "<b style='color:#f1c40f'>Critical!</b>");
                        let log = document.getElementById('bLog'); if(log) { log.innerHTML += `<div>\${msg}</div>`; log.scrollTop = log.scrollHeight; }
                        if(t.attHp !== undefined) {
                              document.getElementById('p1-bar').style.width = Math.max(0, (t.attHp/max.att)*100) + "%"; document.getElementById('p2-bar').style.width = Math.max(0, (t.defHp/max.def)*100) + "%";
                              document.getElementById('hp-txt-p1').innerText = `\${Math.floor(t.attHp)}/\${max.att}`; document.getElementById('hp-txt-p2').innerText = `\${Math.floor(t.defHp)}/\${max.def}`;
                        }
                        let p1 = document.getElementById('p1-icon'); let p2 = document.getElementById('p2-icon');
                        if (i > 0) {
                             playSound('hit');
                             if (i % 2 !== 0) {
                                 if(t.event === 'crush') { p1.classList.add('anim-lunge-r'); p2.classList.add('anim-crush'); } else if(t.event === 'crit') { p1.classList.add('anim-lunge-r'); p2.classList.add('anim-hit'); p2.style.filter = "drop-shadow(0 0 5px red)"; } else if(t.event === 'miss') { p1.classList.add('anim-lunge-r'); p2.classList.add('anim-miss'); } else { p1.classList.add('anim-lunge-r'); p2.classList.add('anim-hit'); }
                             } else {
                                 if(t.event === 'crush') { p2.classList.add('anim-lunge-l'); p1.classList.add('anim-crush'); } else if(t.event === 'crit') { p2.classList.add('anim-lunge-l'); p1.classList.add('anim-hit'); p1.style.filter = "drop-shadow(0 0 5px red)"; } else if(t.event === 'miss') { p2.classList.add('anim-lunge-l'); p1.classList.add('anim-miss'); } else { p2.classList.add('anim-lunge-l'); p1.classList.add('anim-hit'); }
                             }
                             setTimeout(() => { if(p1) { p1.className = ''; p1.style.filter = ''; p2.className = ''; p2.style.filter = ''; } }, 350);
                        }
                        i++; setTimeout(play, 800);
                    } else {
                        isBattling = false; fetchData(true);
                        let btn = document.getElementById('battleCloseBtn'); btn.style.display = 'block'; btn.innerText = "Close";
                        if(d.won) { 
                            playSound('win'); btn.style.background="#2ecc71"; btn.innerText="Victory!"; showToast("You Won!"); 
                            let r = d.reward || {};
                            if(d.bossDefeated) {
                                let sub = d.bossDefeated === 'raven' ? "The Skies are Clear!" : (d.bossDefeated === 'owl' ? "The Night is Safe!" : (d.bossDefeated === 'farmer' ? "The Barn is Ours!" : "The Legend is Born!"));
                                document.getElementById('bossSubTxt').innerText = sub; document.getElementById('bossOverlay').style.display = 'flex';
                            }
                            showReward(r.xp || 20, r.coins || 5, r.title || "Victory!", r.sub || "Battle Won");
                        } else { 
                            playSound('lose'); document.getElementById('lossModal').style.display='block';
                            if(d.losses >= 2) { document.getElementById('lossMsg').innerText="You have been knocked Unconscious! (2 Losses)";
                            } else { document.getElementById('lossMsg').innerText="Be careful, 2 losses = Unconscious."; }
                        }
                    }
                }
                play();
            });
        }
        function healChicken() { apiCall('hospital/heal', {uid:UID}); closeModal(); let pop = document.getElementById('revivePopup'); if(pop) { pop.style.display = 'block'; setTimeout(() => { pop.style.display = 'none'; }, 3000); } }
        function buyItem(item) { apiCall('shop/buy', {uid:UID, item:item}, (d) => { if(d.status == 'success') { showToast(d.msg); closeModal(); fetchData(true); } else { alert(d.msg); } }); }  
function openShop(){ 
            apiCall('shop/visit', {uid:UID});
            
            // Check Status (Default to TRUE if undefined to prevent lockout)
            let isOpen = (appData.shopOpen === true || appData.shopOpen === undefined);

            // Toggle Views
            if (!isOpen) {
                if(document.getElementById('shop-view-open')) document.getElementById('shop-view-open').style.display = 'none';
                if(document.getElementById('shop-view-closed')) document.getElementById('shop-view-closed').style.display = 'block';
                document.getElementById('shopModal').style.display = 'flex';
                return;
            } else {
                if(document.getElementById('shop-view-open')) document.getElementById('shop-view-open').style.display = 'block';
                if(document.getElementById('shop-view-closed')) document.getElementById('shop-view-closed').style.display = 'none';
            }

            // --- ORIGINAL BUTTON LOGIC STARTS HERE ---
            let coins = appData.me.chicken.coins; document.getElementById('shopCoins').innerText = coins; 
            let b1 = document.getElementById('buy-feed'); let bSuper = document.getElementById('buy-super-feed'); let b2 = document.getElementById('buy-steroid');
            let bEnergy = document.getElementById('buy-energy');
            let bHormone = document.getElementById('buy-hormone'); let bBox = document.getElementById('buy-box'); let bSword = document.getElementById('buy-sword'); let bShield = document.getElementById('buy-shield');
            let bLure = document.getElementById('buy-lure');
            let curEnergy = appData.me.advTokens;
            
            if(appData.me.dailyFeeds >= 2) { b1.disabled = true; b1.innerText = "Sold Out"; } else if(coins < 20) { b1.disabled = true; b1.innerText = "Need 20 üí∞"; } else { b1.disabled = false; b1.innerText = "20 üí∞"; }
            let sFeedCount = (appData.me.chicken.inventory && appData.me.chicken.inventory.super_feed) ? appData.me.chicken.inventory.super_feed : 0;
            if(appData.me.dailySuperFeeds >= 2) { bSuper.disabled = true; bSuper.innerText = "Sold Out"; } else if(sFeedCount >= 4) { bSuper.disabled = true; bSuper.innerText = "Full (Max 4)"; } else if(coins < 200) { bSuper.disabled = true; bSuper.innerText = "Need 200 üí∞"; } else { bSuper.disabled = false; bSuper.innerText = "200 üí∞"; }
            if(appData.me.dailyShots >= 2) { b2.disabled = true; b2.innerText = "Sold Out"; } else if(coins < 50) { b2.disabled = true; b2.innerText = "Need 50 üí∞"; } else { b2.disabled = false; b2.innerText = "50 üí∞"; }
            if(appData.me.dailyEnergy >= 2) { bEnergy.disabled = true; bEnergy.innerText = "Sold Out"; } else if(curEnergy > 0) { bEnergy.disabled = true; bEnergy.innerText = "Unavailable"; } else if(coins < 15) { bEnergy.disabled = true; bEnergy.innerText = "Need 15 üí∞"; } else { bEnergy.disabled = false; bEnergy.innerText = "15 üí∞"; }
            if(appData.me.chicken.level >= 10) { bHormone.disabled = true; bHormone.innerText = "Max Lvl"; } else if(appData.me.dailyHormones >= 5) { bHormone.disabled = true; bHormone.innerText = "Sold Out"; } else if(coins < 100) { bHormone.disabled = true; bHormone.innerText = "Need 100 üí∞"; } else { bHormone.disabled = false; bHormone.innerText = "100 üí∞"; }
            if(coins < 150) { bBox.disabled = true; bBox.innerText = "Need 150 üí∞"; } else { bBox.disabled = false; bBox.innerText = "150 üí∞"; }
            let hasSword = (appData.me.chicken.inventory && appData.me.chicken.inventory.chicken_sword) ? 1 : 0;
            if (hasSword) { bSword.disabled = true; bSword.innerText = "Owned"; } else if (appData.me.chicken.level < 10) { bSword.disabled = true; bSword.innerText = "Lvl 10 Req"; } else if (coins < 1000) { bSword.disabled = true; bSword.innerText = "Need 1000 üí∞"; } else { bSword.disabled = false; bSword.innerText = "1000 üí∞"; }
            let hasShield = (appData.me.chicken.inventory && appData.me.chicken.inventory.chicken_shield) ? 1 : 0;
            if (hasShield) { bShield.disabled = true; bShield.innerText = "Owned"; } else if (appData.me.chicken.level < 10) { bShield.disabled = true; bShield.innerText = "Lvl 10 Req"; } else if (coins < 1000) { bShield.disabled = true; bShield.innerText = "Need 1000 üí∞"; } else { bShield.disabled = false; bShield.innerText = "1000 üí∞"; }
            if(appData.me.dailyBossLures >= 2) { bLure.disabled = true; bLure.innerText = "Sold Out"; } else if(coins < 150) { bLure.disabled = true; bLure.innerText = "Need 150 üí∞"; } else { bLure.disabled = false; bLure.innerText = "150 üí∞"; }
            
            document.getElementById('shopModal').style.display='flex';
        }
        function openCoop() { 
            let c = appData.me.chicken; let chickenIcon = c.icon || "üêî"; let inv = c.inventory || {}; let feedCount = inv.feed || 0; let sFeedCount = inv.super_feed || 0;
            let tiredHtml = appData.me.isTired ? "<span class='tired-tag'>TIRED</span>" : ""; let woundedHtml = appData.me.isWounded ? "<span class='tired-tag' style='background:#c0392b;'>UNCONSCIOUS</span>" : "";
            let cur = c.currentHp !== undefined ? c.currentHp : c.stats.hp; let max = c.stats.hp; let hpPct = Math.min(100, (cur/max)*100); let hpColor = (cur < (max*0.3)) ? "#e74c3c" : "#2ecc71";
            let xpPct = (c.level >= 10) ? 100 : (c.xp/c.xpToNext)*100; let xpText = (c.level >= 10) ? "MAX LEVEL" : `\${c.xp} / \${c.xpToNext} XP`;
            let hasSword = (inv.chicken_sword) ? 1 : 0; let hasShield = (inv.chicken_shield) ? 1 : 0;
            let atkSuff = hasSword ? "<span style='color:#e74c3c; font-size:11px; font-weight:bold;'> (+100)</span>" : ""; let defSuff = hasShield ? "<span style='color:#e74c3c; font-size:11px; font-weight:bold;'> (+100)</span>" : ""; let critSuff = hasSword ? "<span style='color:#e74c3c; font-size:11px; font-weight:bold;'> (+10%)</span>" : "";
            let gearHtml = ""; if(hasSword) gearHtml += `<span title="Chicken Sword (+100 ATK, +10% Crit)" style="font-size:20px; margin-right:5px;">‚öîÔ∏è</span>`; if(hasShield) gearHtml += `<span title="Chicken Shield (+100 DEF)" style="font-size:20px;">üõ°Ô∏è</span>`; if(gearHtml === "") gearHtml = "<span style='font-size:10px; color:#aaa;'>No Gear</span>";

            let html = `<div class="coop-help-icon" style="z-index: 10001;" onclick="openHelp('coop')"><i class="fa fa-question-circle"></i></div>
                <div class="chicken-header"><div class="chicken-icon">\${chickenIcon}</div><div><h2 style="margin:0; color:#d35400; cursor:pointer;" onclick="renameChicken()">\${c.name} \${tiredHtml} \${woundedHtml} <i class="fa fa-pencil" style="font-size:12px; color:#999;"></i></h2><span style="font-size:12px; font-weight:bold; color:#e67e22;">LEVEL \${c.level}</span></div></div>
                <div style="margin-bottom:5px; font-size:11px; font-weight:bold; color:#555; display:flex; justify-content:space-between;"><span>Health</span><span>\${cur} / \${max}</span></div>
                <div style="background:#ddd; height:12px; border-radius:10px; overflow:hidden; margin-bottom:15px; border:1px solid #ccc;"><div style="width:\${hpPct}%; background:\${hpColor}; height:100%;"></div></div>
                <div style="background:#eee; height:10px; border-radius:10px; overflow:hidden;"><div style="width:\${xpPct}%; background:#3498db; height:100%;"></div></div>
                <div style="display:flex; justify-content:center; font-size:11px; color:#666; margin-top:3px;"><span>\${xpText}</span></div>
                <div style="display:flex; gap:10px; margin-top:10px;">
                    <div style="flex:1; background:rgba(255,255,255,0.6); padding:10px; border-radius:10px; display:flex; flex-direction:column; align-items:center; gap:2px; font-size:12px;"><div style="font-weight:bold; color:#777;">Supplies</div><div><i class="fa fa-coins" style="color:#f1c40f;"></i> <b>\${c.coins}</b> | üåΩ <b>\${feedCount}</b> | üåü <b>\${sFeedCount}</b></div></div>
                    <div style="flex:1; background:rgba(255,255,255,0.6); padding:10px; border-radius:10px; display:flex; flex-direction:column; align-items:center; gap:2px; font-size:12px;"><div style="font-weight:bold; color:#777;">Gear</div><div>\${gearHtml}</div></div>
                </div>
                <div style="margin-top:15px; font-weight:800; color:#d35400;">STATS <span id='coop-pts-wrapper' style='color:red; display:\${c.pts > 0 ? "inline" : "none"}'> (+<span id='coop-pts'>\${c.pts}</span>)</span></div>
                <div class="stat-grid">\${renderStatBtn('hp', c.stats.hp, c.pts, '')} \${renderStatBtn('atk', c.stats.atk, c.pts, atkSuff)} \${renderStatBtn('def', c.stats.def, c.pts, defSuff)} \${renderStatBtn('crit', c.stats.crit, c.pts, critSuff)}</div>
                <button class="btn" style="margin-top:15px; background:linear-gradient(135deg, #e67e22, #d35400);" onclick="closeModal(); openBattleMenu()">‚öîÔ∏è ENTER ARENA</button>`; 
            document.getElementById('coopContent').innerHTML = html; document.getElementById('coopModal').style.display = 'flex'; 
        }
        function renderStatBtn(lbl, val, pts) { let btn = pts > 0 ? `<span id="btn-train-\${lbl}" class="tr-btn" onclick="train('\${lbl}')">+</span>` : ""; return `<div class="stat-box"><div class="stat-val"><span id="sv-\${lbl}">\${val}</span> \${btn}</div><div class="stat-lbl">\${lbl}</div></div>`; }
        function openBattleMenu() {
            let h = `<h3 style="margin:0 0 10px 0;">Battle Arena</h3>`; let now = appData.serverTime;
            appData.users.forEach(u => {
                if(u.id != UID) {
                    let cd = appData.me.cooldowns[u.id]; let locked = cd ? true : false; let isWounded = u.isWounded;
                    let cls = (locked || isWounded) ? "opacity:0.5; cursor:default;" : "cursor:pointer;"; let txt = "Fight!"; let btnStyle = "";
                    if (isWounded) { txt = "Unconscious"; btnStyle = "background:#95a5a6; cursor:default;"; locked = true; } 
                    else if (locked) { let diff = cd - now; let hours = Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60)); let minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60)); txt = `\${hours}h \${minutes}m`; btnStyle = "background:#ccc; cursor:default;"; }
                    let curHp = u.hp !== undefined ? u.hp : 100; let maxHp = u.maxHp !== undefined ? u.maxHp : 100; let pct = Math.min(100, Math.max(0, (curHp/maxHp)*100));
                    h += `<div style="padding:10px; border:1px solid #eee; margin-bottom:5px; border-radius:10px; \${cls}" onclick="\${locked?'':'startBattle('+u.id+')'}"><div style="display:flex; justify-content:space-between; align-items:center;"><div>\${u.icon||'üêî'} <b>\${u.name}</b></div><button class="btn" style="width:auto; padding:5px 10px; font-size:12px; \${btnStyle}">\${txt}</button></div><div style="font-size:10px; color:#777; margin-top:2px;">HP: \${curHp} / \${maxHp}</div><div class="hp-mini-bar"><div class="hp-mini-fill" style="width:\${pct}%"></div></div></div>`;
                }
            });
            let fLocked = !appData.me.farmAvailable; let waitMsg = ""; let btnStyle = "";
            if(appData.me.isWounded) { waitMsg = "üöë Unconscious (Go to Hospital)"; btnStyle = "background:#c0392b; border-bottom:5px solid #922b21; cursor:default; opacity:0.8;"; fLocked = true;
            } else if(appData.me.isTired) { waitMsg = "üò¥ Chicken Tired (Battled Too Much)"; btnStyle = "background:#95a5a6; border-bottom:5px solid #7f8c8d; cursor:default; opacity:0.8;"; fLocked = true;
            } else if(fLocked) { let farmWait = appData.me.farmWait; if(farmWait > 0) { let s = Math.floor(farmWait / 1000); let h = Math.floor(s/3600); waitMsg = `‚è≥ Farm Locked (\${h}h)`; } btnStyle = "opacity:0.5; cursor:default;"; } 
            else { waitMsg = "üöú Farm (+50XP, +10 Coins)"; }
            h += `<button class="farm-btn" style="\${btnStyle}" onclick="\${fLocked?'':'goFarm()'}">\${waitMsg}</button>`;
            h += `<button class="btn" style="margin-top:10px; background:#95a5a6;" onclick="closeModal()">Leave Arena</button>`;
            document.getElementById('battleContent').innerHTML = h; document.getElementById('battleModal').style.display = 'flex';
        }
        function startBattle(targetId) {
            if(appData.me.isWounded) { document.getElementById('unconsciousModal').style.display = 'block'; return; }
            isBattling = true;
            let targetUser = appData.users.find(u => u.id == targetId); let targetName = targetUser ? (targetUser.chicken || "Unknown") : "Unknown";
            let area = document.getElementById('battleContent');
            area.innerHTML = `<div style="display:flex; justify-content:space-between; padding:15px; background:#eee; border-radius:10px; margin-bottom:10px;"><div id="p1-icon" style="text-align:center; font-size:30px; transition:transform 0.1s;">\${appData.me.chicken.icon}</div><div style="font-size:20px; font-weight:bold;">VS</div><div id="p2-icon" style="text-align:center; font-size:30px; transition:transform 0.1s;">\${targetUser.icon}</div></div><div style="margin-bottom:5px; font-weight:bold; font-size:12px; display:flex; justify-content:space-between;"><span>Me</span> <span id="hp-txt-p1">100/100</span></div><div style="background:#ddd; height:8px; border-radius:4px; margin-bottom:10px;"><div id="p1-bar" style="width:100%; height:100%; background:#2ecc71;"></div></div><div style="margin-bottom:5px; font-weight:bold; font-size:12px; display:flex; justify-content:space-between;"><span>\${targetName}</span> <span id="hp-txt-p2">100/100</span></div><div style="background:#ddd; height:8px; border-radius:4px; margin-bottom:10px;"><div id="p2-bar" style="width:100%; height:100%; background:#e74c3c;"></div></div><div id="battleLog" style="height:150px; overflow-y:auto; background:#f4f4f4; padding:10px; font-size:12px; border:1px solid #eee;">Battle Started!</div><button class="btn" onclick="closeModal()">Run Away</button>`;
            fetch(`\${getApiBase()}/cmd/chicken/battle?access_token=\${TOKEN}&uid=\${UID}&target=\${targetId}`).then(r => r.json()).then(d => {
                let log = document.getElementById('battleLog'); if(d.status == 'error') { log.innerHTML = d.msg; return; }
                let turns = d.turns; let maxHp = d.maxHp; let i = 0;
                function playTurn() {
                   if(!isBattling) return;
                   if(i < turns.length) {
                        let t = turns[i]; let msg = t.msg.replace(/Wins!/g, "<span class='log-win'>Wins!</span>"); log.innerHTML += `<div>\${msg}</div>`; log.scrollTop = log.scrollHeight;
                        if(t.attHp !== undefined) {
                            document.getElementById('p1-bar').style.width = Math.max(0, (t.attHp / maxHp.att) * 100) + "%"; document.getElementById('p2-bar').style.width = Math.max(0, (t.defHp / maxHp.def) * 100) + "%";
                            document.getElementById('hp-txt-p1').innerText = `\${Math.floor(t.attHp)}/\${maxHp.att}`; document.getElementById('hp-txt-p2').innerText = `\${Math.floor(t.defHp)}/\${maxHp.def}`;
                        }
                        let p1 = document.getElementById('p1-icon'); let p2 = document.getElementById('p2-icon');
                        if (i > 0) {
                             playSound('hit');
                             if (i % 2 !== 0) {
                                 if(t.event === 'crush') { p1.classList.add('anim-lunge-r'); p2.classList.add('anim-crush'); } else if(t.event === 'crit') { p1.classList.add('anim-lunge-r'); p2.classList.add('anim-hit'); p2.style.filter="drop-shadow(0 0 5px red)"; } else if(t.event === 'miss') { p1.classList.add('anim-lunge-r'); p2.classList.add('anim-miss'); } else { p1.classList.add('anim-lunge-r'); p2.classList.add('anim-hit'); }
                             } else {
                                 if(t.event === 'crush') { p2.classList.add('anim-lunge-l'); p1.classList.add('anim-crush'); } else if(t.event === 'crit') { p2.classList.add('anim-lunge-l'); p1.classList.add('anim-hit'); p1.style.filter="drop-shadow(0 0 5px red)"; } else if(t.event === 'miss') { p2.classList.add('anim-lunge-l'); p1.classList.add('anim-miss'); } else { p2.classList.add('anim-lunge-l'); p1.classList.add('anim-hit'); }
                             }
                             setTimeout(() => { if(p1) { p1.className = ''; p1.style.filter=''; p2.className = ''; p2.style.filter=''; } }, 350);
                        }
                        i++; setTimeout(playTurn, 1000);
                    } else { isBattling = false; fetchData(true); if(document.getElementById('p1-bar').style.width != "0%") { playSound('win'); showReward(20, 5, "Victory!"); } else { playSound('lose'); showReward(0, 0, "Defeat"); } }
                }
                playTurn();
            });
        }
        function openHospitalHelp(){document.getElementById('helpModalHospital').style.display='flex';}
        function openAdventureHelp(){document.getElementById('helpModalAdventure').style.display='flex';}
        function openForageHelp(){document.getElementById('helpModalForage').style.display='flex';}
        function eatFarmerFeed(pid) { apiCall('farmer/eat', {uid:UID, pid:pid}); }
        function showReward(xp, coins, title, sub) { rewardQueue.push({xp:xp, coins:coins, title:title, sub:sub}); if(document.getElementById('rewardModal').style.display !== 'flex') { processNextReward(); } }
        function processNextReward() { 
            if(rewardQueue.length === 0) return; let r = rewardQueue.shift(); if(r.xp > 0 || r.coins > 0) playSound('coin');
            let xpHtml = (r.xp > 0) ? `<div style="color:#2ecc71; font-weight:bold;">+ \${r.xp} XP</div>` : ''; let coinHtml = (r.coins > 0) ? `<div style="color:#e67e22; font-weight:bold;">+ \${r.coins} Coins</div>` : '';
            let h = `<div class="reward-icon">üèÜ</div><h2 style="color:#f1c40f; margin:0;">\${r.title || 'Victory!'}</h2><div style="font-size:12px; color:#777;">\${r.sub || ''}</div><div style="margin-top:20px; font-size:18px;">\${xpHtml}\${coinHtml}</div>`; 
            document.getElementById('rewardContent').innerHTML = h; document.getElementById('rewardModal').style.display = 'flex';
        }
        function closeRewardModal() { document.getElementById('rewardModal').style.display = 'none'; if(rewardQueue.length > 0) { setTimeout(processNextReward, 300); } }
        function getUser(uid) { if(uid==0)return{name:"Home",avatar:"üè†"}; let u=appData.users.find(x=>x.id==uid); return u?u:{name:"Unknown",avatar:"?"}; }
        function timeSince(d){let s=Math.floor((new Date()-d)/1000); if(s<60)return"Just now"; if(s<3600)return Math.floor(s/60)+"m ago"; if(s<86400)return Math.floor(s/3600)+"h ago"; return"Old";}
        function apiCall(cmd, params, callback) { 
            let q = Object.keys(params).map(k => k + '=' + encodeURIComponent(params[k])).join('&');
            fetch(`\${getApiBase()}/cmd/\${cmd}?access_token=\${TOKEN}&\${q}`).then(r => r.json()).then(d => { 
                if(callback) callback(d);
                if(d.status === 'success') { if(d.xp && !cmd.includes('farm') && !cmd.includes('farmer') && !cmd.includes('poll') && !cmd.includes('birthday')) showToast(`+ \${d.xp} XP`); } else { if(d.msg) alert(d.msg); } fetchData(true); 
            });
        }
        function doPost(){ let m=document.getElementById('txtPost').value; if(!m)return; let p = {uid:UID, msg:m, mood:selectedMood}; if(isPinned) p.pinned = "true"; apiCall('post', p); document.getElementById('txtPost').value=""; if(isPinned) togglePin(); }
        function doMoodOnly() { apiCall('updateMood', {uid:UID, mood:selectedMood}); showToast("Mood Updated!"); }
        function handleQuickStatus(sel) { let val = sel.value; if(!val) return; apiCall('post', {uid:UID, msg:val, mood:selectedMood}); sel.value = ""; }
        function doReply(pid){let m=document.getElementById('reply-input-'+pid).value; if(!m)return; apiCall('reply',{uid:UID,postId:pid,msg:m});}
        function deletePost(pid){if(confirm("Delete post?"))apiCall('deletePost',{postId:pid});}
        function deleteReply(pid, ts){ if(confirm("Delete this reply?")) apiCall('deleteReply', {postId:pid, ts:ts}); }
        function react(pid,em){apiCall('react',{uid:UID,postId:pid,emoji:em});}
        function reactReply(pid,ts,type){apiCall('reactReply',{uid:UID,postId:pid,ts:ts,type:type});}
        function train(stat){ if(appData.me.chicken.pts <= 0) return; appData.me.chicken.pts--; let valEl = document.getElementById('sv-'+stat); if(valEl) valEl.innerText = parseInt(valEl.innerText) + (stat=='hp'?10:1); let ptsEl = document.getElementById('coop-pts'); if(ptsEl) ptsEl.innerText = appData.me.chicken.pts;
        if(appData.me.chicken.pts <= 0) { document.getElementById('coop-pts-wrapper').style.display = 'none'; document.querySelectorAll('.tr-btn').forEach(b => b.style.display = 'none'); } apiCall('chicken/train',{uid:UID,stat:stat}); }
        function toggleReply(pid){let e=document.getElementById('reply-box-'+pid); e.style.display=(e.style.display=='block')?'none':'block';}
        function closeModal(){ document.querySelectorAll('.modal').forEach(m=>m.style.display='none'); isBattling = false; }
        function checkWelcome() { 
            let w = appData.me.welcome; let hasContent = (w.newPosts > 0 || w.gotBonus || w.notifs.length > 0); let h = "";
            if(!hasContent) { h = "<div style='text-align:center; padding:20px; color:#999; font-size:14px;'>Nothing new happened while you were away.</div>"; } 
            else { h = `<div style='font-size:13px; color:#555;'>We missed you! Here is what happened:</div><div style='margin-top:15px;'>`; h += `<div class='welcome-metric'><div class='wm-icon'>üì∞</div><div class='wm-text'>New Posts</div><div class='wm-val'>\${w.newPosts}</div></div>`;
            if(w.gotBonus) h += `<div class='welcome-metric'><div class='wm-icon'>üéÅ</div><div class='wm-text'>Daily Bonus</div><div class='wm-val'>+5 Coins</div></div>`;
            w.notifs.forEach(n => { h += `<div class='welcome-metric'><div class='wm-icon'>üîî</div><div class='wm-text' style='font-size:11px; font-weight:normal;'>\${n}</div></div>`; }); h += `</div>`; }
            document.getElementById('welcomeContent').innerHTML = h; document.getElementById('welcomeModal').style.display='flex';
        }
        function setMood(m){selectedMood=m; document.querySelectorAll('.mood-opt').forEach(e=>e.classList.remove('selected')); document.getElementById('m-'+m).classList.add('selected');}
        function clearBulletin(){if(confirm("Clear bulletin?"))apiCall('clearBulletin',{});}
        function openAvatarModal(){ renderAvatarModal(); }
        function updateAvatar(e) { apiCall('avatar', {uid:UID, emoji:e}); closeModal(); }
        function renameChicken(){ document.getElementById('renameModal').style.display = 'flex'; document.getElementById('chkNameInput').value = appData.me.chicken.name; }
        function confirmRename() { let n = document.getElementById('chkNameInput').value; if(n) { apiCall('chicken/rename', {uid:UID, name:n}); document.getElementById('renameModal').style.display = 'none'; } }
        function resetHabits() { if(confirm("Reset Dailys?")) { apiCall('habit/reset', {uid:UID}); prevDailyState = false; } }
        function resetCooldowns(){ if(confirm("Reset all cooldowns?")) apiCall('resetCooldowns',{}); }
        function doFarmConfirm() { document.getElementById('farmConfirmModal').style.display = 'none'; document.getElementById('battleModal').style.display = 'none'; document.getElementById('farmModal').style.display='flex'; document.getElementById('farmScene1').style.display='flex'; document.getElementById('farmManualFinish').innerText = "Let The Chicken Work"; apiCall('chicken/farm', {uid:UID}); }
        function finishFarmEarly() { document.getElementById('farmModal').style.display='none'; }
        function goFarm() { document.getElementById('farmConfirmModal').style.display = 'flex'; }
        function togglePin() { isPinned = !isPinned; let btn = document.getElementById('admin-pin'); let postBtn = document.getElementById('btnPost'); if(isPinned) { btn.classList.add('active'); btn.innerHTML='<i class="fa fa-thumbtack"></i> Pinned!'; postBtn.innerText = 'Post Bulletin'; } else { btn.classList.remove('active'); btn.innerHTML='<i class="fa fa-thumbtack"></i> Pin as Bulletin'; postBtn.innerText = 'Share Update'; } }
        function toggleVisibility(key) { let k = 'fp_hide_'+key; let hideUntil = new Date().getTime() + 86400000; let stored = localStorage.getItem(k); if(stored && parseInt(stored) > new Date().getTime()) { localStorage.removeItem(k); } else { localStorage.setItem(k, hideUntil.toString()); } checkVisibility(key); }
        function checkVisibility(key) { let k = 'fp_hide_'+key; let stored = localStorage.getItem(k); let hide = false; if(stored && parseInt(stored) > new Date().getTime()) hide = true;
        let contentId = (key=='Leaderboard') ? 'sideColContent' : (key=='Bulletin'?'bulletinArea':'newFeatureCard'); let phId = (key=='Leaderboard') ? 'sideColPlaceholder' : (key=='Bulletin'?'bulletinPlaceholder':'newFeaturesPlaceholder');
        if(document.getElementById(contentId)) document.getElementById(contentId).style.display = hide ? 'none' : 'block'; if(document.getElementById(phId)) document.getElementById(phId).style.display = hide ? 'block' : 'none';
        }
        function toggleLb(id, iconId) { let el = document.getElementById(id); let ico = document.getElementById(iconId); if(el.style.display=='block') { el.style.display='none'; ico.className='fa fa-chevron-right'; } else { el.style.display='block'; ico.className='fa fa-chevron-down'; } }
        function renderAvatarModal() { let emojis = ["üòÄ","üòÇ","üòé","üòç","ü§î","üò¥","ü§Ø","ü•∂","ü§†","üëª","üëΩ","ü§ñ","üí©","üëø","üë∂","üëµ","üëÆ","üïµÔ∏è","üßú","üê∂","üê±","ü¶ä","ü¶Å","üêØ","ü¶Ñ","üê∏","üê¢","ü¶ñ","ü¶ã","üêô","ü¶à","ü¶â","üê∑","üêµ","üçé","üçï","üåÆ","üçî","üç∫","‚öΩ","üèÄ","üèà","üéæ","üéÆ","üèÜ","üöÄ","‚úàÔ∏è","‚öì","üöó","üí°","üì∑","üíä","ü¶†","üåà","üî•","‚ù§Ô∏è","üíî","üíØ","üëë"]; let h = ""; emojis.forEach(e => { h += `<div class="grid-item" onclick="updateAvatar('\${e}')">\${e}</div>` }); document.getElementById('avatarGrid').innerHTML = h; document.getElementById('avatarModal').style.display = 'flex'; }
        function renderStoryBar() { 
            let html = ""; let users = [{id:0, name:"Home", avatar:"üè†"}].concat(appData.users); 
            users.forEach(u => { 
                let isMe = (u.id == UID); let crown = (u.id == appData.leaderId) ? "<div class='crown-badge'><i class='fa fa-crown'></i></div>" : ""; let hBadge = ""; if(appData.holiday === "halloween") hBadge = `<div class="holiday-badge">üéÉ</div>`; if(appData.birthdays && appData.birthdays.includes(u.id)) hBadge = '<div class="holiday-badge">ü•≥</div>';
                let cls = (isMe || u.id == 0) ? "story-item active" : "story-item"; let lastSeen = u.lastSeen || 0; let isOnline = (u.id == 0) || ((appData.serverTime - lastSeen) < 5*60*1000); 
                let onlineHtml = isOnline ? `<div class="online-badge is-online"></div>` : ""; let adminHtml = (u.id == 1) ? `<div class="admin-badge"><i class="fa fa-shield-alt"></i></div>` : ""; 
                let mood = appData.userMoods[u.id]; let moodBadge = ""; if(mood) { const moods = {happy:'üòÑ',excited:'ü§©',tired:'üò¥',sad:'üò¢',sick:'ü§¢',relaxed:'üòå',angry:'üò°',silly:'ü§™'}; moodBadge = moods[mood] || ''; }
                let farmerHtml = (u.isFarmer) ? `<div class="farmer-badge">üë®‚Äçüåæ</div>` : ""; let moodHtml = moodBadge ? `<div class="mood-badge">\${moodBadge}</div>` : "";
                let action = isMe && u.id != 0 ? "openAvatarModal()" : ""; let pencil = isMe && u.id != 0 ? `<div class="edit-badge"><i class="fa fa-pencil"></i></div>` : "";
                html += `<div class="\${cls}" onclick="\${action}">\${crown}<div class="avatar-ring">\${hBadge}<div class="avatar">\${u.avatar}</div>\${onlineHtml}\${moodHtml}\${pencil}\${adminHtml}\${farmerHtml}</div><div class="story-name">\${u.name}</div></div>`; 
            }); document.getElementById('story-bar-container').innerHTML = html;
        }
        function showToast(msg) { let t = document.getElementById('toast'); t.innerText = msg; t.style.opacity = 1; setTimeout(() => { t.style.opacity = 0; }, 2000); }
        function resetTimer() { logoutTime = 300; }
        setInterval(() => { logoutTime--; let m = Math.floor(logoutTime / 60); let s = logoutTime % 60; document.getElementById('logoutTimer').innerText = `\${m}:\${s < 10 ? '0'+s : s}`; if(logoutTime <= 0) doLogout(); }, 1000);
        function openVoteConfirm(id) { pendingVoteId = id; document.getElementById('voteConfirmModal').style.display='flex'; }
        function closeVoteModal() { document.getElementById('voteConfirmModal').style.display='none'; pendingVoteId = null; }
        function confirmVote() {
            if(pendingVoteId) {
                apiCall('poll/vote', {uid:UID, vote:pendingVoteId}, (d) => { if(d.status == 'success') showReward(d.xp, d.coins, "Voted!", "Community Voice"); });
                closeVoteModal();
            }
        }
        function doClosePoll() { if(confirm("Close poll?")) apiCall('poll/close', {uid:UID}); }
        function openForaging() {
            if(appData.me.isWounded) { document.getElementById('unconsciousModal').style.display='block'; return; }
            let t = appData.me.advTokens; let maxE = (appData.me.chicken.level>=10)?10:(appData.me.chicken.level>=5?8:6);
            document.getElementById('forageTokens').innerText = t + "/" + maxE;
            let diff = (appData.me.advReset || 0) - appData.serverTime;
            if(diff > 0) { let h = Math.floor(diff/3600000); let m = Math.floor((diff%3600000)/60000); document.getElementById('forageTimer').innerText = `Restocking in: \${h}h \${m}m`; document.getElementById('forageTimer').style.display='block'; } else { document.getElementById('forageTimer').style.display='none'; }
            document.getElementById('foragingModal').style.display='flex';
        }
        function doForage() {
            if(appData.me.advTokens <= 0) { document.getElementById('foragingModal').style.display='none'; document.getElementById('energyModal').style.display='block'; return; }
            fetch(`\${getApiBase()}/cmd/foraging/explore?access_token=\${TOKEN}&uid=\${UID}`).then(r=>r.json()).then(d=>{
                if(d.status=='error') { alert(d.msg); return; }
                document.getElementById('foragingModal').style.display='none';
                showReward(d.result.xp, d.result.coins, d.result.title, d.result.sub); fetchData(true);
            });
        }
        function openHospital() {
            apiCall('hospital/visit', {uid:UID}); let isWounded = appData.me.isWounded; let c = appData.me.chicken; let h = "";
            if(isWounded) {
                let btnText = (c.coins >= 20) ? "Pay 20 Coins" : "Need 20 Coins"; let disabled = (c.coins >= 20) ? "" : "disabled";
                let wTime = appData.me.woundedTime || 0; let endTime = wTime + 21600000; let diff = endTime - appData.serverTime;
                let timerHtml = "";
                if (diff > 0) { let hrs = Math.floor(diff / 3600000); let mins = Math.floor((diff % 3600000) / 60000); timerHtml = `<div style="font-weight:bold; color:#e74c3c; margin-top:5px; font-size:14px;">Revives in: \${hrs}h \${mins}m</div>`; }
                h = `<div style="text-align:center;"><h3 style="color:#e74c3c;">You are Unconscious!</h3><p style="font-size:12px; color:#555;">You cannot battle or farm.</p><div style="background:#fff0f0; padding:15px; border-radius:10px; border:1px solid #ffcccc; margin-bottom:10px;\"><div style="font-size:30px; margin-bottom:5px;">ü§ï</div><div>Auto-heal in 6 hours.</div>\${timerHtml}</div><button class="btn" style="background:#e74c3c;" onclick="healChicken()" \${disabled}>\${btnText}</button></div>`;
            } else { h = `<div style="text-align:center; padding:20px;"><div style="font-size:50px; margin-bottom:10px;">üíñ</div><h3 style="color:#2ecc71; margin:0;">Healthy!</h3><p style="color:#777; font-size:12px;">Your chicken is in top shape.</p></div>`; }
            document.getElementById('hospitalContent').innerHTML = h; document.getElementById('hospitalModal').style.display='flex';
        }
        function openPresent(pid, uid) {
             apiCall('birthday/open', {uid:uid, pid:pid}, (d) => {
                 if(d.status == 'success') { showReward(d.xp, d.coins, "Happy Birthday!", "Open your gift!"); playSound('win'); } else { showToast(d.msg); }
             });
        }
		function triggerSportEvent(type, msg, mood) {
        apiCall('sportEvent', {uid: UID, eventType: type, msg: msg, mood: mood}, (d) => { if (d.status === 'success') { showReward(d.xp, d.coins, d.title, d.sub); } });
        }
    function openHelp(topic) {
    const helpData = {
        pulse: `<h3>üè† House Rules</h3><p>Daily Questions at 9AM give XP. Likes give 5 coins to the author!</p>`,
        coop: `<h3>üêî Coop Guide</h3><p>Levels 1-2: Egg, 3-7: Chick, 8+: Chicken. Max Level is 10.</p>`,
        shop: `<h3>üõí Shop Guide</h3><p>Buy feed, steroids, and energy. Gear is for Level 10 only.</p>`,
        hospital: `<h3>üè• Hospital Guide</h3><p>Revive unconscious chickens for 20 coins or wait 6 hours.</p>`,
        adventure: `<h3>‚öîÔ∏è Adventure Guide</h3><p>Energy refills every 6 hours. Win 3x to unlock next zones.</p>`,
        forage: `<h3>üçÉ Forage Guide</h3><p>Search for herbs, coins, and rare treasure chests!</p>`
    };

    if(helpData[topic]) {
        document.getElementById('helpContentArea').innerHTML = helpData[topic];
        document.getElementById('universalHelpModal').style.display = 'flex';
    }
}
 
function openTitheConfirm() {
    document.getElementById('titheConfirmModal').style.display='flex';
}

function confirmTitheAction() {
    // 1. Hide the Confirm Box
    document.getElementById('titheConfirmModal').style.display='none';
    
    // 2. Call the Server
    apiCall('church/tithe', {uid:UID}, (d) => {
        if(d.status === 'success') {
            if(d.won) {
                // WINNER: Play Win Sound and Show Reward Popup
                playSound('win');
                showReward(d.xp, d.coins, d.title, d.sub);
            } else {
                // LOSER: Play Coin Sound and Show "Peace" Modal
                playSound('coin'); 
                document.getElementById('titheLoseModal').style.display='flex';
            }
        } else {
            // ERROR: (Not enough coins or Daily limit reached)
            showToast(d.msg);
        }
    });
}
        
        function openChurch() {
        apiCall('church/visit', {uid:UID});
        let coins = appData.me.chicken.coins;
        let btn = document.getElementById('btnTitheAction');
    
     if(coins < 50) {
        btn.disabled = true;
        btn.innerHTML = "Not Enough Coins (Need 50)";
        btn.style.background = "#95a5a6"; // Grey out the button
        btn.style.cursor = "default";
    } else {
        btn.disabled = false;
        btn.innerHTML = "Tithe (50 üí∞)";
        btn.style.background = "#3498db"; // Restore Blue color
        btn.style.cursor = "pointer";
    }
            let quote = (appData && appData.churchQuote) ? appData.churchQuote : "Faith moves mountains.";
            
            document.getElementById('churchQuoteText').innerText = quote;
            document.getElementById('churchModal').style.display = 'flex';
        }
     
        fetchData();
        loadStatusOptions();
        setInterval(fetchData, 15000);
    </script>
    """
}

def handleChoreFinish() {
    def uid = params.uid?.toInteger()
    def valStr = params.value ?: "0"
    valStr = valStr.replace("\$", "")
    def amount = valStr.toBigDecimal()
    
    if(!uid) { 
        render contentType: "application/json", data: JsonOutput.toJson([status: "error", msg: "No User ID"])
        return 
    }

    // Reward Logic
    def coinsEarned = amount.toInteger()
    def xpEarned = (amount * 10).toInteger() 

    addChickenXp(uid, xpEarned)
    adjustCoins(uid, coinsEarned)
    
    // --- NEW: Save Pending Reward for the Popup ---
    atomicState["pendingReward_${uid}"] = [
        title: "Chore Complete!",
        sub: "You earned \$${amount}!",
        xp: xpEarned,
        coins: coinsEarned
    ]
    // ----------------------------------------------
    
    addNotification(uid, "üí∞ Chore Rewards: +${coinsEarned} Coins & +${xpEarned} XP applied!")
    touchActivity()
    render contentType: "application/json", data: JsonOutput.toJson([status: "success", coins: coinsEarned, xp: xpEarned])
}

def getShopStatus() {
    def now = new Date()
    def sun = location.sunrise // Hubitat native sunrise time
    def closeTime = timeToday("20:00", location.timeZone) // 8:00 PM Today
    
    // Default to 6am if sunrise isn't set on hub
    if (!sun) sun = timeToday("06:00", location.timeZone) 
    
    // Shop is OPEN if it is after Sunrise AND before 8 PM
    def isOpen = (now >= sun && now < closeTime)
    
    return [open: isOpen, isDay: (now >= sun && now < closeTime)] 
}

def getAppJs() {
    return getAppJsPart1() + getAppJsPart2()
}

def handleMasterWipe() {
    // Optional Safety: Check if the request comes from the Admin User ID
    // You can remove this 'if' block if you want to run it without being logged in as admin
    def uid = params.uid?.toInteger()
    if (settings.adminUserId && uid != (settings.adminUserId as Integer)) {
        render contentType: "application/json", data: JsonOutput.toJson([status: "error", msg: "Unauthorized: Admin Only"])
        return
    }

    // 1. Wipe Feed & System Data
    atomicState.postIDs = []
    atomicState.bulletin = null
    atomicState.announcementData = [replies:[], reactions:[]]
    atomicState.pollData = [open:true, votes:[:]]

    // 2. Wipe All Users (1 through 8)
    for(int i=1; i<=8; i++) {
        // Reset Chicken to Default Egg
        def c = [name:"Eggbert", level:1, xp:0, xpToNext:1500, pts:0, coins:0, stats:[hp:100, atk:10, def:5, crit:5], currentHp:100, wins:0, loss:0, inventory:[feed:0], icon:"ü•ö"]
        atomicState["chicken_${i}"] = c
        
        // Reset Dailys (Now includes tithe)
        atomicState["dailys_${i}"] = [post:false, reply:false, like:false, battle:false, shop:false, login:false, hospital:false, adventure:false, tithe:false, collected:false]
        
        // Clear all progress and counters
        atomicState["weeklyCount_${i}"] = 0
        atomicState["dailyTithes_${i}"] = 0
        atomicState.remove("advProgress_${i}")
        atomicState.remove("advTokens_${i}")
        atomicState.remove("isWounded_${i}")
        atomicState.remove("woundedTime_${i}")
        atomicState.remove("dailyFeeds_${i}")
        atomicState.remove("dailyShots_${i}")
        atomicState.remove("dailyEnergy_${i}")
        atomicState.remove("dailyHormones_${i}")
        atomicState.remove("dailySuperFeeds_${i}")
        atomicState.remove("dailyBossLures_${i}")
        
        // Clear Cooldowns against other players
        for(int j=1; j<=8; j++) { 
             atomicState.remove("cooldown_${i}_${j}".toString()) 
        }
    }

    touchActivity()
    log.warn "Family Pulse: MASTER WIPE PERFORMED by User ${uid}"
    render contentType: "application/json", data: JsonOutput.toJson([status: "success", msg: "FACTORY RESET COMPLETE. Feed cleared, Chickens reset, Stats wiped."])
}

def handleRemoteReward() {
    def name = params.name
    def xp = params.xp?.toInteger() ?: 0
    def coins = params.coins?.toInteger() ?: 0

    def targetUid = 0
  
    // Find User ID by matching the Name
    for(int i=1; i<=8; i++) {
        def uName = settings["userName_${i}"]
        if(uName && uName == name) {
            targetUid = i
            break
        }
    }

    if(targetUid > 0) {
        if(xp > 0) addChickenXp(targetUid, xp)
        if(coins > 0) adjustCoins(targetUid, coins)
        
        atomicState["pendingReward_${targetUid}"] = [
            title: "Reward Received!",
            sub: "Reward: +${xp}XP +${coins} Coins",
            xp: xp,
            coins: coins
        ]
        
        addNotification(targetUid, "üßπ Chore Reward: +${xp} XP & +${coins} Coins")
        
        log.info "Family Pulse: Reward received for ${name}"
        render contentType: "application/json", data: JsonOutput.toJson([status: "success"])
    } else {
        render contentType: "application/json", data: JsonOutput.toJson([status: "error", msg: "User not found"])
    }
}

def handleWipeSingleUser() {
    def uid = params.uid?.toInteger()
    // Safety check to prevent accidental wipes of User 0 or invalid IDs
    if (!uid || uid < 1 || uid > 8) {
        render contentType: "application/json", data: JsonOutput.toJson([status: "error", msg: "Invalid User ID"])
        return
    }

    // 1. Reset Chicken to Default Egg
    def c = [name:"Eggbert", level:1, xp:0, xpToNext:1500, pts:0, coins:0, stats:[hp:100, atk:10, def:5, crit:5], currentHp:100, wins:0, loss:0, inventory:[feed:0], icon:"ü•ö"]
    atomicState["chicken_${uid}"] = c
    
    // 2. Reset Dailys
    atomicState["dailys_${uid}"] = [post:false, reply:false, like:false, battle:false, shop:false, login:false, hospital:false, adventure:false, tithe:false, collected:false]
    
    // 3. Clear Progress & Counters
    atomicState["weeklyCount_${uid}"] = 0
    atomicState["dailyTithes_${uid}"] = 0
    atomicState.remove("advProgress_${uid}")
    atomicState.remove("advTokens_${uid}")
    atomicState.remove("isWounded_${uid}")
    atomicState.remove("woundedTime_${uid}")
    atomicState.remove("dailyFeeds_${uid}")
    atomicState.remove("dailyShots_${uid}")
    atomicState.remove("dailyEnergy_${uid}")
    atomicState.remove("dailyHormones_${uid}")
    atomicState.remove("dailySuperFeeds_${uid}")
    atomicState.remove("dailyBossLures_${uid}")
    atomicState.remove("pendingReward_${uid}") // Clear any pending popups
    
    // 4. Clear Cooldowns (Both against others and others against them)
    for(int j=1; j<=8; j++) { 
         atomicState.remove("cooldown_${uid}_${j}".toString()) 
         atomicState.remove("cooldown_${j}_${uid}".toString()) 
    }

    log.warn "Family Pulse: User ${uid} manually wiped."
    render contentType: "application/json", data: JsonOutput.toJson([status: "success", msg: "User ${uid} data has been wiped."])
}

def handleResetScripture() {
    updateDailyScripture() // Calls the existing logic to read the JSON file
    render contentType: "application/json", data: groovy.json.JsonOutput.toJson([
        status: "success", 
        msg: "Scripture has been refreshed.",
        newQuote: atomicState.dailyScripture
    ])
}