/**
 * Family Pulse Pro
 */

import groovy.json.JsonOutput
import groovy.json.JsonSlurper
import java.util.Random

definition(
    name: "Family Pulse Pro",
    namespace: "hubitat",
    author: "ShaneAllen",
    description: "The complete private social feed with advanced Adventure modes, Animations, Sounds, and Slayer Badges. (Modified with Password, Calendar & Popups)",
    category: "Convenience",
    iconUrl: "",
    iconX2Url: "",
    oauth: true,
)

preferences {
    page(name: "mainPage")
}

mappings {
    path("/feed") { action: [GET: "renderFeedShell"] }
    path("/portal") { action: [GET: "renderLoginScreen"] }
    path("/logout") { action: [GET: "renderLogout"] }
    path("/api/data") { action: [GET: "handleGetData"] }
    path("/fp-style.css") { action: [GET: "serveCss"] }
    path("/fp-logic.js") { action: [GET: "serveJs"] }    
    
    // Commands
    path("/cmd/post") { action: [GET: "handlePost"] }
	path("/cmd/sportEvent") { action: [GET: "handleSportEvent"] }
    path("/cmd/updateMood") { action: [GET: "handleMoodUpdate"] } 
    path("/cmd/reply") { action: [GET: "handleReply"] }
    path("/cmd/react") { action: [GET: "handleReact"] }
    path("/cmd/reactReply") { action: [GET: "handleReplyReact"] }
    path("/cmd/deletePost") { action: [GET: "handleDeletePost"] }
    path("/cmd/deleteReply") { action: [GET: "handleDeleteReply"] }
    path("/cmd/avatar") { action: [GET: "handleAvatarUpdate"] }
    path("/cmd/clearBulletin") { action: [GET: "handleClearBulletin"] }
    path("/cmd/resetCooldowns") { action: [GET: "handleResetCooldowns"] }
    
    // Chicken & Shop & Hospital & Farmer & Adventure
    path("/cmd/chicken/rename") { action: [GET: "handleChickenRename"] }
    path("/cmd/chicken/train") { action: [GET: "handleChickenTrain"] }
    path("/cmd/chicken/battle") { action: [GET: "handleChickenBattle"] }
    path("/cmd/chicken/farm") { action: [GET: "handleChickenFarm"] }
    path("/cmd/shop/buy") { action: [GET: "handleBuyItem"] }
    path("/cmd/shop/visit") { action: [GET: "handleShopVisit"] }
    path("/cmd/hospital/heal") { action: [GET: "handleHealChicken"] }
    path("/cmd/hospital/visit") { action: [GET: "handleHospitalVisit"] }
    path("/cmd/farmer/eat") { action: [GET: "handleFarmerEat"] }
    path("/cmd/adventure/explore") { action: [GET: "handleAdventureExplore"] }
    path("/cmd/foraging/explore") { action: [GET: "handleForagingExplore"] }
    path("/cmd/church/tithe") { action: [GET: "handleChurchTithe"] }
    
    // Habits
    path("/cmd/habit/reset") { action: [GET: "handleHabitReset"] }
    path("/cmd/habit/complete") { action: [GET: "handleHabitComplete"] }
    path("/cmd/clearReward") { action: [GET: "handleClearReward"] }
    
    // Polls
    path("/cmd/poll/vote") { action: [GET: "handlePollVote"] }
    path("/cmd/poll/close") { action: [GET: "handlePollCloseCmd"] }
    
    // Birthday Present Logic
    path("/cmd/birthday/open") { action: [GET: "handleOpenPresent"] }

    // Admin Tools
    path("/cmd/admin/forceFarmer") { action: [GET: "handleForceFarmer"] }
    path("/cmd/admin/forceQuestion") { action: [GET: "handleForceQuestion"] }
    path("/cmd/admin/forceBirthday") { action: [GET: "handleForceBirthday"] }
	path("/cmd/admin/forceDog") { action: [GET: "handleDogEvent"] }
	path("/cmd/admin/forceWife") { action: [GET: "handleWifeEvent"] }
}

def installed() { initialize() }
def updated() { unsubscribe(); initialize() }

def initialize() {
    if (!atomicState.lastUpdateTs) touchActivity()
    if (!atomicState.postIDs) atomicState.postIDs = []
    if (!atomicState.announcementData) atomicState.announcementData = [replies:[], reactions:[]]
    
    for(int i=1; i<=8; i++) {
        if(settings["userEnabled_${i}"] && !atomicState["avatar_${i}"]) {
            atomicState["avatar_${i}"] = settings["userAvatar_${i}"] ?: "üòÄ"
        }
    }

    schedule("0 0 0 ? * MON", resetWeeklyStats)
    schedule("0 0 0 * * ?", dailyReset) 
  
    def qTime = settings.dailyQuestionTime ?: 9
    schedule("0 0 ${qTime} * * ?", scheduledDailyQuestion)
    schedule("0 30 ${qTime} * * ?", scheduledFarmerCheck)
    schedule("0 0 12 ? * SAT", scheduledDogCheck)
    schedule("0 0 * * * ?", cleanOldPosts) 
    schedule("0 45 10 * * ?", scheduledWifeCheck)
    schedule("0 0 * * * ?", checkSpecialEvents)
    
    // Schedule check every hour (Used for Birthday check at 7am)
    schedule("0 0 * * * ?", checkSpecialEvents)
}

def touchActivity() { atomicState.lastUpdateTs = new Date().time }

// --- DATA & LOGIC HANDLERS ---
def handleGetData() {
    try {
        def activeUser = params.uid ? params.uid.toInteger() : 0
        def nowObj = new Date()
        def nowTime = nowObj.time
        
        if (settings["userTimeOut_${activeUser}"]) {
             render contentType: "application/json", data: JsonOutput.toJson([status: "error", msg: "Timeout"])
             return
        }

        def lastSeen = atomicState["lastSeen_${activeUser}"] ?: 0
        if(activeUser > 0) {
            if (nowTime - lastSeen > 60000) { atomicState["lastSeen_${activeUser}"] = nowTime }
            checkDaily(activeUser, "login") 
        }
        
        // Unconscious Recovery
        if(atomicState["isWounded_${activeUser}"]) {
             def wTime = atomicState["woundedTime_${activeUser}"] ?: 0
             if(nowTime - wTime > 21600000) { 
                 atomicState["isWounded_${activeUser}"] = false
                 atomicState.remove("woundedTime_${activeUser}")
                 atomicState["advLossCount_${activeUser}"] = 0
                 def c = getChickenData(activeUser)
                 c.currentHp = c.stats.hp 
                 atomicState["chicken_${activeUser}"] = c
                 addNotification(activeUser, "üè• You have revived from unconsciousness!")
            }
         }
       
        def notifs = atomicState["notifs_${activeUser}"] ?: []
   
        // Level Up Logic
        if(activeUser > 0) {
            def c = getChickenData(activeUser)
            if(c.level < 10 && c.xp >= c.xpToNext) {
                 while(c.level < 10 && c.xp >= c.xpToNext) { 
                    c.level++
                    c.xp = Math.max(0, c.xp - c.xpToNext)
                    c.xpToNext = (c.xpToNext * 1.5).toInteger()
                    c.pts += 3
                    c.stats.hp += 10;
                    c.currentHp += 10; c.stats.atk += 1;
                    c.stats.def += 1;
                }
                if(c.level >= 10) { c.xp = 0; c.xpToNext = 0; }
                atomicState["chicken_${activeUser}"] = c
                addPostToFeed(0, "system", "üéâ <b>${getUserName(activeUser)}</b>'s chicken <b>${c.name}</b> reached Lvl ${c.level}!", "happy")
                notifs << "üéâ Level Up! You reached Level ${c.level}!"
            }
        }
        
        // --- MULTI-USER BIRTHDAY LOGIC ---
        // 1. Setup Dates using Hub Timezone
        def tz = location.timeZone ?: TimeZone.getDefault()
        def sdf = new java.text.SimpleDateFormat("M-d")
        sdf.setTimeZone(tz)
        def todayStr = sdf.format(new Date()) 
        def todayParts = todayStr.split("-")
        def tMonth = todayParts[0].toInteger()
        def tDay = todayParts[1].toInteger()
        
        def globalHoliday = ""
        if (tMonth == 10 && tDay == 31) globalHoliday = "halloween"
        else if (tMonth == 12 && tDay == 25) globalHoliday = "christmas"
        else if (tMonth == 11) {
            def cal = Calendar.getInstance(tz)
            cal.setTime(new Date())
            def dow = cal.get(Calendar.DAY_OF_WEEK)
            if (dow == Calendar.THURSDAY && tDay >= 22 && tDay <= 28) globalHoliday = "thanksgiving"
        }
        
        // 2. Find ALL users with a birthday today
        def birthdayUsers = [] // LIST instead of single integer
        
        for(int i=1; i<=8; i++) {
             if (settings["userEnabled_${i}"]) {
                 def bdayS = settings["userBirthday_${i}"]
                 if(bdayS) {
                     def parts = bdayS.split("-")
                     if (parts.length == 2 && parts[0].toInteger() == tMonth && parts[1].toInteger() == tDay) {
                         birthdayUsers.add(i) // Add to list
                     }
                 }
             }
        }
        
        // 3. Give Gift Logic
        if(activeUser > 0) {
            if(globalHoliday != "") {
               def bKey = "holidayBonus_${year}_${globalHoliday}_${activeUser}"
               if(!atomicState[bKey]) {
                    addChickenXp(activeUser, 20)
                    adjustCoins(activeUser, 10)
                    notifs << "üéâ Holiday Bonus! +20 XP +10 Coins"
                    atomicState[bKey] = true
                }
            }
            
            // Check if current user is in the birthday list
            if (birthdayUsers.contains(activeUser)) {
                def year = Calendar.getInstance(tz).get(Calendar.YEAR)
                def bKey = "bdayGift_${year}_${activeUser}"
                if(!atomicState[bKey]) {
                    addChickenXp(activeUser, 200)
                    adjustCoins(activeUser, 200)
                    atomicState[bKey] = true
                    def uName = getUserName(activeUser)
                    addPostToFeed(0, "system", "üéÇ <b>HAPPY BIRTHDAY ${uName}!</b><br>You received a Birthday Gift: <b>+200 XP</b> and <b>+200 Coins</b>! üéÅ", "excited")
                    notifs << "üéÅ Happy Birthday! You got 200 XP & 200 Coins!"
                }
            }
        }

        def ids = atomicState.postIDs ?: []
        def posts = []
        def limit = 30
        def count = 0
        def newPostCount = 0
        
        for(int i = ids.size() - 1; i >= 0; i--) {
            if(count >= limit) break
            def p = atomicState["p_${ids[i]}"]
            if(p) { 
                if (p.type == 'event_farmer' && (nowTime - p.ts > 21600000)) { continue }
                posts << p
                if (p.ts > lastSeen) newPostCount++
                count++ 
           }
        }
      
        def users = getUsersList() 
        def leaderId = getWeeklyLeader()
   
        def gotDailyBonus = false
        if(params.init == 'true' && activeUser > 0) {
            def sdfDate = new java.text.SimpleDateFormat("yyyy-MM-dd")
            sdfDate.setTimeZone(tz)
            def today = sdfDate.format(new Date())
            
            def lastDate = atomicState["loginDate_${activeUser}"]
            def bonusCount = atomicState["loginCount_${activeUser}"] ?: 0
            if(lastDate != today) {
                bonusCount = 0
                atomicState["loginDate_${activeUser}"] = today
            }
            if(bonusCount < 2) {
                if(Math.random() < 0.25) {
                    adjustCoins(activeUser, 5)
                    notifs << "üçÄ Daily Bonus! +5 Coins"
                    gotDailyBonus = true
                    bonusCount++
                    atomicState["loginCount_${activeUser}"] = bonusCount
                }
            }
        }
        
        def welcomeSummary = [ newPosts: newPostCount, gotBonus: gotDailyBonus, notifs: notifs ]
        if(notifs) atomicState["notifs_${activeUser}"] = [] 
        
        def cooldownMap = [:]
        def activeBattlesCount = 0
        def totalOpponents = Math.max(0, users.size() - 1)
        
        users.each { u ->
            def key = "cooldown_${activeUser}_${u.id}".toString()
            def expiry = atomicState[key]
            if (expiry && expiry > nowTime) {
               cooldownMap[u.id] = expiry
                if(u.id != activeUser) activeBattlesCount++
            }
        }
        
        def farmExpiry = atomicState["farmCooldown_${activeUser}"]
        def farmAvailable = !farmExpiry || farmExpiry < nowTime
        def farmWait = farmAvailable ? 0 : (farmExpiry - nowTime)
        
        def isTired = (totalOpponents > 0 && activeBattlesCount >= (totalOpponents / 2.0))
        def isWounded = atomicState["isWounded_${activeUser}"] ?: false
        def woundedTime = atomicState["woundedTime_${activeUser}"] ?: 0
        def advLosses = atomicState["advLossCount_${activeUser}"] ?: 0
         
        def myChicken = getChickenData(activeUser)
        def userMoods = [:]
        users.each { u -> userMoods[u.id] = atomicState["mood_${u.id}"] }
        def lbChicken = users.collect { u -> 
            def c = getChickenData(u.id);
            [user: u.name, avatar: u.avatar, chicken: c.name, level: c.level, wins: c.wins, loss: c.loss, icon: c.icon] 
        }.sort { a, b -> b.level <=> a.level ?: b.wins <=> a.wins }
        
        def lbAdventure = users.collect { u -> 
            def c = getChickenData(u.id);
            def aWins = c.advWins ?: 0
            def aLoss = c.advLoss ?: 0
            [user: u.name, avatar: u.avatar, chicken: c.name, wins: aWins, loss: aLoss]
        }.sort { a, b -> b.wins <=> a.wins }

        def lbCoins = users.collect { u -> 
            def c = getChickenData(u.id);
            [user: u.name, avatar: u.avatar, coins: c.coins] 
        }.sort { a, b -> b.coins <=> a.coins }

        def lbPulse = users.collect { u -> 
            def myPosts = posts.findAll { it.uid == u.id }
            def likes = 0;
            def replies = 0
            myPosts.each { p -> 
                likes += (p.reactions ? p.reactions.size() : 0)
                replies += (p.replies ? p.replies.size() : 0)
            }
            [user: u.name, avatar: u.avatar, count: atomicState["weeklyCount_${u.id}"] ?: 0, likes: likes, replies: replies] 
        }.sort { a, b -> b.count <=> a.count }
        
        def annData = atomicState.announcementData ?: [replies:[], reactions:[]]
        def announcement = settings.newFeatureMsg ? [id: "announcement", msg: settings.newFeatureMsg, reactions: annData.reactions, replies: annData.replies] : null

        def myDailys = atomicState["dailys_${activeUser}"] ?: [post:false, reply:false, like:false, battle:false, shop:false, login:false, hospital:false, adventure:false, collected:false]
        
        def pendingFarm = atomicState["farmResult_${activeUser}"]
        def dashUrl = settings["dashboardUrl_${activeUser}"] ?: ""
        def isAdmin = (activeUser == (settings.adminUserId ?: 1) || activeUser == (settings.adminUserId2 ? settings.adminUserId2.toInteger() : -1))
        
        // Adventure Energy
        def maxE = 6
        if(myChicken.level >= 5) maxE = 8
        if(myChicken.level >= 10) maxE = 10
        
        def advTokens = atomicState["advTokens_${activeUser}"]
        if (advTokens == null) { advTokens = maxE; atomicState["advTokens_${activeUser}"] = maxE }
        
        def advReset = atomicState["advReset_${activeUser}"] ?: 0
        if (nowTime > advReset) {
            advTokens = maxE
            atomicState["advTokens_${activeUser}"] = maxE
            atomicState["advReset_${activeUser}"] = nowTime + 21600000 // 6 hours
        }
        
        // Initializing attempts if missing
        def advProgress = atomicState["advProgress_${activeUser}"] ?: [
            wilds:0, spooky:0, crazy:0, 
            boss1:false, boss2:false, boss3:false, bossFarmer:false,
            boss1Att:false, boss2Att:false, boss3Att:false, bossFarmerAtt:0
        ]
        
        if (advProgress.bossFarmerAtt instanceof Boolean) {
             advProgress.bossFarmerAtt = advProgress.bossFarmerAtt ? 1 : 0
             atomicState["advProgress_${activeUser}"] = advProgress
        }
        
        def pollData = null
        if(settings.pollEnabled) {
            def pState = atomicState.pollData ?: [open:true, votes:[:]]
            def counts = [1:0, 2:0, 3:0, 4:0]
            def totalVotes = 0
            pState.votes.each { u, v -> 
                if(counts[v] == null) counts[v] = 0
                counts[v] += 1
                totalVotes++
             }
    
            def options = []
            [1,2,3,4].each { i ->
                if(settings["pollAns${i}"]) options << [id:i, text:settings["pollAns${i}"], count:counts[i]]
            }
            pollData = [
                question: settings.pollQuestion,
                options: options,
                open: pState.open,
                myVote: pState.votes[activeUser.toString()] ?: 0,
                total: totalVotes
            ]
        }
        
        def midnight = new Date(nowTime).clearTime().plus(1).time
        def dailyResetWait = midnight - nowTime

        def data = [
            ts: atomicState.lastUpdateTs ?: 0,
            serverTime: nowTime,
            churchQuote: atomicState.dailyScripture ?: "Loading Scripture...",
            shopOpen: true,
            holiday: globalHoliday,
            birthdays: birthdayUsers, // SENDING A LIST NOW
            posts: posts,
            bulletin: atomicState.bulletin,
            announcement: announcement,
            users: users,
            me: [
                id: activeUser, chicken: myChicken, cooldowns: cooldownMap, 
                farmAvailable: farmAvailable, farmWait: farmWait, isTired: isTired, 
                isWounded: isWounded, woundedTime: woundedTime, losses: advLosses,
                dailys: myDailys, pendingFarm: pendingFarm, dashboardUrl: dashUrl,
                welcome: welcomeSummary, 
                isAdmin: isAdmin,
                advTokens: advTokens, advReset: advReset, advProgress: advProgress,
                dailyResetWait: dailyResetWait,
                dailyEnergy: atomicState["dailyEnergy_${activeUser}"] ?: 0,
                dailyFeeds: atomicState["dailyFeeds_${activeUser}"] ?: 0,
                dailyShots: atomicState["dailyShots_${activeUser}"] ?: 0,
                dailyHormones: atomicState["dailyHormones_${activeUser}"] ?: 0,
                dailySuperFeeds: atomicState["dailySuperFeeds_${activeUser}"] ?: 0,
                dailyBossLures: atomicState["dailyBossLures_${activeUser}"] ?: 0 
            ],
            leaderId: leaderId, lbChicken: lbChicken, lbPulse: lbPulse, lbCoins: lbCoins, lbAdventure: lbAdventure,
            poll: pollData, userMoods: userMoods
        ]
    
        render contentType: "application/json", data: JsonOutput.toJson(data)
    } catch (e) {
        log.error "Data Fetch Error: ${e}"
        render contentType: "application/json", status: 500, data: JsonOutput.toJson([error: e.getMessage()])
    }
}

// --- BATTLE & GAME LOGIC ---

def getChickenData(uid) {
    def c = atomicState["chicken_${uid}"]
    if(!c) c = [name:"Eggbert", level:1, xp:0, xpToNext:100, pts:0, coins:0, stats:[hp:100, atk:10, def:5, crit:5], currentHp:100, wins:0, loss:0, inventory:[feed:0]]
    if(c.currentHp == null) c.currentHp = c.stats.hp
    if(!c.inventory) c.inventory = [feed:0]
    
    if(c.level <= 2) c.icon = "ü•ö"
    else if(c.level <= 7) c.icon = "üê•"
    else c.icon = "üêî"
    return c
}

def handleBuyItem() {
    def uid = params.uid.toInteger()
    def item = params.item
    def c = getChickenData(uid)
    def msg = "Error"; def status = "error"
    
    if (item == 'feed') {
        def feeds = atomicState["dailyFeeds_${uid}"] ?: 0
        if (feeds >= 2) { msg = "Sold Out"; }
        else if (c.coins >= 20) {
            c.coins -= 20; if (!c.inventory) c.inventory = [:]; 
            c.inventory.feed = (c.inventory.feed ?: 0) + 1
            atomicState["dailyFeeds_${uid}"] = feeds + 1
            msg = "Purchased Chicken Feed!"; status = "success"
            atomicState["chicken_${uid}"] = c
        } else { msg = "Not enough coins!"; }
    } 
         else if (item == 'boss_lure') {
        def lures = atomicState["dailyBossLures_${uid}"] ?: 0
        if (lures >= 2) { 
             msg = "Sold Out";
        }
        else if (c.coins >= 150) {
            c.coins -= 150
            atomicState["dailyBossLures_${uid}"] = lures + 1
            
            def prog = atomicState["advProgress_${uid}"] ?: [:]
            
            // ONLY RESET ATTEMPTS (Allows retries if you lost)
            prog.boss1Att = false
            prog.boss2Att = false
            prog.boss3Att = false
            prog.bossFarmerAtt = 0
            
            // DO NOT RESET WINS (Prevents farming rewards)
            // prog.boss1 = false  <-- Deleted
            // prog.boss2 = false  <-- Deleted
            // ...
            
            atomicState["advProgress_${uid}"] = prog
            atomicState["chicken_${uid}"] = c
            status = "success"
            msg = "Bosses Lured! (Retries available)"
        } else {
            msg = "Not enough coins!";
        }
    }
    else if (item == 'steroid') {
        def shots = atomicState["dailyShots_${uid}"] ?: 0
        if (shots >= 2) { msg = "Sold Out"; } 
        else if (c.coins >= 50) {
            c.coins -= 50; c.pts += 5; 
            atomicState["dailyShots_${uid}"] = shots + 1; 
            atomicState["chicken_${uid}"] = c
            msg = "Steroid Shot applied! +5 Stats"; status = "success"
        } else { msg = "Not enough coins!"; }
    }
    else if (item == 'energy_drink') {
        def energyDaily = atomicState["dailyEnergy_${uid}"] ?: 0
        def maxE = (c.level >= 10) ? 10 : (c.level >= 5 ? 8 : 6)
        def tokens = atomicState["advTokens_${uid}"]
        if(tokens == null) tokens = maxE
        
        if (energyDaily >= 2) { msg = "Sold Out"; }
        else if (tokens >= maxE) { 
            render contentType: "application/json", data: JsonOutput.toJson([status: "energy_full", msg: "Your Energy Is Already Full"])
            return 
        }
        else if (tokens > 0) {
            render contentType: "application/json", data: JsonOutput.toJson([status: "energy_not_empty", msg: "You Already Have Energy"])
            return 
        } 
        else if (c.coins >= 15) {
            c.coins -= 15
            atomicState["advTokens_${uid}"] = maxE
            atomicState["dailyEnergy_${uid}"] = energyDaily + 1
            atomicState["chicken_${uid}"] = c
            msg = "Energy Restored!"; status = "success"
        } else { msg = "Not enough coins!"; }
    }
    else if (item == 'card_box') {
        if (c.coins >= 150) {
            c.coins -= 150
            def rnd = Math.random()
            if (rnd < 0.25) {
                // Big Reward
                addChickenXp(uid, 200)
                adjustCoins(uid, 200)
                msg = "üì¶ BIG PRIZE! +200 XP +200 Coins"; status = "success"
            } else {
                // Small Reward
                addChickenXp(uid, 10)
                adjustCoins(uid, 10)
                msg = "üì¶ Small Prize... +10 XP +10 Coins"; status = "success"
            }
            c = getChickenData(uid)
            atomicState["chicken_${uid}"] = c
        } else { msg = "Need 150 coin"; }
    }
    else if (item == 'hormone') {
        if(c.level >= 10) { msg = "Max Level Reached!"; } 
        else {
            def hormones = atomicState["dailyHormones_${uid}"] ?: 0
            if (hormones >= 5) { msg = "Sold Out (Max 5/day)"; }
            else if (c.coins >= 100) {
                c.coins -= 100
                addChickenXp(uid, 100)
                atomicState["dailyHormones_${uid}"] = hormones + 1
                msg = "Growth Hormones Applied! +100 XP"; status = "success"
            } else { msg = "Not enough coins!"; }
        }
    }
    else if (item == 'super_feed') {
        def sFeeds = atomicState["dailySuperFeeds_${uid}"] ?: 0
        if (!c.inventory) c.inventory = [:]
        def currentInv = (c.inventory.super_feed ?: 0)
        
        if (sFeeds >= 2) { msg = "Sold Out (Max 2/day)"; }
        else if (currentInv >= 4) { msg = "Inventory Full (Max 4)"; }
        else if (c.coins >= 200) {
            c.coins -= 200
            c.inventory.super_feed = currentInv + 1
            atomicState["dailySuperFeeds_${uid}"] = sFeeds + 1
            atomicState["chicken_${uid}"] = c
            msg = "Super Feed Purchased!"; status = "success"
        } else { msg = "Not enough coins!"; }
    }
    // New Item: Chicken Sword
    else if (item == 'chicken_sword') {
        if (!c.inventory) c.inventory = [:]
        if (c.level < 10) { msg = "Level 10 Required!"; }
        else if ((c.inventory.chicken_sword ?: 0) > 0) { msg = "You already own the Chicken Sword!"; }
        else if (c.coins >= 1000) {
            c.coins -= 1000
            c.inventory.chicken_sword = 1
            c.stats.atk += 100
            atomicState["chicken_${uid}"] = c
            msg = "Chicken Sword Purchased! (+100 ATK)"; status = "success"
        } else { msg = "Need 1000 coins"; }
    }
    // New Item: Chicken Shield
    else if (item == 'chicken_shield') {
        if (!c.inventory) c.inventory = [:]
        if (c.level < 10) { msg = "Level 10 Required!"; }
        else if ((c.inventory.chicken_shield ?: 0) > 0) { msg = "You already own the Chicken Shield!"; }
        else if (c.coins >= 1000) {
            c.coins -= 1000
            c.inventory.chicken_shield = 1
            c.stats.def += 100
            atomicState["chicken_${uid}"] = c
            msg = "Chicken Shield Purchased! (+100 DEF)"; status = "success"
        } else { msg = "Need 1000 coins"; }
    }

    checkDaily(uid, "shop")
    render contentType: "application/json", data: JsonOutput.toJson([status: status, msg: msg])
}

// Standard Helpers
def checkDaily(uid, type) {
    if(!uid || uid==0) return
    def d = atomicState["dailys_${uid}"] ?: [post:false, reply:false, like:false, battle:false, shop:false, login:false, hospital:false, adventure:false, collected:false]
    if(d.collected) return
    if(!d.containsKey('adventure')) d.adventure = false
    if(d[type] == false) {
        d[type] = true
        if(d.post && d.reply && d.like && d.battle && d.shop && d.login && d.hospital && d.adventure) {
             d.collected = true
            addChickenXp(uid, 15)
            adjustCoins(uid, 5)
        }
        atomicState["dailys_${uid}"] = d
    }
}

def addChickenXp(uid, amt) {
    def c = getChickenData(uid)
    // Strict Level 10 Cap
    if(c.level < 10) { 
        c.xp += amt
        def leveledUp = false

        // Calculate logic in memory first
        while(c.level < 10 && c.xp >= c.xpToNext) { 
            c.level++
            c.xp -= c.xpToNext
            c.xpToNext = (c.xpToNext*1.5).toInteger()
            c.pts += 3
            c.stats.hp += 10
            c.currentHp += 10
            c.stats.atk += 1
            c.stats.def += 1
            leveledUp = true
        } 

        if(c.level >= 10) { c.xp = 0; c.xpToNext = 0; }

        // Write to DB ONLY ONCE after calculations are done
        atomicState["chicken_${uid}"] = c

        if (leveledUp) {
            def userName = getUserName(uid)
            addPostToFeed(0,"system","üéâ <b>${userName}</b>'s chicken <b>${c.name}</b> reached Lvl ${c.level}!","happy") 
        }
    } else {
        // Just save the XP change if no level up
        atomicState["chicken_${uid}"] = c
    }
}

def removeChickenXp(uid, amt) { def c=getChickenData(uid); c.xp=Math.max(0,c.xp-amt); atomicState["chicken_${uid}"]=c }
def adjustCoins(uid, amt) { def c=getChickenData(uid); c.coins=(c.coins?:0)+amt; atomicState["chicken_${uid}"]=c }
def getUserName(id) { if(id==0)return "Home"; return settings["userName_${id}"]?:"User ${id}" }

def getUsersList() {
    def l = []
    def now = new Date().time
    for(int i=1;i<=8;i++) if(settings["userEnabled_${i}"]) {
        def last = atomicState["lastSeen_${i}"]
        def c = getChickenData(i)
        def isWounded = atomicState["isWounded_${i}"] ?: false
        def prog = atomicState["advProgress_${i}"] ?: [:]
        
        // Removed Skeleton Icon Logic (Badge removed upon defeating skeleton as requested)
        def isSlayer = false 
        
        // Farmer Icon Check (24 Hours)
        def isFarmer = atomicState["isFarmerBadge_${i}"] ?: false
        
        l << [
            id:i, name:settings["userName_${i}"]?:"User ${i}", chicken:c.name, 
            icon:c.icon, avatar:atomicState["avatar_${i}"]?:(settings["userAvatar_${i}"]?:"üôÇ"), 
            lastSeen:last, hp: c.currentHp, maxHp: c.stats.hp,
            isWounded: isWounded, isSlayer: isSlayer, isFarmer: isFarmer
        ]
    }
    return l
}

def getWeeklyLeader() { 
    def max=0; def l=-1; 
    for(int i=1;i<=8;i++) { def c=atomicState["weeklyCount_${i}"]?:0; if(c>max){max=c; l=i} }
    return l 
}

def addPostToFeed(uid, type, msg, mood) {
    def pid = UUID.randomUUID().toString()
    def p = [id:pid, uid:uid, type:type, msg:msg, mood:mood, ts:new Date().time, replies:[], reactions:[], eaters:[:]]
    atomicState["p_${pid}"] = p
    def ids = atomicState.postIDs ?: []; ids.add(pid); atomicState.postIDs = ids
    touchActivity()
}

def addNotification(uid, msg) { def l = atomicState["notifs_${uid}"] ?: []; l<<msg; atomicState["notifs_${uid}"]=l }
def incrementWeeklyCount(uid) { if(uid==0)return; atomicState["weeklyCount_${uid}"] = (atomicState["weeklyCount_${uid}"]?:0)+1 }
def decrementWeeklyCount(uid) { if(uid==0)return; atomicState["weeklyCount_${uid}"] = Math.max(0, (atomicState["weeklyCount_${uid}"]?:0)-1) }

def checkRateLimit(uid, type) { 
    if(uid == (settings.adminUserId as Integer)) return [allowed:true]
    def limit = (type == "post") ? 2 : 5
    def window = 300000 
    def now = new Date().time
    def key = "timestamps_${type}_${uid}"
    def history = atomicState[key] ?: []
    history = history.findAll { (now - it) < window }
    if (history.size() >= limit) return [allowed:false, wait: (window - (now - history.min()))/1000]
    history << now
    atomicState[key] = history
    return [allowed:true]
}

def processBattleLogic(c1, c2, isPvE) {
    def hp1 = (c1.currentHp != null) ? c1.currentHp : c1.stats.hp
    def hp2 = (c2.currentHp != null) ? c2.currentHp : c2.stats.hp
    hp1 = hp1.toInteger()
    hp2 = hp2.toInteger()
    def maxHp1 = c1.stats.hp
    def maxHp2 = c2.stats.hp
    def turns = []
    
    // Initial State
    turns << [msg: "Battle Start!", attHp: hp1, defHp: hp2]
    
    int turnCount = 0
    def rand = new Random()
    def isFarmer = (c2.name == "Crazy Farmer")
    
    while(hp1 > 0 && hp2 > 0 && turns.size() < 25) {
        turnCount++
       
        // --- TURN 1: Player Attacking Enemy ---
        def playerCrushChance = (c1.level <= 5) ? 1.0 : 2.0
        def isPlayerCrush = (rand.nextFloat() * 100) < playerCrushChance
        def dmg1 = [dmg:0, msg:"", event:""]
        if (isPlayerCrush) {
            dmg1.dmg = maxHp2
            dmg1.msg = "‚öîÔ∏è <b>ONE SHOT!</b> (-${maxHp2})"
            dmg1.event = "crush"
        } else {
              dmg1 = calcDamage(c1, c2)
        }
        
        hp2 -= dmg1.dmg
        turns << [msg: "${c1.name} ${dmg1.msg}", attHp: hp1, defHp: Math.max(0, hp2), event: dmg1.event]
        
        // Feed Logic (Enemy)
        if(hp2 <= 0 && !isPvE && (c2.inventory.feed ?: 0) > 0 && rand.nextFloat() < 0.50) {
            c2.inventory.feed--
            hp2 = maxHp2
            turns << [msg: "üêî ${c2.name} eats Feed! FULLY HEALED!", attHp: hp1, defHp: hp2, event: "heal"]
        }
        if(hp2 <= 0) break
   
        // --- TURN 2: Enemy Attacking Player ---
        def enemyCrushChance = isFarmer ? 3.0 : 0.5 
        def isEnemyCrush = (rand.nextFloat() * 100) < enemyCrushChance
        def dmg2 = [dmg:0, msg:"", event:""]
        
        if (isEnemyCrush) {
             dmg2.dmg = maxHp1
             dmg2.msg = "‚öîÔ∏è <b>ONE SHOT!</b> (-${maxHp1})"
             dmg2.event = "crush"
        } else {
              dmg2 = calcDamage(c2, c1)
        }

        hp1 -= dmg2.dmg
        turns << [msg: "${c2.name} ${dmg2.msg}", attHp: Math.max(0, hp1), defHp: Math.max(0, hp2), event: dmg2.event]
        
        if (isFarmer && hp1 > 0 && rand.nextFloat() < 0.10) {
             def dmg2b = calcDamage(c2, c1)
             hp1 -= dmg2b.dmg
             turns << [msg: "${c2.name} <b>DOUBLE ATTACK!</b> ${dmg2b.msg}", attHp: Math.max(0, hp1), defHp: Math.max(0, hp2), event: "crit"]
        }
        
        // --- HEALING LOGIC ---
        if(hp1 <= 0) {
            // Priority 1: Super Feed (Boss Only) - 100% Chance
            if (c2.isBoss && (c1.inventory.super_feed ?: 0) > 0) {
                c1.inventory.super_feed--
                hp1 = maxHp1
                turns << [msg: "üåü <b>${c1.name}</b> used SUPER FEED! 100% REVIVE!", attHp: hp1, defHp: hp2, event: "heal"]
            }
            // Priority 2: Standard Feed - 50% Chance
            else if (hp1 <= 0 && (c1.inventory.feed ?: 0) > 0 && rand.nextFloat() < 0.50) {
                 c1.inventory.feed--
                hp1 = maxHp1
                turns << [msg: "üêî ${c1.name} eats Feed! FULLY HEALED!", attHp: hp1, defHp: hp2, event: "heal"]
            }
        }
    }
    def won = (hp1 > 0)
    if(won) turns << [msg: "${c1.name} Wins!", attHp: Math.max(0, hp1), defHp: 0]
    else turns << [msg: "${c2.name} Wins!", attHp: 0, defHp: Math.max(0, hp2)]
    
    return [won: won, turns: turns, maxHp: [att: maxHp1, def: maxHp2], remainingHp: hp1]
}
def calcDamage(att, defs) {
    def critChance = 0
    if(att.isEnemy) {
        critChance = (att.isBoss) ? 2 : 1
    } else {
        critChance = Math.min(5, att.stats.crit ?: 5)
        // FIXED: Actually checking for the sword now
        if (att.inventory?.chicken_sword) { critChance += 10 }
    }
    
    def isCrit = (Math.random()*100) < critChance
    def d = Math.max(1, (att.stats.atk - (defs.stats.def * 0.5)).toInteger())
    
    if(isCrit) d *= 2
    if(Math.random()*100 < 5) return [dmg: 0, msg: "Missed!", event: "miss"]
    return [dmg: d, msg: "‚öîÔ∏è ${d}" + (isCrit ? " Critical!" : ""), event: isCrit ? "crit" : ""]
}

def handleAdventureExplore() {
    try {
        def uid = params.uid?.toInteger()
        def zone = params.zone 
        if (!uid) { render contentType: "application/json", data: JsonOutput.toJson([status: "error", msg: "User ID missing"]); return }

        // Unconscious Check
        if (atomicState["isWounded_${uid}"]) {
            render contentType: "application/json", data: JsonOutput.toJson([status: "error", msg: "You are Unconscious! Go to Hospital."])
            return
        }

        def c = getChickenData(uid)
        
        // Dynamic Max Energy (Capped at Lvl 10)
        def maxE = 6
        if(c.level >= 5) maxE = 8
        if(c.level >= 10) maxE = 10
        
        def tokens = atomicState["advTokens_${uid}"]
        if (tokens == null) { tokens = maxE; atomicState["advTokens_${uid}"] = maxE }
        
        // Check Daily Boss Limits (Attempts & Wins)
        def prog = atomicState["advProgress_${uid}"] ?: [
            wilds:0, spooky:0, crazy:0, 
            boss1:false, boss2:false, boss3:false, bossFarmer:false,
            boss1Att:false, boss2Att:false, boss3Att:false, bossFarmerAtt:0
        ]
        
        // Boss 1, 2, 3 Daily Limits
        if (zone == "boss_hawk" && (prog.boss1Att || prog.boss1)) { 
            render contentType: "application/json", data: JsonOutput.toJson([status: "error", msg: "Already attempted Raven today!"]); return 
        }
        if (zone == "boss_owl" && (prog.boss2Att || prog.boss2)) { 
            render contentType: "application/json", data: JsonOutput.toJson([status: "error", msg: "Already attempted Owl today!"]); return 
        }
        if (zone == "boss_skeleton" && (prog.boss3Att || prog.boss3)) { 
            render contentType: "application/json", data: JsonOutput.toJson([status: "error", msg: "Already attempted Skeleton today!"]); return 
        }
        
        // Boss Farmer - Final Boss Logic (2 attempts)
        def farmerAttempts = (prog.bossFarmerAtt instanceof Integer) ? prog.bossFarmerAtt : (prog.bossFarmerAtt ? 1 : 0)
        if (zone == "boss_farmer") {
             if (farmerAttempts >= 2 || prog.bossFarmer) {
                 render contentType: "application/json", data: JsonOutput.toJson([status: "error", msg: "No attempts remaining for Crazy Farmer today!"]); return 
             }
        }

        def cost = (zone == "wilds" || zone == "spooky" || zone == "crazy_house") ? 1 : 0
        if (cost > 0 && tokens < cost) {
            render contentType: "application/json", data: JsonOutput.toJson([status: "error", msg: "Out of exploration tokens!"])
            return
        }
        if (cost > 0) atomicState["advTokens_${uid}"] = tokens - cost
        
        def enemy = null
        def isBoss = false
        def rnd = new Random()
        
        // Define Enemy
        if (zone == "wilds") {
            def enemies = [
                [name: "Snake", icon: "üêç", scale: 0.8, stories: ["A Snake slithered out!", "A Snake guards the path!"]],
                [name: "Fox", icon: "ü¶ä", scale: 1.0, stories: ["A Fox jumped from the bushes!", "A hungry Fox appeared!"]],
                [name: "Grub", icon: "üêõ", scale: 0.5, stories: ["A giant Grub crawled out!", "A Grub looks tasty but fights back!"]]
            ]
            enemy = enemies[rnd.nextInt(enemies.size())]
        } 
        else if (zone == "spooky") {
            if (c.level < 5) {
                render contentType: "application/json", data: JsonOutput.toJson([status: "error", msg: "Spooky House requires Level 5+"])
                return
            }
            def enemies = [
                [name: "Mouse", icon: "üê≠", scale: 0.9, stories: ["A Mouse squeaked aggressively!", "A Mouse defends its cheese!"]],
                [name: "Spider", icon: "üï∑Ô∏è", scale: 1.1, stories: ["A huge Spider drops down!", "A Spider webs the path!"]],
                [name: "Bat", icon: "ü¶á", scale: 1.2, stories: ["A Bat swoops down!", "A Bat screeches loudly!"]]
            ]
            enemy = enemies[rnd.nextInt(enemies.size())]
        }
        else if (zone == "crazy_house") {
            if (c.level < 10) {
                render contentType: "application/json", data: JsonOutput.toJson([status: "error", msg: "Crazy Farmer's House requires Level 10"])
                return
            }
            def enemies = [
                [name: "Barn Rat", icon: "üêÄ", scale: 1.0, stories: ["A giant Barn Rat gnaws at you!", "The Rat defends the grain!"]],
                [name: "Feral Cat", icon: "üêà", scale: 1.2, stories: ["A Feral Cat hisses!", "A Cat blocks the barn door!"]],
                [name: "Guard Dog", icon: "üêï", scale: 1.3, stories: ["The Guard Dog barks loudly!", "A Dog chases you!"]]
            ]
            enemy = enemies[rnd.nextInt(enemies.size())]
        }
        else if (zone == "boss_hawk") {
             enemy = [name: "The Raven", icon: "ü¶Ö", stories: ["The Boss Raven attacks!", "Defend the Coop from The Raven!"]]
             isBoss = true
        }
        else if (zone == "boss_owl") {
             enemy = [name: "Spooky Owl", icon: "ü¶â", stories: ["The Spooky Boss Owl appears!", "Defend the Coop from the Ghost Owl!"]]
             isBoss = true
        }
        else if (zone == "boss_skeleton") {
             enemy = [name: "Scary Skeleton", icon: "üíÄ", stories: ["The Boss Skeleton rattles its bones!", "Defend the Coop from the Skeleton!"]]
             isBoss = true
        }
        else if (zone == "boss_farmer") {
             // Strict Prerequisites
             if ((prog.crazy ?: 0) < 6 || !prog.boss1 || !prog.boss2 || !prog.boss3) {
                  render contentType: "application/json", data: JsonOutput.toJson([status: "error", msg: "Locked! You must defeat all 3 sub-bosses and win 6 times at Crazy House first."])
                  return
             }
             enemy = [name: "Crazy Farmer", icon: "üë®‚Äçüåæ", stories: ["The Crazy Farmer is angry!", "Get off my lawn!"]]
             isBoss = true
        }
        else { render contentType: "application/json", data: JsonOutput.toJson([status: "error", msg: "Invalid Zone"]); return }

        // --- BOSS SCALING LOGIC ---
        // CALCULATE BASE STATS WITHOUT SPECIAL ITEMS
        // The enemies should NOT scale with the +50 Sword/Shield bonus
        def hasSword = (c.inventory.chicken_sword ?: 0) > 0
        def hasShield = (c.inventory.chicken_shield ?: 0) > 0
        def baseAtk = c.stats.atk - (hasSword ? 100 : 0)
        def baseDef = c.stats.def - (hasShield ? 100 : 0)

        def multipliers = []
        if (zone == "boss_hawk" || zone == "boss_owl") {
            multipliers = [0.5, 1.0, 2.0]
        } else if (zone == "boss_skeleton") {
            multipliers = [0.5, 1.0, 2.0, 3.0]
        } else if (zone == "boss_farmer") {
            multipliers = [1.5, 2.0, 3.0, 4.0, 5.0]
        } else {
            multipliers = [enemy.scale ?: 1.0] 
        }
        
        def selectedMult = multipliers[rnd.nextInt(multipliers.size())]
        def variance = (rnd.nextFloat() * 0.2) - 0.1 
        if (isBoss) variance = 0
        def finalScale = selectedMult + variance
        if (finalScale < 0.1) finalScale = 0.1

        def estats = [hp:100, atk:10, def:5, crit:1]
        // Enemy Stats calculated based on BASE stats (not boosted stats)
        estats.hp = Math.max(10, (c.stats.hp * finalScale).toInteger())
        estats.atk = Math.max(1, (baseAtk * finalScale).toInteger())
        estats.def = Math.max(1, (baseDef * finalScale).toInteger())
        estats.crit = 1 
       
        def story = enemy.stories[rnd.nextInt(enemy.stories.size())]
        if (isBoss) story += " (Scale: ${selectedMult}x)" 

        // Pass isPvE=true
        def battleData = processBattleLogic(c, [name: enemy.name, level: c.level, stats: estats, currentHp: estats.hp, inventory:[:], icon: enemy.icon, isEnemy:true, isBoss:isBoss], true)
        
        checkDaily(uid, "adventure")
        c.currentHp = c.stats.hp
         
        def rewardData = [xp:0, coins:0, title:"Victory!", sub:"Battle Won"]
        def bossDefeatedStr = null

        // Record Attempts immediately
        if (zone == "boss_hawk") prog.boss1Att = true
        else if (zone == "boss_owl") prog.boss2Att = true
        else if (zone == "boss_skeleton") prog.boss3Att = true
        else if (zone == "boss_farmer") prog.bossFarmerAtt = (prog.bossFarmerAtt ?: 0) + 1

        if(battleData.won) {
             def xp = 20; def coins = 5
            
            if(zone == "wilds") {
                prog.wilds = (prog.wilds ?: 0) + 1
                if(prog.wilds == 3) { xp += 20; coins += 10; rewardData.title = "Wilds Master!"; rewardData.sub = "Daily Bonus: 3 Wins"; }
            }
            else if(zone == "spooky") {
                xp = 50; coins = 25
                prog.spooky = (prog.spooky ?: 0) + 1
                if(prog.spooky == 3) { xp += 20; coins += 10; rewardData.title = "Spooky Master!"; rewardData.sub = "Daily Bonus: 3 Wins"; }
            }
            else if(zone == "crazy_house") {
                xp = 60; coins = 40
                prog.crazy = (prog.crazy ?: 0) + 1
                if(prog.crazy == 6) { 
                     xp += 40; coins += 20;
                    rewardData.title = "Crazy House Master!"; rewardData.sub = "Farmer Unlocked! (+40xp +20c)";
                }
            }
            else if(zone == "boss_hawk") {
                prog.boss1 = true; xp += 50; coins += 50; 
                rewardData.title = "Raven Defeated!"; rewardData.sub = "Daily Boss Bonus"; bossDefeatedStr = "raven"
                addPostToFeed(0, "system", "ü¶Ö <b>ACCOMPLISHMENT UNLOCKED:</b> <b>${c.name}</b> defeated the <b>Raven</b>!", "excited")
            }
            else if(zone == "boss_owl") {
                prog.boss2 = true; xp += 50; coins += 50; 
                rewardData.title = "Owl Defeated!"; rewardData.sub = "Daily Boss Bonus"; bossDefeatedStr = "owl"
                addPostToFeed(0, "system", "ü¶â <b>NIGHT WATCH:</b> <b>${c.name}</b> banished the <b>Spooky Owl</b>!", "excited")
            }
            else if(zone == "boss_skeleton") {
                prog.boss3 = true; xp += 100; coins += 100; 
                rewardData.title = "Skeleton Destroyed!"; rewardData.sub = "Legendary Bonus"; bossDefeatedStr = "skeleton"
                addPostToFeed(0, "system", "üíÄ <b>LEGENDARY HERO:</b> <b>${c.name}</b> destroyed the <b>Skeleton Boss</b>!", "excited")
            }
            else if(zone == "boss_farmer") {
                prog.bossFarmer = true; xp += 200; coins += 200;
                
                if (!c.inventory) c.inventory = [feed:0]
                c.inventory.feed = (c.inventory.feed ?: 0) + 2
                c.pts += 10
                atomicState["farmerWinTime_${uid}"] = new Date().time
                
                def boxRnd = Math.random()
                def boxMsg = ""
                if (boxRnd < 0.25) {
                    addChickenXp(uid, 200)
                    adjustCoins(uid, 200)
                    boxMsg = "Box contained BIG PRIZE (+200xp/200c)!"
                } else {
                    addChickenXp(uid, 10)
                    adjustCoins(uid, 10)
                    boxMsg = "Box contained Small Prize (+10xp/10c)."
                }

                rewardData.title = "FARMER DEFEATED!"; rewardData.sub = "200XP/200c (The Barn is Yours) + Items! ${boxMsg}"; bossDefeatedStr = "farmer"
                addPostToFeed(0, "system", "üë®‚Äçüåæ <b>ULTIMATE CHAMPION:</b> <b>${c.name}</b> defeated the <b>Crazy Farmer</b>! The barn is ours!", "excited")
            }
            
            addChickenXp(uid, xp)
            adjustCoins(uid, coins)
            c.advWins = (c.advWins ?: 0) + 1
            atomicState["chicken_${uid}"] = c
            atomicState["advProgress_${uid}"] = prog
            rewardData.xp = xp; rewardData.coins = coins
        } else {
            c.advLoss = (c.advLoss ?: 0) + 1
            atomicState["chicken_${uid}"] = c
            atomicState["advProgress_${uid}"] = prog 
            
            def losses = (atomicState["advLossCount_${uid}"] ?: 0) + 1
            atomicState["advLossCount_${uid}"] = losses
            if (losses >= 2) {
                atomicState["isWounded_${uid}"] = true
                atomicState["woundedTime_${uid}"] = new Date().time
                addNotification(uid, "üöë Knocked Unconscious by ${enemy.name}!")
            } else {
                  addNotification(uid, "‚ö†Ô∏è Defeated by ${enemy.name}. One more loss = Unconscious!")
            }
        }
        
        touchActivity()
        render contentType: "application/json", data: JsonOutput.toJson([
            status: "success", found: true, 
            enemyName: enemy.name, enemyIcon: enemy.icon, introText: story,
            turns: battleData.turns, maxHp: battleData.maxHp, losses: (atomicState["advLossCount_${uid}"] ?: 0),
            won: battleData.won, reward: rewardData,
            bossDefeated: bossDefeatedStr
        ])
    } catch (e) {
        log.error "Adventure Error: ${e}"
        render contentType: "application/json", data: JsonOutput.toJson([status: "error", msg: "System Error: ${e.getMessage()}"])
    }
}
/**
 * Family Pulse Pro V30 (Modified)
 * Part 3/5
 */

def handleForagingExplore() {
    try {
        def uid = params.uid?.toInteger()
        if (!uid) { render contentType: "application/json", data: JsonOutput.toJson([status: "error", msg: "User ID missing"]); return }

        if (atomicState["isWounded_${uid}"]) {
            render contentType: "application/json", data: JsonOutput.toJson([status: "error", msg: "You are Unconscious! Go to Hospital."])
            return
        }

        def c = getChickenData(uid)
        def maxE = 6
        if(c.level >= 5) maxE = 8
        if(c.level >= 10) maxE = 10
        def tokens = atomicState["advTokens_${uid}"]
        if (tokens == null) { tokens = maxE; atomicState["advTokens_${uid}"] = maxE }
        
        if (tokens <= 0) {
            render contentType: "application/json", data: JsonOutput.toJson([status: "error", msg: "Out of Energy!"])
            return
        }
        
        atomicState["advTokens_${uid}"] = tokens - 1
        
        def rnd = new Random().nextInt(100) 
        def res = [:]
        
        if (rnd < 60) { 
            addChickenXp(uid, 25)
            res = [title:"Foraged: Herbs", sub:"Useful herbs found!", icon:"üåø", xp:25, coins:0]
        } else if (rnd < 90) { 
            adjustCoins(uid, 25)
            res = [title:"Foraged: Coins", sub:"Small coin stash!", icon:"üí∞", xp:0, coins:25]
        } else if (rnd < 96) { 
            if (!c.inventory) c.inventory = [feed:0]
            c.inventory.feed = (c.inventory.feed ?: 0) + 1
            atomicState["chicken_${uid}"] = c
            res = [title:"Foraged: Feed", sub:"Added to Inventory", icon:"üåΩ", xp:0, coins:0]
        } else if (rnd < 99) { 
            c.pts += 5
            atomicState["chicken_${uid}"] = c
            res = [title:"Foraged: Steroid", sub:"+5 Stat Points (Applied)", icon:"üíâ", xp:0, coins:0]
        } else { 
            addChickenXp(uid, 100)
            adjustCoins(uid, 100)
            if (!c.inventory) c.inventory = [feed:0]
            c.inventory.feed = (c.inventory.feed ?: 0) + 2
            c.pts += 10
            atomicState["chicken_${uid}"] = c
            res = [title:"TREASURE CHEST!", sub:"100XP, 100 Coin, 2 Feed, 2 Steroids!", icon:"üíé", xp:100, coins:100]
       }
         
        checkDaily(uid, "adventure")
        touchActivity()
        render contentType: "application/json", data: JsonOutput.toJson([status: "success", result: res])
        
    } catch (e) {
        log.error "Forage Error: ${e}"
        render contentType: "application/json", data: JsonOutput.toJson([status: "error", msg: "System Error: ${e.getMessage()}"])
    }
}

def handleHealChicken() {
    def uid = params.uid.toInteger()
    def c = getChickenData(uid)
    def isWounded = atomicState["isWounded_${uid}"]
    
    if (!isWounded) {
        render contentType: "application/json", data: JsonOutput.toJson([status: "error", msg: "Hospital only treats Unconscious chickens!"])
        return
    }
    if (c.coins >= 20) {
        c.coins -= 20
        c.currentHp = c.stats.hp 
        atomicState["chicken_${uid}"] = c
        atomicState["isWounded_${uid}"] = false
        atomicState["advLossCount_${uid}"] = 0 
        atomicState.remove("woundedTime_${uid}")
        render contentType: "application/json", data: JsonOutput.toJson([status: "success", msg: "Revived!"])
    } else {
        render contentType: "application/json", data: JsonOutput.toJson([status: "error", msg: "Not enough coins!"])
    }
}

// Standard Commands
def handlePost() {
    def uid = params.uid.toInteger()
    if(!checkRateLimit(uid, "post").allowed) { render contentType: "application/json", data: JsonOutput.toJson([status: "rate_limited", msg: "Slow down!"]); return }
    def mood = params.mood; if (mood) atomicState["mood_${uid}"] = mood
    incrementWeeklyCount(uid)
    addChickenXp(uid, 20)
    if(params.pinned == "true") atomicState.bulletin = [id: UUID.randomUUID().toString(), msg: params.msg, uid: uid, ts: new Date().time, replies: [], reactions: []]
    else addPostToFeed(uid, "status", params.msg, mood)
    checkDaily(uid, "post")
    render contentType: "application/json", data: JsonOutput.toJson([status: "success", xp: 20])
}
def handleReply() {
    def uid = params.uid.toInteger()
    if(!checkRateLimit(uid, "reply").allowed) { render contentType: "application/json", data: JsonOutput.toJson([status: "rate_limited", msg: "Slow down!"]); return }
    def isBul = (atomicState.bulletin?.id == params.postId)
    def isAnn = (params.postId == "announcement")
    def post = isBul ? atomicState.bulletin : (isAnn ? atomicState.announcementData : atomicState["p_${params.postId}"])
    if (post || isAnn) {
        if(isAnn && !post) post = [replies:[], reactions:[]]
        if (!post.replies) post.replies = []
        post.replies << [uid: uid, msg: params.msg, ts: new Date().time, reactions: []]
        incrementWeeklyCount(uid)
        addChickenXp(uid, 10)
        if(post.uid && post.uid != uid && post.uid != 0) addNotification(post.uid, "${getUserName(uid)} replied to you")
        if(isBul) atomicState.bulletin = post
        else if(isAnn) atomicState.announcementData = post
        else atomicState["p_${params.postId}"] = post
        checkDaily(uid, "reply")
        touchActivity()
    }
    render contentType: "application/json", data: JsonOutput.toJson([status: "success", xp: 10])
}
def handleDeletePost() {
    def p = atomicState["p_${params.postId}"]
    if(p) {
        decrementWeeklyCount(p.uid); removeChickenXp(p.uid, 20)
        atomicState.remove("p_${params.postId}")
        def ids = atomicState.postIDs; ids.remove(params.postId); atomicState.postIDs = ids
        touchActivity()
    }
    render contentType: "application/json", data: JsonOutput.toJson([status: "success"])
}
def handleDeleteReply() {
    def uid = params.uid ? params.uid.toInteger() : 0
    def isBul = (atomicState.bulletin?.id == params.postId)
    def isAnn = (params.postId == "announcement")
    def post = isBul ? atomicState.bulletin : (isAnn ? atomicState.announcementData : atomicState["p_${params.postId}"])
    if(post && post.replies) {
        def reply = post.replies.find { it.ts == params.ts.toLong() }
        if(reply) {
            post.replies.remove(reply)
            if(isBul) atomicState.bulletin = post
            else if(isAnn) atomicState.announcementData = post
            else atomicState["p_${params.postId}"] = post
            touchActivity()
        }
    }
    render contentType: "application/json", data: JsonOutput.toJson([status: "success"])
}
def handleReact() {
    def uid = params.uid.toInteger()
    def isBul = (atomicState.bulletin?.id == params.postId)
    def isAnn = (params.postId == "announcement")
    def post = isBul ? atomicState.bulletin : (isAnn ? atomicState.announcementData : atomicState["p_${params.postId}"])
    if (post || isAnn) {
        if(isAnn && !post) post = [replies:[], reactions:[]]
        if(post.uid && post.uid == uid && !isAnn) { render contentType:"application/json", data:JsonOutput.toJson([status:"error", msg:"Self vote rejected"]); return }
        if(!post.reactions) post.reactions = []
        def existing = post.reactions.find { it.uid == uid }
        if(existing) { 
            if(existing.emote == params.emoji) { 
                post.reactions.remove(existing); if(post.uid && post.uid!=uid) adjustCoins(post.uid, -5) 
            }
            else existing.emote = params.emoji 
        } else { 
            post.reactions.add([uid:uid, emote:params.emoji]); if(post.uid && post.uid!=uid) {
                adjustCoins(post.uid, 5) 
                addNotification(post.uid, "üëç Someone liked your post")
            }
        }
        if(isBul) atomicState.bulletin = post
        else if(isAnn) atomicState.announcementData = post
        else atomicState["p_${params.postId}"] = post
        checkDaily(uid, "like")
        touchActivity()
    }
    render contentType: "application/json", data: JsonOutput.toJson([status: "success"])
}
def handleReplyReact() {
    def isBul = (atomicState.bulletin?.id == params.postId)
    def isAnn = (params.postId == "announcement")
    def post = isBul ? atomicState.bulletin : (isAnn ? atomicState.announcementData : atomicState["p_${params.postId}"])
    if(post) {
        def r = post.replies ? post.replies.find { it.ts == params.ts.toLong() } : null
        if(r) {
            if(r.uid == params.uid.toInteger()) { render contentType:"application/json", data:JsonOutput.toJson([status:"error", msg:"Self vote rejected"]); return }
            if(!r.reactions) r.reactions = []
            def existing = r.reactions.find { it.uid == params.uid.toInteger() }
            if(existing) {
                if(existing.type == params.type) { r.reactions.remove(existing) }
                else { existing.type = params.type }
             } else {
                r.reactions.add([uid:params.uid.toInteger(), type:params.type])
            }
            if(params.type == 'down' && r.uid && r.uid!=params.uid.toInteger()) {
                def targetC = getChickenData(r.uid)
                if(targetC.coins >= 5) adjustCoins(r.uid, -5)
              }
            checkDaily(params.uid.toInteger(), "like")
            if(isBul) atomicState.bulletin = post
            else if(isAnn) atomicState.announcementData = post
            else atomicState["p_${params.postId}"] = post
            touchActivity()
        }
    }
    render contentType:"application/json", data:JsonOutput.toJson([status:"success"])
}
def handleChickenRename() { def c=getChickenData(params.uid.toInteger()); c.name=params.name; atomicState["chicken_${params.uid}"]=c; touchActivity(); render contentType:"application/json", data:JsonOutput.toJson([status:"success"]) }
def handleChickenTrain() {
    def c = getChickenData(params.uid.toInteger())
    if(c.pts > 0) {
        if(params.stat=="hp") { c.stats.hp+=10; c.currentHp+=10; }
        if(params.stat=="atk") c.stats.atk+=1; 
        if(params.stat=="def") c.stats.def+=1;
        if(params.stat=="crit") c.stats.crit+=1;
        c.pts--; atomicState["chicken_${params.uid}"] = c; touchActivity()
    }
    render contentType: "application/json", data: JsonOutput.toJson([status: "success"])
}
def handleChickenFarm() {
    def uid = params.uid.toInteger(); def now = new Date().time
    // Unconscious Check
    if(atomicState["isWounded_${uid}"]) {
        render contentType: "application/json", data: JsonOutput.toJson([status: "error", msg: "You are Unconscious! Go to Hospital."])
        return
    }
    atomicState["farmCooldown_${uid}"] = now + 86400000
    for(int i=1;i<=8;i++) if(i!=uid) atomicState["cooldown_${uid}_${i}"] = now + 21600000
    def c = getChickenData(uid); def won = false;
    if(Math.random()*100 < (50+(c.level*2))) { 
        addChickenXp(uid,50); adjustCoins(uid,10); won = true;
        addPostToFeed(uid, "system", "üêî <b>${c.name}</b> worked hard at the farm! (+50 XP, +10 Coins)", "happy")
        def d = atomicState["dailys_${uid}"] ?: [dailyWins:0]
        atomicState["dailys_${uid}"] = d
    } else {
        addPostToFeed(uid, "system", "üêî <b>${c.name}</b> went to the farm but slacked off... (No Reward)", "tired")
    }
    checkDaily(uid, "battle")
    atomicState["farmResult_${uid}"] = won
    touchActivity()
    render contentType: "application/json", data: JsonOutput.toJson([status: "success", won: won])
}
def handleClearReward() { atomicState.remove("farmResult_${params.uid}"); render contentType: "application/json", data: JsonOutput.toJson([status: "success"]) }
def handleHabitReset() { dailyReset(); render contentType: "application/json", data: JsonOutput.toJson([status: "success"]) }
def handleHabitComplete() {
    def uid = params.uid.toInteger()
    def d = [post:true, reply:true, like:true, battle:true, shop:true, login:true, hospital:true, adventure:true, collected:true]
    addChickenXp(uid, 15); adjustCoins(uid, 5)
    atomicState["dailys_${uid}"] = d
    render contentType: "application/json", data: JsonOutput.toJson([status: "success", msg: "Dailys Completed"])
}
def handleShopVisit() { checkDaily(params.uid.toInteger(), "shop"); render contentType: "application/json", data: JsonOutput.toJson([status: "success"]) }
def handleChurchTithe() {
    def uid = params.uid.toInteger()
    def c = getChickenData(uid)
    
    if (c.coins < 10) {
        render contentType: "application/json", data: JsonOutput.toJson([status: "error", msg: "Not enough coins, my child."])
        return
    }
    
    c.coins -= 10
    def msg = "You tithed 10 coins. You feel at peace."
    def won = false
    def reward = ""
    
    // 25% Chance for Reward
    if (Math.random() < 0.25) {
        won = true
        if (!c.inventory) c.inventory = [:]
        
        // 50/50 Chance between Feed or Super Feed
        if (Math.random() < 0.5) {
            c.inventory.feed = (c.inventory.feed ?: 0) + 1
            msg = "Blessed! You received Chicken Feed üåΩ"
            reward = "feed"
        } else {
            c.inventory.super_feed = (c.inventory.super_feed ?: 0) + 1
            msg = "Miracle! You received Super Feed üåü"
            reward = "super"
        }
    }
    
    atomicState["chicken_${uid}"] = c
    touchActivity()
    render contentType: "application/json", data: JsonOutput.toJson([status: "success", msg: msg, coins: c.coins, won: won, reward: reward])
}
def handleHospitalVisit() { checkDaily(params.uid.toInteger(), "hospital"); render contentType: "application/json", data: JsonOutput.toJson([status: "success"]) }

def scheduledDailyQuestion() { postDailyQuestion(false) }

def postDailyQuestion(force) {
    def today = new Date().format("yyyy-MM-dd")
    if (!force && atomicState.lastQuestionDate == today) return
    
    // Default question in case download fails
    def qList = ["What is one thing you are grateful for today?"]
    
    try {
        // 1. Get filename and clean it up (remove spaces)
        def fn = settings.questionFileName ?: "FamilyPulse_Questions.json"
        fn = fn.trim() 
        
        log.debug "Family Pulse: Attempting to download file: '${fn}'"
        
        def content = downloadHubFile(fn)
        if (content) {
            def jsonStr = new String(content, "UTF-8")
            
            // 2. Check if we accidentally got an HTML error page
            if(jsonStr.trim().startsWith("<")) {
                log.error "Family Pulse Error: Downloaded HTML instead of JSON. This usually means the file was not found (404) or Hub Security blocked it. Content Preview: ${jsonStr.take(100)}..."
            } else {
                def questions = new JsonSlurper().parseText(jsonStr)
                if (questions && questions.size() > 0) {
                    qList = questions
                    log.info "Family Pulse: Successfully loaded ${questions.size()} questions."
                }
            }
        } else {
            log.warn "Family Pulse: Download returned no content."
        }
    } catch (e) { 
        log.warn "Family Pulse Read Error: ${e}" 
    }
   
    // 3. Pick and Post
    def rnd = new Random()
    def q = qList[rnd.nextInt(qList.size())]
    addPostToFeed(0, "system", "<b>Question of the Day:</b><br>${q}", "happy")
    atomicState.lastQuestionDate = today
}

def updateDailyScripture() {
    // Use the filename you uploaded
    def fn = "FamilyPulse_Scriptures.json"
    
    // Download and Parse
    def content = downloadHubFile(fn)
    if (content) {
        try {
            def jsonStr = new String(content, "UTF-8")
            def verses = new groovy.json.JsonSlurper().parseText(jsonStr)
            
            if (verses && verses.size() > 0) {
                def rnd = new Random()
                def quote = verses[rnd.nextInt(verses.size())]
                atomicState.dailyScripture = quote
                log.info "Family Pulse: Updated Daily Scripture: ${quote}"
            }
        } catch (e) {
            log.error "Error parsing scripture file: ${e}"
            atomicState.dailyScripture = "Love one another. (File Error)"
        }
    } else {
        atomicState.dailyScripture = "Trust in the Lord. (File Missing)"
    }
}

def scheduledFarmerCheck() { handleFarmerCheck(false) }
def scheduledDogCheck() { handleDogEventLogic(false) }
def handleFarmerCheck(force) {
    def today = new Date().format("yyyy-MM-dd")
    if (!force && atomicState.lastFarmerDate == today) return
    if (force || Math.random() < 0.5) {
        addPostToFeed(0, "event_farmer", "üë®‚Äçüåæ <b>The Farmer</b> is throwing out feed! Quick, grab some!", "excited")
    }
    atomicState.lastFarmerDate = today
}

def handleForceFarmer() { handleFarmerCheck(true); render contentType:"application/json", data:JsonOutput.toJson([status:"success"]) }
def handleForceQuestion() { postDailyQuestion(true); render contentType:"application/json", data:JsonOutput.toJson([status:"success"]) }
def handleForceBirthday() { checkSpecialEvents(true); render contentType:"application/json", data:JsonOutput.toJson([status:"success"]) }

def handleFarmerEat() {
    try {
        def uid = params.uid.toInteger()
        def pid = params.pid 
        def p = atomicState["p_${pid}"]
        if (!p) { render contentType: "application/json", data: JsonOutput.toJson([status: "error", msg: "Post not found"]); return }
        if (!p.eaters) p.eaters = [:]
        if (p.eaters.containsKey(uid.toString())) {
            def prevResult = p.eaters[uid.toString()]
            render contentType: "application/json", data: JsonOutput.toJson([status: "success", won: (prevResult == "won"), already: true])
            return
        }
        def won = false
        if(Math.random() < 0.5) {
            won = true; addChickenXp(uid, 10); adjustCoins(uid, 5)
        }
        p.eaters[uid.toString()] = won ? "won" : "lost"
        atomicState["p_${pid}"] = p
        render contentType: "application/json", data: JsonOutput.toJson([status: "success", won: won, already: false])
    } catch (e) { render contentType: "application/json", data: JsonOutput.toJson([status: "error", msg: "${e}"]) }
}

def handleChickenBattle() {
    def attId=params.uid.toInteger(); def defId=params.target.toInteger(); 
    if(atomicState["isWounded_${attId}"]) {
        render contentType: "application/json", data: JsonOutput.toJson([status: "error", msg: "You are Unconscious!"])
        return
    }
    if(atomicState["isWounded_${defId}"]) {
        render contentType: "application/json", data: JsonOutput.toJson([status: "error", msg: "Target is Unconscious!"])
        return
    }
    
    atomicState["cooldown_${attId}_${defId}"] = new Date().time + 21600000
    def c1=getChickenData(attId); def c2=getChickenData(defId)
    
    // PvP Logic uses processBattleLogic with isPvE=false
    def battleResult = processBattleLogic(c1, c2, false)
    
    if(battleResult.won) {
        c1.xp += 20; c1.coins = (c1.coins ?: 0) + 5; c1.wins++; 
        c2.loss++;
        addNotification(defId, "üíÄ Defeated by ${c1.name}")
    } else {
        c2.wins++; c1.loss++;
        addNotification(attId, "üíÄ Defeated by ${c2.name}")
        atomicState["dailyInitiatedLosses_${attId}"] = (atomicState["dailyInitiatedLosses_${attId}"] ?: 0) + 1
    }
    // RESET HP regardless of result for PVP (simulated arena)
    c1.currentHp = c1.stats.hp
    
    atomicState["chicken_${attId}"]=c1; atomicState["chicken_${defId}"]=c2; 
    checkDaily(attId, "battle")
    touchActivity()
    render contentType: "application/json", data: JsonOutput.toJson([turns:battleResult.turns, maxHp:battleResult.maxHp])
}

def cleanOldPosts() { 
    // We now rely primarily on the hard limit in addPostToFeed
    // But we can do a sanity check on the oldest 5 posts only
    def ids = atomicState.postIDs ?: []
    if (ids.size() == 0) return

    def cutoff = new Date().time - ((settings.retentionDays ?: 7) * 86400000)
    def changed = false

    // Only check the first 5 posts to save resources
    def checkCount = Math.min(ids.size(), 50)
    def toRemove = []

    for(int i=0; i<checkCount; i++) {
        def id = ids[i]
        def p = atomicState["p_${id}"]
        // If post is null (orphan) or old, mark for removal
        if (!p || p.ts < cutoff) {
            toRemove << id
            if (p) atomicState.remove("p_${id}")
        }
    }

    if (toRemove.size() > 0) {
        ids.removeAll(toRemove)
        atomicState.postIDs = ids
    }
}

def resetWeeklyStats() {
    for(int i=1; i<=8; i++) { atomicState["weeklyCount_${i}"] = 0 }
    // Removed the lines that deleted postIDs. 
    // cleanOldPosts() will now handle deletion based on retention settings.
    addPostToFeed(0, "system", "üëë A new week begins!", null)
}

def handleAvatarUpdate() { atomicState["avatar_${params.uid}"] = params.emoji; touchActivity(); render contentType:"application/json", data:JsonOutput.toJson([status:"success"]) }
def handleClearBulletin() { atomicState.bulletin = null; touchActivity(); render contentType:"application/json", data:JsonOutput.toJson([status:"success"]) }

def handleResetCooldowns() { 
    for(int i=1; i<=8; i++) { 
        atomicState.remove("farmCooldown_${i}")
        atomicState.remove("woundedTime_${i}")
        atomicState.remove("dailyEnergy_${i}")
        atomicState.remove("dailyFeeds_${i}")
        atomicState.remove("dailyShots_${i}")
        atomicState.remove("dailyHormones_${i}")
        atomicState.remove("dailySuperFeeds_${i}")
		atomicState.remove("dailyBossLures_${i}")
        atomicState.remove("advTokens_${i}")
        atomicState.remove("advReset_${i}")
        for(int j=1; j<=8; j++) { atomicState.remove("cooldown_${i}_${j}".toString()) } 
    } 
    touchActivity()
    render contentType:"application/json", data:JsonOutput.toJson([status:"success"]) 
}

def handleMoodUpdate() { 
    atomicState["mood_${params.uid}"] = params.mood;
    addPostToFeed(params.uid.toInteger(), "status", "is currently ${params.mood}", params.mood)
    touchActivity();
    render contentType:"application/json", data:JsonOutput.toJson([status:"success"]) 
}

def handlePollVote() {
    def uid = params.uid.toInteger()
    def vote = params.vote.toInteger()
    def p = atomicState.pollData ?: [open:true, votes:[:]]
    if(!p.open) { render contentType: "application/json", data: JsonOutput.toJson([status: "error", msg: "Poll is closed."]); return }
    if(p.votes.containsKey(uid.toString())) { render contentType: "application/json", data: JsonOutput.toJson([status: "error", msg: "You already voted!"]); return }
    p.votes[uid.toString()] = vote
    atomicState.pollData = p
    addChickenXp(uid, 10); adjustCoins(uid, 5)
    touchActivity()
    render contentType: "application/json", data: JsonOutput.toJson([status: "success", xp: 10, coins: 5])
}

def handlePollCloseCmd() {
    def p = atomicState.pollData ?: [open:true, votes:[:]]
    if(p.open) {
        p.open = false
        def counts = [1:0, 2:0, 3:0, 4:0]
        def total = 0
        p.votes.each { uid, vote -> 
            if(counts[vote] == null) counts[vote] = 0
            counts[vote] += 1
            total++
        }
        def q = settings.pollQuestion ?: "Community Poll"
        def html = "<b>üìä Poll Results: ${q}</b><br><br>"
        [1,2,3,4].each { i ->
            def ans = settings["pollAns${i}"]
            if(ans) {
                def c = counts[i]
                def pct = (total > 0) ? Math.round((c / total) * 100) : 0
                html += "<b>${ans}:</b> ${c} votes (${pct}%)<br>"
                html += "<div style='background:#eee; height:8px; width:100%; border-radius:4px; margin-bottom:8px;'><div style='background:#0984e3; height:100%; width:${pct}%; border-radius:4px;'></div></div>"
            }
        }
        html += "<br><i>Total Votes: ${total}</i>"
        addPostToFeed(0, "system", html, "excited")
         atomicState.pollData = p
        touchActivity()
        render contentType: "application/json", data: JsonOutput.toJson([status: "success"])
    } else {
        render contentType: "application/json", data: JsonOutput.toJson([status: "error", msg: "Poll already closed"])
    }
}

preferences {
    page(name: "mainPage")
    page(name: "pageGeneral")
    page(name: "pageFeed")
    page(name: "pageUsers")
    page(name: "pageTools")
    page(name: "pageMaintenance")
}

def mainPage() {
    // Maintenance task on load
    
    dynamicPage(name: "mainPage", title: "Family Pulse Pro Administration", install: true, uninstall: true) {
        section {
            paragraph """<style>
                .fp-header { background: linear-gradient(135deg, #FF6B6B, #FF8E53); padding: 20px; border-radius: 10px; color: white; text-align: center; margin-bottom: 15px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
                .fp-title { font-size: 24px; font-weight: 800; letter-spacing: 1px; }
                .fp-subtitle { font-size: 14px; opacity: 0.9; font-weight: 600; }
                .fp-link-card { background: #f8f9fa; border: 1px solid #ddd; border-radius: 8px; padding: 15px; margin-top: 10px; text-align: center; }
                .fp-link-btn { text-decoration: none; color: white; background: #0984e3; padding: 8px 15px; border-radius: 5px; font-weight: bold; margin: 0 5px; display: inline-block; }
                .fp-link-btn:hover { background: #00cec9; text-decoration: none; color: white; }
                .menu-item { margin-bottom: 5px; }
            </style>
            <div class="fp-header">
                <div class="fp-title">FAMILY PULSE PRO</div>
                <div class="fp-subtitle">Adventure & Social Platform</div>
            </div>"""
        }

        section("Administration Menu") {
            href(name: "toGeneral", page: "pageGeneral", title: "‚öôÔ∏è System & Settings", description: "Hub IDs, Calendars, Timers, Timezones, and Data Retention.", state: "complete")
            href(name: "toFeed", page: "pageFeed", title: "üì¢ Feed & Engagement", description: "Global Announcements, Polls, and Daily Questions.", state: "complete")
            href(name: "toUsers", page: "pageUsers", title: "üë• User Management", description: "Manage Family Members, Passwords, Avatars, and Birthdays.", state: "complete")
            href(name: "toTools", page: "pageTools", title: "üõ†Ô∏è Admin Tools & Cheats", description: "Modify stats, inject coins/XP, heal chickens, and manage levels.", state: "complete")
            href(name: "toMaint", page: "pageMaintenance", title: "‚ö†Ô∏è Maintenance & Triggers", description: "System resets, database cleanup, and forced event triggers.", state: "complete")
        }

        if (state.accessToken) {
            section("Web Portal Access") {
                def token = state.accessToken
                def ip = location.hubs[0].localIP
                def hid = settings.manualHubID ?: location.hub.id
                def cssLink = "fp-style.css?access_token=${state.accessToken}"
                def jsLink = "fp-logic.js?access_token=${state.accessToken}"
                
                paragraph """<div class="fp-link-card">
                    <div style="font-weight:bold; color:#555; margin-bottom:10px;">üö™ Main Login Portal</div>
                    <a href="${mainLocal}" target="_blank" class="fp-link-btn">üè† Local Access</a>
                    <a href="${mainCloud}" target="_blank" class="fp-link-btn">‚òÅÔ∏è Cloud Access</a>
                    <div style="font-size:11px; color:#999; margin-top:10px;">Use these links to access the app on your devices.</div>
                </div>"""
                input "mainDashboardLink", "text", title: "Optional: Dashboard URL", description: "Enter a Hubitat Dashboard URL here to add a quick-link button to the Login Screen."
            }
        }
    }
}

def pageGeneral() {
    dynamicPage(name: "pageGeneral", title: "System Configuration", install: false, uninstall: false) {
        section("üîå Integrations") {
    // Ensure this input is on its own line
    input "manualHubID", "text", title: "Hub ID Override", defaultValue: location.hub.id, description: "Required for cloud links. Default is usually correct."
    
    // Ensure this paragraph is on a new line
             paragraph "<b>Calendar Connection (Optional)</b><br>Enter details to show a Calendar button in the app header."
    
            input "calendarAppId", "text", title: "Calendar App ID", description: "The App ID of your installed Calendar application."
            input "calendarToken", "text", title: "Calendar Access Token", description: "Copy the Access Token from the Calendar App."
        }
        
        section("‚è∞ Timers & Schedules") {
            input "dailyQuestionTime", "number", title: "Daily Question Hour (0-23)", defaultValue: 9, width: 6, description: "Hour to post the automated Question."
            input "birthdayPostTime", "number", title: "Birthday Check Hour (0-23)", defaultValue: 7, width: 6, description: "Hour to check for birthdays."
        }
        
        section("üíæ Data & Files") {
            input "retentionDays", "number", title: "Post Retention (Days)", defaultValue: 7, width: 6, description: "Auto-delete posts older than this."
            input "questionFileName", "text", title: "Question JSON File", defaultValue: "FamilyPulse_Questions.json", width: 6, description: "File in File Manager containing questions."
        }
    }
}

def pageFeed() {
    dynamicPage(name: "pageFeed", title: "Feed & Engagement", install: false, uninstall: false) {
        section("üì¢ Global Announcement") {
            input "newFeatureMsg", "textarea", title: "Pinned Message", description: "Appears in a colored box at the top of every user's feed. Leave blank to hide.", rows: 3
        }
        
        section("üìä Community Poll") {
            input "pollEnabled", "bool", title: "Enable Poll Widget", submitOnChange: true, defaultValue: false
            
            if(settings.pollEnabled) {
                input "pollQuestion", "text", title: "Poll Question", required: true, description: "E.g., What's for dinner?"
                input "pollAns1", "text", title: "Option 1", required: true, width: 6
                input "pollAns2", "text", title: "Option 2", required: true, width: 6
                input "pollAns3", "text", title: "Option 3", required: false, width: 6
                input "pollAns4", "text", title: "Option 4", required: false, width: 6
                
                paragraph "<b>Poll Controls</b>"
                input "btnResetPoll", "button", title: "üîÑ Reset Votes & Open Poll", width: 6
                input "btnClosePoll", "button", title: "üîí Close Poll & Post Results", width: 6
            }
        }
    }
}

def pageUsers() {
    dynamicPage(name: "pageUsers", title: "User Management", install: false, uninstall: false) {
        section {
            paragraph "Enable up to 8 family members. Use 'Timeout' to temporarily block access."
        }
        
        for (int i = 1; i <= 8; i++) {
            section("üë§ User Slot ${i}") {
                input "userEnabled_${i}", "bool", title: "Enable User ${i}", submitOnChange: true
                
                if (settings["userEnabled_${i}"]) {
                    input "userName_${i}", "text", title: "Display Name", width: 4
                    input "userPass_${i}", "password", title: "Password (Optional)", width: 4
                    input "userAvatar_${i}", "text", title: "Avatar Emoji", width: 4, defaultValue: "üòÄ"
                    
                    input "userBirthday_${i}", "text", title: "Birthday (MM-DD)", width: 6
                    input "userTimeOut_${i}", "bool", title: "üö´ Timeout (Block Access)", width: 6
                    
                    input "dashboardUrl_${i}", "text", title: "Personal Dashboard URL", width: 12
                    
                    if(state.accessToken) {
                        def token = state.accessToken
                        def hid = settings.manualHubID ?: location.hub.id
                        def lLink = "http://${location.hubs[0].localIP}:8080/apps/api/${app.id}/feed?access_token=${token}&asUser=${i}"
                        def cLink = "https://cloud.hubitat.com/api/${hid}/apps/${app.id}/feed?access_token=${token}&asUser=${i}"
                        paragraph "<div style='font-size:11px; background:#f0f0f0; padding:5px; border-radius:4px;'>üîó <b>Direct Links:</b> <a href='${lLink}' target='_blank'>Local</a> | <a href='${cLink}' target='_blank'>Cloud</a></div>"
                    }
                }
            }
        }
    }
}

def pageTools() {
    dynamicPage(name: "pageTools", title: "Admin Tools & Cheats", install: false, uninstall: false) {
        section("üéØ Select Target") {
            paragraph "Select a user below, then click a button to perform an action."
            input "adminTarget", "enum", title: "Target User", options: getUserOptions(), submitOnChange: true
        }
        
        if(settings.adminTarget) {
            section("üí∞ Economy & Health") {
                input "btnAdd100Coins", "button", title: "üí∞ Give 100 Coins", width: 6
                input "btnSet0Coins", "button", title: "üí∏ Bankrupt (Set 0 Coins)", width: 6
                input "btnHeal", "button", title: "üöë Revive / Heal Chicken", width: 6
                input "btnResetAdv", "button", title: "‚ö° Refill Energy / Reset Zone", width: 6
            }
            
            section("üìà Level Management") {
                input "btnAddLvl", "button", title: "üîº Level Up (+1)", width: 6
                input "btnSubLvl", "button", title: "üîΩ Level Down (-1)", width: 6
            }
        } else {
            section { paragraph "<i>Please select a target user above to see options.</i>" }
        }
    }
}

def pageMaintenance() {
    dynamicPage(name: "pageMaintenance", title: "Maintenance & Triggers", install: false, uninstall: false) {
        section("‚ö†Ô∏è Danger Zone") {
            paragraph "<b>Warning:</b> These actions affect ALL users and cannot be undone."
            input "btnClearFeed", "button", title: "üóëÔ∏è Clear Entire Feed History", width: 6
            input "btnResetStats", "button", title: "üìä Reset Weekly Leaderboard", width: 6
            input "btnResetChickens", "button", title: "üî• Reset ALL Chickens to Lvl 1", width: 6
            input "btnResetCooldowns", "button", title: "‚è±Ô∏è Clear All Timers", width: 6
            input "btnResetHabits", "button", title: "‚úÖ Reset Daily Habits", width: 12
        }
        
        section("‚ö° Force Event Triggers") {
            paragraph "Manually trigger events that usually happen on a schedule."
            input "btnForceQuestion", "button", title: "‚ùì Post Daily Question", width: 6
            input "btnForceScripture", "button", title: "‚úùÔ∏è Force New Scripture", width: 6
            input "btnForceBirthday", "button", title: "üéÇ Run Birthday Check", width: 6
            input "btnForceFarmer", "button", title: "üë®‚Äçüåæ Force Farmer Feed", width: 4
            input "btnForceDog", "button", title: "üêï Force Dog Chase", width: 4
            input "btnForceWife", "button", title: "üëµ Force Wife Visit", width: 4
        }
    }
}
/**
 * Family Pulse Pro V30 (Modified)
 * Part 4/5
 */

def getUserOptions() {
    def opts = [:]
    for(int i=1; i<=8; i++) {
        if(settings["userEnabled_${i}"]) opts["${i}"] = settings["userName_${i}"] ?: "User ${i}"
    }
    return opts
}

def appButtonHandler(btn) { 
    if(btn=="btnClearFeed") resetWeeklyStats()
    if(btn=="btnResetStats") resetWeeklyStats()
    if(btn=="btnResetChickens") { 
        for(int i=1; i<=8; i++) { 
            def old = atomicState["chicken_${i}"]
            def oldName = old ? old.name : "Eggbert"
            def newC = [name:oldName, level:1, xp:0, xpToNext:100, pts:0, coins:0, stats:[hp:100, atk:10, def:5, crit:5], currentHp:100, wins:0, loss:0, inventory:[feed:0]]
            atomicState["chicken_${i}"] = newC
        } 
    }
    if(btn=="btnResetCooldowns") { handleResetCooldowns() }
    if(btn=="btnResetHabits") { dailyReset() }
    if(btn=="btnResetPoll") { atomicState.pollData = [open: true, votes: [:]] }
    if(btn=="btnClosePoll") { handlePollCloseCmd() }
    
    if(btn=="btnForceQuestion") { postDailyQuestion(true) }
    if(btn=="btnForceScripture") { updateDailyScripture() }
    if(btn=="btnForceFarmer") { handleFarmerCheck(true) }
    if(btn=="btnForceBirthday") { checkSpecialEvents(true) }
	if(btn=="btnForceDog") { handleDogEventLogic(true) }
	if(btn=="btnForceWife") { handleWifeEventLogic(true) }

    if(settings.adminTarget) {
        def uid = settings.adminTarget.toInteger()
        if(btn=="btnAdd100Coins") { adjustCoins(uid, 100); log.info "Admin: Added 100 coins to User ${uid}" }
        if(btn=="btnSet0Coins") { def c = getChickenData(uid); c.coins = 0; atomicState["chicken_${uid}"] = c }
        if(btn=="btnHeal") {
            def c = getChickenData(uid)
            c.currentHp = c.stats.hp 
            atomicState["chicken_${uid}"] = c
            atomicState["isWounded_${uid}"] = false
            atomicState.remove("woundedTime_${uid}")
            atomicState["advLossCount_${uid}"] = 0
        }
        if(btn=="btnResetAdv") {
             atomicState.remove("advTokens_${uid}")
             atomicState.remove("advReset_${uid}")
             atomicState.remove("dailyEnergy_${uid}")
             atomicState["advProgress_${uid}"] = [
                 wilds:0, spooky:0, crazy:0, 
                 boss1:false, boss2:false, boss3:false, bossFarmer:false,
                 boss1Att:false, boss2Att:false, boss3Att:false, bossFarmerAtt:0
             ]
             atomicState.remove("farmerWinTime_${uid}") 
        }
        
        if(btn=="btnAddLvl") {
             def c = getChickenData(uid)
            if(c.level < 10) {
                 c.level++; c.xp = 0; c.xpToNext = (c.xpToNext * 1.5).toInteger(); c.pts += 3
                c.stats.hp += 10; c.currentHp += 10; c.stats.atk += 1; c.stats.def += 1
                atomicState["chicken_${uid}"] = c
            }
        }
        if(btn=="btnSubLvl") {
             def c = getChickenData(uid)
            if(c.level > 1) {
                c.level--; c.xp = 0; c.xpToNext = (c.xpToNext / 1.5).toInteger()
                c.stats.hp = Math.max(10, c.stats.hp - 10); c.currentHp = Math.min(c.currentHp, c.stats.hp)
                c.stats.atk = Math.max(1, c.stats.atk - 1); c.stats.def = Math.max(1, c.stats.def - 1)
                atomicState["chicken_${uid}"] = c
            }
        }
    }
}

def renderLoginScreen() {
    def dashLink = settings.mainDashboardLink ? "<a href='${settings.mainDashboardLink}' class='dash-btn'>üìÖ Family Calendar</a>" : ""
    def token = state.accessToken ?: ""

    // 1. Build CSS separately
    def css = "<style>body{font-family:'Nunito',sans-serif;background:#f4f6f8;display:flex;align-items:center;justify-content:center;height:100vh;margin:0;}"
    css += ".card{background:white;padding:30px;border-radius:20px;box-shadow:0 10px 30px rgba(0,0,0,0.1);text-align:center;width:90%;max-width:400px;}"
    css += ".title{font-size:24px;font-weight:900;background:linear-gradient(135deg, #FF6B6B, #FF8E53);-webkit-background-clip:text;-webkit-text-fill-color:transparent;margin-bottom:0px;}"
    css += ".user-grid{display:grid;grid-template-columns:1fr 1fr;gap:15px; margin-top:20px;}"
    css += ".user-btn{background:#f8f9fa;border:2px solid #eee;border-radius:15px;padding:15px;cursor:pointer;transition:0.2s;display:flex;flex-direction:column;align-items:center;}"
    css += ".user-btn:hover{background:#fff0f0;border-color:#FF6B6B;transform:scale(1.05);}"
    css += ".av{font-size:40px;margin-bottom:5px;line-height:1;}"
    css += ".name{font-weight:bold;color:#555;}"
    css += ".logo-heart { font-size:40px; color:#FF6B6B; margin-bottom:10px; animation: pulseHeart 1.5s infinite; }"
    css += ".dash-btn { display:block; margin-top:20px; text-decoration:none; background:#0984e3; color:white; padding:10px; border-radius:10px; font-weight:bold; }"
    css += ".disabled-user { opacity: 0.5; pointer-events: none; filter: grayscale(100%); background: #ddd; }"
    css += ".modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); backdrop-filter: blur(5px); z-index: 1000; display: none; align-items: center; justify-content: center; }"
    css += ".modal-content { background: white; width: 85%; max-width: 320px; border-radius: 24px; padding: 25px; text-align: center; box-shadow: 0 10px 40px rgba(0,0,0,0.3); position:relative; animation: popIn 0.3s ease-out; }"
    css += ".input-field { width: 100%; padding: 12px; border: 2px solid #eee; border-radius: 12px; font-size: 16px; margin: 15px 0; box-sizing: border-box; outline: none; transition: 0.3s; text-align:center; }"
    css += ".input-field:focus { border-color: #FF6B6B; }"
    css += ".btn { background: linear-gradient(135deg, #FF6B6B, #FF8E53); color: white; border: none; padding: 12px; border-radius: 12px; width: 100%; font-weight: 800; font-size: 14px; cursor: pointer; margin-top: 5px; box-shadow: 0 4px 15px rgba(255, 107, 107, 0.25); }"
    css += ".btn-sec { background: white; color: #555; border: 2px solid #eee; margin-top: 10px; box-shadow: none; }"
    css += "@keyframes pulseHeart { 0% {transform:scale(1);} 50% {transform:scale(1.2);} 100% {transform:scale(1);} }"
    css += "@keyframes popIn { from {opacity:0; transform:scale(0.8);} to {opacity:1; transform:scale(1);} }"
    css += "@keyframes shake { 0%, 100% {transform: translateX(0);} 25% {transform: translateX(-5px);} 75% {transform: translateX(5px);} }"
    css += ".shake { animation: shake 0.3s ease-in-out; }</style>"

    // 2. Build JS separately
    def js = "<script>"
    js += "let pendingUid = 0; let pendingPass = '';"
    js += "function login(uid, hasPass, realPass) {"
    js += "  if(hasPass) { pendingUid = uid; pendingPass = realPass; document.getElementById('passwordModal').style.display = 'flex'; document.getElementById('passInput').value = ''; document.getElementById('passInput').focus(); }"
    js += "  else { window.location.href='feed?access_token=${token}&asUser=' + uid; }"
    js += "}"
    js += "function checkPass() {"
    js += "  let input = document.getElementById('passInput').value;"
    js += "  if(input === pendingPass) { window.location.href='feed?access_token=${token}&asUser=' + pendingUid; }"
    js += "  else { document.getElementById('passwordModal').style.display = 'none'; let err = document.getElementById('errorModal'); err.style.display = 'flex'; err.querySelector('.modal-content').classList.add('shake'); setTimeout(() => err.querySelector('.modal-content').classList.remove('shake'), 500); }"
    js += "}"
    js += "function closeModals() { document.getElementById('passwordModal').style.display = 'none'; document.getElementById('errorModal').style.display = 'none'; }"
    js += "</script>"

    // 3. Build HTML Structure
    def html = "<!DOCTYPE html><html><head><meta charset='UTF-8'><meta name='viewport' content='width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no'><meta name='apple-mobile-web-app-capable' content='yes'><title>Family Pulse Pro Login</title><link rel='stylesheet' href='https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css'>"
    html += css
    html += js
    html += "</head><body><div class='card'><div class='logo-heart'><i class='fa fa-heartbeat'></i></div><div class='title'>Family Pulse Pro</div><div style='font-size:12px; color:#999; font-weight:bold; margin-bottom:20px;'>Feel Your Family's Heartbeat</div><div style='margin-bottom:10px;color:#555;'>Who is this?</div><div class='user-grid'>"

    // 4. Loop for User Buttons
    for(int i=1; i<=8; i++) {
        if(settings["userEnabled_${i}"]) {
            def name = settings["userName_${i}"] ?: "User ${i}"
            def av = atomicState["avatar_${i}"] ?: (settings["userAvatar_${i}"] ?: "üòÄ")
            def isTimeout = settings["userTimeOut_${i}"]
            def rawPass = settings["userPass_${i}"]
            def safePass = rawPass ? rawPass.replace("'", "\\'") : ""
            def hasPass = (safePass != "")

            if (isTimeout) {
                html += "<div class='user-btn disabled-user'><div class='av'>üîí</div><div class='name'>LOCKED</div></div>"
            } else {
                html += "<div class='user-btn' onclick=\"login(${i}, ${hasPass}, '${safePass}')\"><div class='av'>${av}</div><div class='name'>${name}</div></div>"
            }
        }
    }

    // 5. Modals & Closing
    html += "</div>" + dashLink + "</div>"
    
    // Password Modal
    html += "<div id='passwordModal' class='modal'><div class='modal-content'><div style='font-size:40px; margin-bottom:10px;'>üîí</div><h3 style='margin:0; color:#333;'>Enter Password</h3><p style='font-size:12px; color:#999;'>Security Check</p><input type='password' id='passInput' class='input-field' placeholder='****' onkeypress='if(event.key === \"Enter\") checkPass()'><button class='btn' onclick='checkPass()'>Unlock</button><button class='btn btn-sec' onclick='closeModals()'>Cancel</button></div></div>"
    
    // Error Modal
    html += "<div id='errorModal' class='modal'><div class='modal-content' style='border: 2px solid #e74c3c;'><div style='font-size:40px; margin-bottom:10px;'>üö´</div><h3 style='margin:0; color:#e74c3c;'>Access Denied</h3><p style='font-size:12px; color:#555;'>Incorrect Password</p><button class='btn' style='background:#e74c3c; box-shadow:0 4px 15px rgba(231, 76, 60, 0.3);' onclick='document.getElementById(\"errorModal\").style.display=\"none\"; document.getElementById(\"passwordModal\").style.display=\"flex\";'>Try Again</button></div></div>"
    
    html += "</body></html>"

    render contentType: "text/html; charset=utf-8", data: html
}

def renderLogout() {
    def html = """<!DOCTYPE html><html><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><meta name="apple-mobile-web-app-capable" content="yes"><title>Logged Out</title><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"><style>body{font-family:'Nunito', sans-serif;background:#f4f6f8;display:flex;align-items:center;justify-content:center;height:100vh;flex-direction:column; text-align:center;}</style></head><body><div style="font-size:50px; color:#FF6B6B; margin-bottom:10px; animation: pulseHeart 1.5s infinite;"><i class="fa fa-heartbeat"></i></div><h1 style="margin:0; background:linear-gradient(135deg, #FF6B6B, #FF8E53); -webkit-background-clip:text; -webkit-text-fill-color:transparent;">Family Pulse Pro</h1><div style="font-size:14px; color:#999; font-weight:bold; margin-bottom:30px;">Feel Your Family's Heartbeat</div><div style="font-size:60px;margin-bottom:10px;">üêî</div><h2 style="color:#555; margin-top:0;">See ya later!</h2><a href="portal?access_token=${state.accessToken}" style="color:#FF6B6B;font-weight:bold;text-decoration:none;border:2px solid #FF6B6B;padding:10px 20px;border-radius:20px; transition:0.3s;">Login Again</a><style>@keyframes pulseHeart { 0% {transform:scale(1);} 50% {transform:scale(1.2);} 100% {transform:scale(1);} }</style></body></html>"""
    render contentType: "text/html; charset=utf-8", data: html
}
// --- FRONTEND UI ---

def renderFeedShell() {
    try {
        if (params.access_token) state.accessToken = params.access_token
        def token = params.access_token ?: state.accessToken
        if (!token) { render contentType: "text/html", data: "<h1>Missing Token</h1>"; return; }
        if (!params.asUser) { renderLoginScreen(); return; }

        def activeUser = params.asUser.toInteger()
        if (settings["userTimeOut_${activeUser}"]) { 
             render contentType: "text/html", data: "<h1>In Timeout</h1>"
             return
        }

        // --- SECURE LINKS (Works on Cloud & Local) ---
        def cssLink = "fp-style.css?access_token=${state.accessToken}"
        def jsLink = "fp-logic.js?access_token=${state.accessToken}"

        def html = """
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="mobile-web-app-capable" content="yes">
    <title>Family Pulse Pro</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="${cssLink}">
</head>
<body onclick="if(typeof resetTimer === 'function') resetTimer()" onscroll="if(typeof resetTimer === 'function') resetTimer()">
    <script>
        const TOKEN = "${state.accessToken}";
        const UID = ${activeUser};
    </script>
    <div id="toast"></div>
    <div id="bossOverlay" class="boss-overlay"><div class="boss-txt">BOSS DEFEATED</div><button class="btn" onclick="document.getElementById('bossOverlay').style.display='none'">Continue</button></div>
    
    ${getNavBarHtml()}
    <div class="container">
        <div id="feed-container">Loading...</div>
    </div>
    ${getChurchModalHtml()}
    
    <div id="battleModal" class="modal"><div class="modal-content"><div id="battleContent"></div></div></div>
    <div id="farmConfirmModal" class="modal"><div class="modal-content"><h3>Start Farming?</h3><p>Takes 1 hour. No battles allowed while farming.</p><button class="btn" onclick="doFarmConfirm()">Start Farming</button><button class="btn btn-secondary" onclick="document.getElementById('farmConfirmModal').style.display='none'">Cancel</button></div></div>
    <div id="farmModal" class="modal"><div class="modal-content"><div class="farm-scene" id="farmScene1"><div class="farm-chicken">üêî</div><div class="farm-barn">üõñ</div></div><h3>Farming in Progress...</h3><p>Your chicken is working hard.</p><button id="farmManualFinish" class="btn" style="background:#f1c40f; margin-top:10px;" onclick="fetchData()">Check Status</button></div></div>
    <div id="rewardModal" class="modal"><div class="modal-content"><div id="rewardContent"></div><button class="btn" onclick="closeRewardModal()">Awesome!</button></div></div>
    <div id="lossModal" class="modal"><div class="modal-content"><div style="font-size:50px;">‚ò†Ô∏è</div><h2 style="color:#c0392b;">Defeat!</h2><p id="lossMsg">You lost the battle.</p><button class="btn" onclick="document.getElementById('lossModal').style.display='none'">Recover</button></div></div>
    <div id="unconsciousModal" class="modal"><div class="modal-content"><div style="font-size:50px;">üöë</div><h2 style="color:#c0392b;">Unconscious!</h2><p>You cannot fight or farm while unconscious.<br>Visit the Hospital to revive.</p><button class="btn" onclick="openHospital()">Go to Hospital</button><button class="btn btn-secondary" onclick="document.getElementById('unconsciousModal').style.display='none'">Close</button></div></div>
    <div id="welcomeModal" class="modal"><div class="modal-content"><h2 style="color:#2ecc71;">Welcome Back!</h2><div id="welcomeContent"></div><button class="btn" onclick="document.getElementById('welcomeModal').style.display='none'">Let's Go!</button></div></div>
    
    <script src="${jsLink}"></script>
</body>
</html>
"""
        render contentType: "text/html", data: html
    } catch(e) { 
        log.error e
        render contentType:"text/html", data:"Error: ${e}" 
    }
}
/** * Family Pulse Pro V30 (Modified) * Part 5/5 */

def dailyReset() {
    log.info "Performing Family Pulse Daily Reset..."
    
    for(int i=1; i<=8; i++) {
        // 1. Reset Daily Habits & Limits
        atomicState["dailys_${i}"] = [post:false, reply:false, like:false, battle:false, shop:false, login:false, hospital:false, adventure:false, collected:false]
        atomicState.remove("dailyFeeds_${i}")
        atomicState.remove("dailyShots_${i}")
        atomicState.remove("dailyEnergy_${i}")
        atomicState.remove("dailyHormones_${i}")
        atomicState.remove("dailySuperFeeds_${i}")
        atomicState.remove("dailyBossLures_${i}")
        
        // Reset PVP & Adventure Losses (FIXED)
        atomicState.remove("dailyInitiatedLosses_${i}")
        atomicState.remove("advLossCount_${i}") 

        // Reset Farmer Badge (FIXED: Midnight Reset)
        atomicState.remove("isFarmerBadge_${i}")

	    // 2. Reset Loss Counters
        atomicState.remove("dailyInitiatedLosses_${i}")
        atomicState.remove("advLossCount_${i}") 
        atomicState.remove("isFarmerBadge_${i}")

        // 3. Reset Adventure & Boss Progress
        def prog = atomicState["advProgress_${i}"]
        if(prog) {
            // A. Reset Boss Wins & Attempts (The Daily Loop)
            prog.boss1 = false; prog.boss1Att = false       
            prog.boss2 = false; prog.boss2Att = false       
            prog.boss3 = false; prog.boss3Att = false       
            prog.bossFarmer = false; prog.bossFarmerAtt = 0      
            
            [cite_start]// B. RESET ADVENTURE ZONES (Enabled) [cite: 955]
            // This resets the "Wins: 3/3" counters so they can earn the bonus again
            prog.wilds = 0 
            prog.spooky = 0
            prog.crazy = 0
            
            atomicState["advProgress_${i}"] = prog
        }
    }
    
    // Notify the feed
    addPostToFeed(0, "system", "‚òÄÔ∏è <b>A new day has dawned!</b> Dailys, Shop Limits, and Bosses have reset.", "happy")
    
    // Save the date so we know the reset happened today
    atomicState.lastDailyResetDate = new Date().format("yyyy-MM-dd")
}

def checkSpecialEvents(force) {
    def cal = Calendar.getInstance()
    cal.setTime(new Date())
    def month = cal.get(Calendar.MONTH) + 1
    def day = cal.get(Calendar.DAY_OF_MONTH)
    def today = new Date().format("yyyy-MM-dd")
    
    // Prevent multiple checks per day unless forced
    if (!force && atomicState.lastEventCheck == today) return
    
    // Check Birthdays
    for(int i=1; i<=8; i++) {
        if(settings["userEnabled_${i}"]) {
            def bdayStr = settings["userBirthday_${i}"]
            if (bdayStr) {
                def parts = bdayStr.split("-")
                if (parts.length == 2 && parts[0].toInteger() == month && parts[1].toInteger() == day) {
                    def name = settings["userName_${i}"] ?: "User ${i}"
                    addPostToFeed(0, "system", "üéÇ <b>HAPPY BIRTHDAY ${name}!</b> Everyone wish them a great day! (Check feed for bonus)", "excited")
                }
            }
        }
    }
    atomicState.lastEventCheck = today
}

def downloadHubFile(String fileName) {
    try {
        // Encode spaces in filename just in case
        def cleanName = fileName.replace(" ", "%20")
        
        def params = [
            uri: "http://127.0.0.1:8080",
            path: "/local/${cleanName}",
            contentType: "text/plain",
            textParser: true,
            headers: [
                "Cookie": "", 
                "Accept": "text/plain"
            ]
        ]
        
        def result = null
        
        httpGet(params) { resp ->
            if(resp.success) {
                // --- THE FIX IS HERE ---
                // Use .getText() instead of .toString() to read the StringReader
                def data = resp.data.getText() 
                // -----------------------

                // SMART CLEANER: Find the start of the JSON list
                def startIndex = data.indexOf("[")
                
                if (startIndex > -1) {
                    def cleanData = data.substring(startIndex)
                    result = cleanData.getBytes("UTF-8")
                } 
                else if(data.trim().startsWith("<") || data.contains("login")) {
                    log.error "Family Pulse: BLOCKED. Hub returned HTML/Login page for '${fileName}'."
                } 
                else {
                    log.warn "Family Pulse: File '${fileName}' loaded but contained no JSON brackets [ ]. Content: ${data.take(50)}..."
                }
            } else {
                log.warn "Family Pulse: File '${fileName}' not found (Status: ${resp.status})"
            }
        }
        return result
    } catch (e) {
        if (e.message.contains("404")) {
            log.warn "Family Pulse: File '${fileName}' does not exist in File Manager. Please check capitalization exactly."
        } else {
            log.error "Family Pulse: File System Error - ${e}"
        }
        return null
    }
}
    def handleSportEvent() {
    def uid = params.uid.toInteger()
    def type = params.eventType // 'start', 'finish', or 'trophy'
    def mood = params.mood
    
    // Reward Defaults
    def xp = 0
    def coins = 0
    def title = "Sports Update"
    def sub = "Activity Shared"
    def notifMsg = "" 
    
    // 1. Calculate Rewards based on Tier
    if (type == "start") {
        xp = 10; coins = 10
        title = "Event Started!"
        sub = "Game On! (+10 XP / +10 Coins)"
        notifMsg = "üèÖ Started Event: +10 XP & +10 Coins"
    } 
    else if (type == "finish") {
        xp = 25; coins = 25
        title = "Event Finished!"
        sub = "Victory Lap! (+25 XP / +25 Coins)"
        notifMsg = "üèÅ Finished Event: +25 XP & +25 Coins"
    } 
    else if (type == "trophy") {
        xp = 5; coins = 5
        title = "Trophy Earned!"
        sub = "Shiny! (+5 XP / +5 Coins)"
        notifMsg = "üèÜ Trophy Earned: +5 XP & +5 Coins"
    } 

    // 2. Apply Changes
    if (mood) atomicState["mood_${uid}"] = mood
    incrementWeeklyCount(uid)
    if (xp > 0) addChickenXp(uid, xp)
    if (coins > 0) adjustCoins(uid, coins)
    
    // 3. Create Feed Post
    addPostToFeed(uid, "status", params.msg, mood)
    
    // 4. OFFLINE BACKUP: Save this notification to the database.
    // If the user's phone dies right now, they will see this message 
    // in the "Welcome Back" modal the next time they log in.
    addNotification(uid, notifMsg)
    
    checkDaily(uid, "post")
    
       
    // 5. ONLINE RESPONSE: Send data back for the immediate popup
    render contentType: "application/json", data: groovy.json.JsonOutput.toJson([
        status: "success", 
        xp: xp, 
        coins: coins,
        title: title,
        sub: sub
    ])
}

def handleDogEventLogic(force) {
    // 50% chance to happen when the weekly schedule triggers, unless forced by Admin
    if (!force && Math.random() < 0.5) return 

    def users = getUsersList()
    if (!users) { log.warn "Dog Event: No users found."; return }

    // FILTER: Only pick victims who are NOT wounded
    def validVictims = users.findAll { !atomicState["isWounded_${it.id}"] }

    if (validVictims.size() == 0) {
        log.warn "Dog Event: All chickens are unconscious! The dog wanders home."
        return
    }

    // Pick a random VALID victim
    def victim = validVictims[new Random().nextInt(validVictims.size())]
    def uid = victim.id
    def c = getChickenData(uid)
    def cName = c.name ?: "Unknown Chicken"
    
    def rnd = Math.random()
    
    if (rnd < 0.50) {
        // BAD ENDING: CHASED (Lose Coins)
        def lostCoins = 25
        if ((c.coins ?: 0) >= lostCoins) {
            adjustCoins(uid, -lostCoins)
            addPostToFeed(0, "system", "üêï <b>WOOF!</b> The Farmer's Dog chased <b>${cName}</b>! They dropped <b>${lostCoins} coins</b>!", "surprised")
            addNotification(uid, "üêï The Farmer's Dog chased you! You dropped ${lostCoins} coins.")
        } else {
             // If they have 0 coins, just a chase message
             addPostToFeed(0, "system", "üêï <b>ZOOM!</b> The Farmer's Dog chased <b>${cName}</b> around the barn!", "tired")
        }
    } 
    else {
        // GOOD ENDING: PLAY (Gain XP)
        addChickenXp(uid, 40)
        addPostToFeed(0, "system", "üêï <b>GOOD BOY!</b> <b>${cName}</b> played fetch with the Farmer's Dog! (<b>+40 XP</b>)", "happy")
        addNotification(uid, "ü¶¥ You played with the Farmer's Dog! +40 XP")
    }
}

def scheduledWifeCheck() { handleWifeEventLogic(false) }
def handleWifeEvent() { handleWifeEventLogic(true); render contentType:"application/json", data:groovy.json.JsonOutput.toJson([status:"success"]) }

def handleWifeEventLogic(force) {
    // 5% chance to happen daily unless forced
    if (!force && Math.random() > 0.05) return 

    // 1. Get list of active chickens
    def users = getUsersList()
    def valid = users.findAll { !atomicState["isWounded_${it.id}"] } // She only visits healthy chickens
    
    if (!valid) { log.warn "Wife Event: No valid users."; return }

    // 2. Pick 1 Random Winner
    def winner = valid[new Random().nextInt(valid.size())]
    def uid = winner.id
    def c = getChickenData(uid)
    def cName = c.name ?: "Unknown Chicken"
    
    // 3. Determine Reward (80% Feed, 20% Super Feed)
    def rnd = Math.random()
    def item = ""
    
    // Initialize inventory if missing
    if (!c.inventory) c.inventory = [feed:0]
    
    if (rnd < 0.80) {
        // Reward: Chicken Feed
        c.inventory.feed = (c.inventory.feed ?: 0) + 1
        item = "Chicken Feed üåΩ"
    } else {
        // Reward: Super Feed
        c.inventory.super_feed = (c.inventory.super_feed ?: 0) + 1
        item = "Super Feed üåü"
    }
    
       // 4. Save & Post
    atomicState["chicken_${uid}"] = c // [cite: 1009]
    
       // Ensure cName and item are defined earlier in your function
    addPostToFeed(0, "system", "üëµ <b>The Farmer's Wife</b> stopped by! " +
        "She thought <b>${cName}</b> looked skinny and gave them <b>${item}</b>!", "happy") // [cite: 1010]
        
    addNotification(uid, "üëµ The Farmer's Wife gave you ${item}!") // [cite: 1010]
}      // This brace closes the handleWifeEventLogic function [cite: 1010]

def getNavBarHtml() {
    return """
    <div class="nav-bar">
        <div class="nav-item" onclick="playSound('click'); openShop()"><i class="fa fa-store" style="color:#00b894;"></i> Shop</div>
        <div class="nav-item" onclick="playSound('click'); openAdventure()"><i class="fa fa-dungeon" style="color:#9b59b6;"></i> Adventure</div>
        <div class="nav-item" onclick="playSound('click'); openForaging()"><i class="fa fa-leaf" style="color:#2ecc71;"></i> Forage</div>
        <div class="nav-item" onclick="playSound('click'); openCoop()"><i class="fa fa-egg" style="color:#e67e22;"></i> Coop</div>
        <div class="nav-item" onclick="playSound('click'); openHospital()"><i class="fa fa-ambulance" style="color:#e74c3c;"></i> Hospital</div>
        <div class="nav-item" onclick="playSound('click'); openChurch()"><i class="fa fa-church" style="color:#3498db;"></i> Church</div>
    </div>
    """
}

def getChurchModalHtml() {
    return """
    <div id="churchModal" class="modal" onclick="closeModal()"><div class="modal-content" onclick="event.stopPropagation()">
        <div class="modal-help-btn" onclick="openChurchHelp()">?</div>
        <div style="font-size:60px; margin-bottom:10px;">‚õ™</div>
        <h2 style="margin:0; color:#3498db;">The Church</h2>
        
        <div style="margin-bottom:15px;">
            <span style="background:#3498db; color:white; padding:4px 10px; border-radius:15px; font-size:12px; font-weight:bold;">
                üí∞ <span id="churchCoins">0</span> Coins
            </span>
        </div>
        
        <div style="background:#f4f6f8; padding:15px; border-radius:12px; margin:15px 0; border-left:4px solid #3498db; text-align:left;">
            <p id="churchQuoteText" style="font-style:italic; font-weight:bold; color:#555; font-size:14px; margin:0;">Loading...</p>
        </div>
        
        <button class="btn" style="background:#f1c40f; color:#2d3436; margin-bottom:5px; box-shadow:0 4px 10px rgba(241, 196, 15, 0.4);" onclick="tithe()">ü§≤ Tithe (10 Coins)</button>
        <div style="font-size:10px; color:#999; margin-bottom:15px;">"Generosity brings unexpected blessings."</div>

        <button class="btn" style="background:#3498db;" onclick="closeModal()">Amen</button>
    </div></div>
    """
}

// --- PROXY FILE SERVERS (Must be at the very bottom, OUTSIDE other functions) ---

def serveCss() {
    def content = readLocalFile("FamilyPulse_Style.css")
    render contentType: "text/css", data: content
}

def serveJs() {
    def content = readLocalFile("FamilyPulse_Logic.js")
    render contentType: "application/javascript", data: content
}

def readLocalFile(filename) {
    def result = "/* File Read Error: ${filename} */"
    try {
        def cleanName = filename.replace(" ", "%20")
        
        def params = [
            uri: "http://127.0.0.1:8080",
            path: "/local/${cleanName}",
            contentType: "text/plain",
            textParser: true,
            headers: ["Cookie": "", "Accept": "text/plain"]
        ]
        
        httpGet(params) { resp ->
            if(resp.success) {
                def data = resp.data.getText()
                if(data.trim().startsWith("<") || data.contains("login")) {
                     log.error "Family Pulse: BLOCKED by Hub Security. Please enable 'Allow Local Access' in Hub Settings."
                     result = "// ERROR: Hub Security is blocking this file. Go to Settings -> Hub Login Security -> Check 'Allow local network access'."
                } else {
                    result = data
                }
            }
        }
    } catch (e) {
        log.error "Error reading local file ${filename}: ${e}"
    }
    return result
}